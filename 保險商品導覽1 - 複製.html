<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—å±±äººå£½ - ä¿éšªå•†å“åˆ†é¡å°è¦½</title>
    <style>
        /* --- CSS è®Šæ•¸å®šç¾© (é¡è‰²ç®¡ç†) --- */
        :root {
            --level-0-bg: #28a745;
            --level-0-text: #ffffff;
            --level-1-text: #007bff;
            --level-2-text: #654321;
            --level-3-text: #E65100;
            --level-4-text: #8E44AD; /* æ–°å¢ç¬¬äº”å±¤é¡è‰²è®Šæ•¸ */
            --product-text: #333333;
        }

        /* --- å…¨å±€æ¨£å¼ --- */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2, h4 { color: #005a9c; }
        h1 { margin-top: 0; margin-bottom: 0; } /* èª¿æ•´h1é‚Šè·ä»¥å°é½ŠæŒ‰éˆ• */
        h2 { margin: 0; }
        h4 { margin-top: 0; border-bottom: 1px solid #e9ecef; padding-bottom: 8px; }
        h5 { margin: 0; font-size: 1.1em; }
        button { cursor: pointer; border: none; border-radius: 5px; color: #fff; padding: 8px 12px; font-size: 0.9em; transition: background-color 0.2s, color 0.2s; }
        input, select { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: inherit; font-size: 0.95em; }

        /* --- çµ±ä¸€æŒ‰éˆ•æ‡¸åœæ•ˆæœ --- */
        #open-management-modal-btn:hover,
        #open-suggested-modal-btn:hover,
        #add-main-category-btn:hover,
        .category-list-item .btn-edit:hover,
        .category-list-item .btn-delete:hover,
        #save-html-btn:hover,
        #print-btn:hover,
        #print-suggested-view-btn:hover, /* ã€æ–°å¢ã€‘å»ºè­°æ›¸åˆ—å°æŒ‰éˆ• */
        .filter-btn:hover,
        #modal-save-btn:hover,
        #modal-cancel-btn:hover,
        #modal-back-btn:hover,
        .btn-add-sub:hover,
        .btn-delete-sub:hover,
        .back-button:hover,
        #go-to-admin-view-btn:hover,
        #go-to-circle-view-btn:hover,
        #go-to-suggested-view-btn:hover, /* ã€æ–°å¢ã€‘ */
        #go-back-to-main-menu-btn:hover /* ã€æ–°å¢ã€‘ */
         {
            background-color: #dc3545; /* ç´…è‰² */
            color: #ffffff; /* ç™½è‰² */
        }

        /* ---
        --- æ–°å¢ï¼šé é¢è¦–åœ–ç®¡ç† (From å•†å“å»ºè­°æ›¸é¦–é 4.html)
        --- */
        .page-view {
            display: none; /* é è¨­æ‰€æœ‰é é¢éš±è— */
            width: 100%;
            animation: fadeIn 0.5s ease; /* é è¨­å‹•ç•«æ™‚é–“ 0.5 ç§’ */
        }
        .page-view.active {
            display: block; /* åªé¡¯ç¤ºç•¶å‰çš„é é¢ */
        }

        /* ---
        --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘
        --- 1. è¨­å®šç¬¬ä¸‰å±¤é¸å–® (#product-list-view) å‹•ç•«æ™‚é–“ç‚º 2.0 ç§’
        --- 2. èª¿æ•´é é¢åˆ‡æ›å‹•ç•«ç‚ºå–®ç´”æ·¡å…¥
        --- */
        #product-list-view,
        #suggested-product-list-view /* ã€æ–°å¢ã€‘å»ºè­°æ›¸çš„åˆ—è¡¨ä¹Ÿå¥—ç”¨ç›¸åŒå‹•ç•« */
         {
            animation-duration: 2.0s; /* è¦†è“‹é è¨­çš„ 0.5s */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ---
        --- æ–°å¢ï¼šæ¨™é¡Œèˆ‡è¿”å›æŒ‰éˆ• (From å•†å“å»ºè­°æ›¸é¦–é 4.html)
        --- */
        .page-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #005a9c;
            padding-bottom: 15px;
            flex-wrap: wrap; /* æ›è¡Œ */
        }
        .page-header h1 {
            color: #005a9c;
            margin: 0;
            font-size: 2.2em;
            flex-grow: 1; /* è®“æ¨™é¡Œä½”æ“šå¤šé¤˜ç©ºé–“ */
        }
        .back-button, #go-to-admin-view-btn, #go-to-circle-view-btn,
        #go-to-suggested-view-btn, #go-back-to-main-menu-btn,
        #print-suggested-view-btn /* ã€æ–°å¢ã€‘ */
        {
            background-color: #6c757d;
            color: white;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•ç¸®å° */
        }
        #go-to-admin-view-btn { background-color: #005a9c; }
        #go-to-circle-view-btn { background-color: #007bff; }
        #go-to-suggested-view-btn { background-color: #28a745; } /* ã€æ–°å¢ã€‘å»ºè­°æ›¸æŒ‰éˆ•(ç¶ è‰²) */
        #print-suggested-view-btn { background-color: #17a2b8; } /* ã€æ–°å¢ã€‘åˆ—å°æŒ‰éˆ•(é’è‰²) */


        /* ---
        --- æ–°å¢ï¼šåœ“åœˆé¸å–®æ¨£å¼ (From å•†å“å»ºè­°æ›¸é¦–é 4.html)
        --- */
        .circle-menu-container {
            position: relative;
            width: 800px;
            height: 800px;
            margin: 50px auto;
            padding: 0;
        }
        .circle-positioner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            margin: -100px 0 0 -100px;
        }
        .menu-circle {
            width: 100%;
            height: 100%;
            background-image: linear-gradient(145deg, #0052D4, #4364F7, #6FB1FC);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 82, 212, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease, background-image 0.3s ease, box-shadow 0.3s ease;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
        }
        .menu-circle:hover {
            transform: scale(1.2);
            background-image: linear-gradient(145deg, #D32F2F, #E53935, #F44336);
            color: #ffffff;
            box-shadow: 0 15px 30px rgba(229, 57, 53, 0.4);
        }
        .menu-circle-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            max-width: 100%;
        }
        .menu-circle-name {
            font-size: 24px;
            font-weight: 600;
            line-height: 1.4;
            word-wrap: break-word;
        }
        a.menu-circle-link {
            display: inline-block;
            background-color: #ffffff;
            color: #006400;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            padding: 5px 12px;
            border-radius: 15px;
            text-decoration: none;
            transition: all 0.2s ease;
            max-width: 90%;
            box-sizing: border-box;
            word-wrap: break-word;
        }
        a.menu-circle-link:hover {
            background-color: #006400;
            color: #ffffff;
            transform: scale(1.05);
        }
        /* --- åœ“åœˆé¸å–® CSS çµæŸ --- */


        /* ---
        --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ï¼šä¿®æ”¹ã€Œå»ºè­°æ›¸å•†å“ç¸½è¦½ã€æ¡†æ¶æ¨£å¼
        --- */
        .suggested-summary-container {
            display: none; /* é è¨­éš±è— */
            margin-top: 50px;
            padding: 20px;
            background-color: #f8f9fa; /* æ·¡ç°è‰²èƒŒæ™¯ */
            border: 1px solid #dee2e6; /* æ·ºç°è‰²é‚Šæ¡† */
            border-radius: 8px;
        }
        .suggested-summary-container h4 {
            color: #005a9c; /* è—è‰²æ¨™é¡Œ */
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #ced4da;
            padding-bottom: 10px;
            font-size: 1.2em;
        }
        .suggested-summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
         /* ä¿®æ”¹é …ç›®æ¨£å¼ä»¥å®¹ç´é€£çµ */
        .suggested-summary-item {
            padding: 10px 0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 0.95em;
        }
        .suggested-summary-item:last-child {
            border-bottom: none;
        }
        /* æ–°å¢é€£çµæ¨£å¼ */
        .summary-product-name {
            font-weight: bold;
            color: #333;
            margin-right: 15px; /* èˆ‡é€£çµé–“éš” */
        }
        .summary-link {
            font-size: 0.9em;
            color: #007bff; /* è—è‰²é€£çµ */
            text-decoration: none;
            margin-right: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .summary-link:hover {
            background-color: #007bff;
            color: white;
            text-decoration: none;
        }
        /* --- å»ºè­°æ›¸å•†å“åˆ—è¡¨æ¨£å¼çµæŸ --- */


        /* ---
        --- æ–°å¢ï¼šåœ“åœˆé¸å–®è¼‰å…¥å‹•ç•« (ä»¿ Untitled-1.html)
        --- */
        @keyframes circle-pop-in {
            from { opacity: 0; transform: scale(0.5); }
            to   { opacity: 1; transform: scale(1); }
        }

        /* å¥—ç”¨åˆ°ä¸»é¸å–® (L1) å’Œå­é¸å–® (L2) çš„åœ“åœˆ */
        #main-menu-container .menu-circle,
        #sub-menu-container .menu-circle,
        #suggested-main-menu-container .menu-circle, /* ã€æ–°å¢ã€‘ */
        #suggested-sub-menu-container .menu-circle /* ã€æ–°å¢ã€‘ */
        {
            opacity: 0; /* å‹•ç•«å‰éš±è— */
            animation: circle-pop-in 0.5s ease-out forwards; /* æ‡‰ç”¨å‹•ç•« */
        }

        /* L1 ä¾åºå‡ºç¾çš„å»¶é² (ä½¿ç”¨ .circle-positioner ä¾†å®šä½ :nth-child) */
        #main-menu-container .circle-positioner:nth-child(1) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(1) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.2s; }
        #main-menu-container .circle-positioner:nth-child(2) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(2) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.3s; }
        #main-menu-container .circle-positioner:nth-child(3) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(3) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.4s; }
        #main-menu-container .circle-positioner:nth-child(4) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(4) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.5s; }
        #main-menu-container .circle-positioner:nth-child(5) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(5) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.6s; }
        #main-menu-container .circle-positioner:nth-child(6) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(6) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.7s; }
        #main-menu-container .circle-positioner:nth-child(7) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(7) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.8s; }
        #main-menu-container .circle-positioner:nth-child(8) .menu-circle,
        #suggested-main-menu-container .circle-positioner:nth-child(8) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.9s; }


        /* L2 ä¾åºå‡ºç¾çš„å»¶é² (ä½¿ç”¨ .circle-positioner ä¾†å®šä½ :nth-child) */
        #sub-menu-container .circle-positioner:nth-child(1) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(1) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.2s; }
        #sub-menu-container .circle-positioner:nth-child(2) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(2) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.3s; }
        #sub-menu-container .circle-positioner:nth-child(3) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(3) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.4s; }
        #sub-menu-container .circle-positioner:nth-child(4) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(4) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.5s; }
        #sub-menu-container .circle-positioner:nth-child(5) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(5) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.6s; }
        #sub-menu-container .circle-positioner:nth-child(6) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(6) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.7s; }
        #sub-menu-container .circle-positioner:nth-child(7) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(7) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.8s; }
        #sub-menu-container .circle-positioner:nth-child(8) .menu-circle,
        #suggested-sub-menu-container .circle-positioner:nth-child(8) .menu-circle /* ã€æ–°å¢ã€‘ */
        { animation-delay: 0.9s; }
        /* --- åœ“åœˆå‹•ç•«çµæŸ --- */


        /* ---
        --- ä»¥ä¸‹ç‚ºã€ŒåŸç‰ˆæª”æ¡ˆã€çš„ CSS (ä¿æŒä¸è®Š)
        --- */

        /* --- ä¸»ç·¨è¼¯æŒ‰éˆ• --- */
        .main-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}

        /* --- ã€æ–°å¢ã€‘æ¨™é¡Œèˆ‡è¿”å›æŒ‰éˆ•çš„å®¹å™¨ --- */
        .title-and-back-button-container {
            display: flex;
            align-items: center; /* å‚ç›´ç½®ä¸­å°é½Š */
            gap: 15px; /* æŒ‰éˆ•å’Œæ¨™é¡Œä¹‹é–“çš„é–“è· */
            flex-wrap: wrap;
        }

        /* --- ã€æ–°å¢ã€‘è¿”å›ä¸»å…¥å£æŒ‰éˆ•æ¨£å¼ --- */
        .back-to-main-btn {
            display: inline-block;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            background-color: #007bff; /* ä¸»é¡Œè—è‰² */
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .back-to-main-btn:hover {
            background-color: #0056b3; /* æ»‘é¼ æ‡¸åœæ™‚åŠ æ·±é¡è‰² */
        }

        .main-controls-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        #open-management-modal-btn { background-color: #005a9c; font-size: 1.1em; padding: 12px 20px; }
        #open-suggested-modal-btn { background-color: #007bff; font-size: 1.1em; padding: 12px 20px; }
        #save-html-btn { background-color: #17a2b8; font-size: 1.1em; padding: 12px 20px; }
        #print-btn { background-color: #6c757d; font-size: 1.1em; padding: 12px 20px; }

        /* --- ä¸»åˆ†é¡ç®¡ç†å€ (Modalå…§) --- */
        #category-manager { margin-top: 25px; }
        .manager-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #add-main-category-btn { background-color: #28a745; }
        .category-list-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #e9ecef; }
        .category-list-item:nth-child(even) { background-color: #f8f9fa; }
        .category-name-span { flex-grow: 1; font-weight: bold; }
        .category-list-item .btn-edit { background-color: #007bff; }
        .category-list-item .btn-delete { background-color: #dc3545; margin-left: 8px; }

        /* --- é¡è‰²ç®¡ç†é¸å–® --- */
        #color-manager { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; }
        .color-pickers-container { display: flex; flex-wrap: wrap; gap: 15px; }
        .color-picker-group { display: flex; align-items: center; gap: 8px; }
        .color-picker-group label { font-size: 0.9em; }
        input[type="color"] { width: 40px; height: 25px; border: 1px solid #ccc; padding: 2px; border-radius: 4px; cursor: pointer; }

        /* --- ç•«é¢é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ• --- */
        .view-controls { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .view-controls-left { display: flex; align-items: center; gap: 20px; }
        .view-controls .buttons-right { display: flex; gap: 20px; align-items: flex-end; }
        .filter-btn { background-color: #17a2b8; font-size: 0.95em; padding: 10px 15px; border: 2px solid transparent; }
        #toggle-all-btn { width: auto; }

        /* --- å•Ÿç”¨ä¸­æŒ‰éˆ•æ¨£å¼ --- */
        .filter-btn.active-filter, .filter-btn.active-filter:hover {
            background-color: orange;
            color: red;
            font-weight: bold;
            border: 2px solid red;
        }

        /* è¨ˆæ•¸å™¨æ¨£å¼ */
        .filter-button-wrapper { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .product-count-badge {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 5px;
            min-height: 1.2em;
        }

        /* --- å½ˆå‡ºå¼ç·¨è¼¯è¦–çª— (Modal) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px 30px; border: 1px solid #888; width: 85%; max-width: 900px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: #005a9c; display: flex; align-items: center;}
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; }
        #modal-form-container, #suggested-product-list-container { max-height: 60vh; overflow-y: auto; padding-right: 15px; }
        .modal-footer { margin-top: 20px; text-align: right; border-top: 1px solid #dee2e6; padding-top: 15px; }
        #modal-save-btn, #suggested-save-btn { background-color: #28a745; }
        #modal-cancel-btn, #modal-back-btn, #suggested-cancel-btn { background-color: #6c757d; margin-left: 10px; }

        .header-count-badge {
            font-size: 0.7em;
            font-weight: bold;
            color: #ffffff;
            margin-left: 15px;
            background-color: #28a745;
            padding: 4px 10px;
            border-radius: 12px;
            vertical-align: middle;
        }

        /* --- å…¨éƒ¨å–æ¶ˆå‹¾é¸æŒ‰éˆ•æ¨£å¼ --- */
        .deselect-btn {
            background-color: #6c757d;
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 15px;
            vertical-align: middle;
        }
        .deselect-btn:hover {
            background-color: #dc3545 !important;
            color: #ffffff !important;
        }

        .modal-view { display: none; }
        .modal-view.active { display: block; }

        .category-form-group { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; flex-wrap: wrap; }
        .category-form-group .type-select { flex-basis: 90px; }
        .category-form-group .name-input { flex: 1 1 180px; }
        .category-form-group .status-select { flex-basis: 100px; }
        .category-form-group .btn-action { font-size: 1.2em; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; padding: 0; flex-shrink: 0; }
        .btn-add-sub { background-color: #17a2b8; }
        .btn-delete-sub { background-color: #ffc107; }
        .nested-group { margin-left: 30px; padding-left: 15px; border-left: 2px dashed #e0e0e0; }

        .product-links-container { width: 100%; box-sizing: border-box; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin-top: 8px; }
        .link-group { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; flex-grow: 1; min-width: 300px; }
        .link-group input { width: 100%; box-sizing: border-box; }
        .product-links-container .link-group { margin-bottom: 8px; }
        .product-links-container .link-group:last-child { margin-bottom: 0; }
        .discontinued-date-input { margin-left: 8px; flex-basis: 150px; }

        /* --- æ¨¹ç‹€çµæ§‹ --- */
        .product-tree { list-style: none; padding-left: 0; margin: 0; }
        .tree-node { padding-left: 20px; border-left: 1px dashed #ced4da; }
        .category > .category-title { cursor: pointer; font-size: 1.2em; font-weight: bold; color: #005a9c; padding: 8px 0; display: flex; align-items: center; flex-wrap: wrap; }
        .toggle-icon { display: inline-block; width: 20px; text-align: center; font-weight: bold; color: #007bff; transition: transform 0.2s ease-in-out; }
        .category.collapsed > .category-title > .toggle-icon { transform: rotate(-90deg); }
        .children-container { padding-left: 20px; max-height: 2000px; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .category.collapsed > .children-container { max-height: 0; }

        a.link-icon-button { font-size: 1em; color: #007bff; text-decoration: none; margin-left: 8px; padding: 2px 5px; border-radius: 4px; transition: all 0.2s ease-in-out; }
        a.link-icon-button:hover { transform: scale(1.2); background-color: #e9ecef; color: #0056b3; }

        /* --- å•†å“æ¨£å¼ --- */
        .product-item { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; margin: 8px 0; padding: 10px 15px; font-size: 0.95em; }
        .product-name { font-weight: bold; color: var(--product-text); }
        .product-status { display: inline-block; margin-left: 10px; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #fff; }
        .product-status.active { background-color: #28a745; }
        .product-status.discontinued { background-color: #dc3545; }
        .product-status.suggested { background-color: #007bff; }
        .product-links { margin-left: 15px; font-size: 0.9em; }
        .product-links a { color: #0056b3; text-decoration: none; }
        .product-links a:hover { text-decoration: underline; }

        .link-wrapper:not(:last-of-type)::after {
            content: 'ï¼Œ';
            margin-right: 0.5em;
            color: #333;
        }

        /* --- å»ºè­°å•†å“è¨­å®š Modal çš„å°ˆå±¬æ¨£å¼ --- */
        #suggested-product-list-container h5 { color: #005a9c; border-bottom: 1px solid #e9ecef; padding-bottom: 5px; margin: 15px 0 10px 0; }
        #suggested-product-list-container label {
            display: block;
            padding: 8px 12px;
            margin: 4px 0;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #suggested-product-list-container label:hover { background-color: #e9ecef; }
        #suggested-product-list-container input[type="checkbox"] { margin-right: 10px; transform: scale(1.1); }

        /* --- åˆ†é¡éšå±¤é¡è‰²ç®¡ç† (ä½¿ç”¨CSSè®Šæ•¸) --- */
        .category-title.level-0 > .category-name {
            background-color: var(--level-0-bg);
            color: var(--level-0-text);
            padding: 4px 10px;
            border-radius: 5px;
        }
        .category-title.level-1 > .category-name { color: var(--level-1-text); }
        .category-title.level-1 { font-size: 1.1em; }

        .category-title.level-2 > .category-name { color: var(--level-2-text); }
        .category-title.level-2 { font-size: 1.05em; }

        .category-title.level-3 > .category-name { color: var(--level-3-text); }
        .category-title.level-3 { font-size: 1em; }

        .category-title.level-4 > .category-name,
        .category-title.level-5 > .category-name { color: var(--level-4-text); }


        /* ---
        --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ ä¾æ‚¨çš„éœ€æ±‚ï¼Œæ–°å¢çš„åˆ—å°æ¨™é¡Œæ¨£å¼
        --- */
        .print-only-suggested-title {
            display: none; /* é è¨­åœ¨è¢å¹•ä¸Šéš±è— */
            text-align: center;
            color: #000000;
            font-size: 2em;
            margin-bottom: 20px;
            font-weight: bold;
        }

        /* ---
        --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ–°å¢ï¼šå»ºè­°æ›¸å°è¦½å°ˆç”¨åˆ—å°æ¨£å¼
        --- */
        @media print {
            /* ç•¶è§¸ç™¼ã€Œå»ºè­°æ›¸åˆ—å°ã€æ™‚ (body æœƒè¢« JS åŠ ä¸Š .printing-suggested-view) */
            body.printing-suggested-view {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 1. éš±è—æ‰€æœ‰ä¸ç›¸é—œçš„é é¢ */
            body.printing-suggested-view .page-view:not(#suggested-main-menu-view) {
                display: none !important;
            }

            /* 2. å¼·åˆ¶é¡¯ç¤ºå»ºè­°æ›¸ä¸»é é¢ */
            body.printing-suggested-view #suggested-main-menu-view {
                display: block !important;
            }

            /* --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ (ä¾æ‚¨çš„éœ€æ±‚ä¿®æ”¹) --- */
            /* 3. é¡¯ç¤ºã€Œåˆ—å°å°ˆç”¨æ¨™é¡Œã€ */
            body.printing-suggested-view .print-only-suggested-title {
                display: block !important;
            }

            /* 4. éš±è—ã€Œè¢å¹•ç‰ˆã€çš„æ¨™é¡Œ (åŒ…å«æŒ‰éˆ•å’Œåº•ç·š) */
            body.printing-suggested-view #suggested-main-menu-view .page-header {
                display: none !important;
            }
            /* --- ä¿®æ”¹çµæŸ --- */


            /* 5. ç¢ºä¿å®¹å™¨æ¨£å¼æ­£ç¢º */
            body.printing-suggested-view .container {
                box-shadow: none !important;
                border: none !important;
                padding: 10px !important;
                max-width: 100% !important;
            }

            /* 6. è™•ç†åˆ†é ï¼šåœ“åœˆåœ– (Page 1) å’Œ åˆ—è¡¨ (Page 2) */
            body.printing-suggested-view #suggested-main-menu-container {
                page-break-after: always; /* åœ“åœˆåœ–å°å®Œå¾Œå¼·åˆ¶æ›é  */
                height: auto !important; /* ç¢ºä¿åœ“åœˆåœ–å®Œæ•´é¡¯ç¤º */
                margin: 50px auto;

                /* --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ ç¸®æ”¾åœ“åœˆåœ–ä»¥å®Œæ•´åˆ—å° --- */
                width: 100%; /* ç¢ºä¿å®¹å™¨ä½”æ»¿å¯¬åº¦ä»¥æ­£ç¢ºç½®ä¸­ */
                transform: scale(0.75); /* å°‡ 800px çš„åœ“åœˆåœ–ç¸®å° 75% (600px) */
                transform-origin: top center; /* å¾é ‚éƒ¨ä¸­å¿ƒé–‹å§‹ç¸®æ”¾ */
                min-height: 800px; /* ç¢ºä¿å®¹å™¨åœ¨ç¸®æ”¾å‰æœ‰ 800px é«˜åº¦ä¾†å®¹ç´æ‰€æœ‰åœ“åœˆ */
                /* --- ä¿®æ”¹çµæŸ --- */
            }
            body.printing-suggested-view .suggested-summary-container {
                page-break-before: always; /* åˆ—è¡¨åœ¨æ–°çš„ä¸€é é–‹å§‹ */
                display: block !important; /* ç¢ºä¿åˆ—è¡¨å¯è¦‹ */
                margin-top: 20px;
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 7. ç¢ºä¿åœ“åœˆåœ–é¡è‰²è¢«åˆ—å° */
            body.printing-suggested-view .menu-circle {
                background-image: linear-gradient(145deg, #0052D4, #4364F7, #6FB1FC) !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body.printing-suggested-view a.menu-circle-link {
                background-color: #ffffff !important;
                color: #006400 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* --- åŸç‰ˆåˆ—å°å°ˆç”¨æ¨£å¼ (ä¸å—å½±éŸ¿) --- */
        @media print {
            /* ç•¶ body æ²’æœ‰ .printing-suggested-view æ™‚ï¼Œä»¥ä¸‹è¦å‰‡æ­£å¸¸é‹ä½œ */
            body:not(.printing-suggested-view) {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff;
                padding: 0;
                margin: 0;
            }
            body:not(.printing-suggested-view) .container {
                box-shadow: none;
                border-radius: 0;
                padding: 10px;
                max-width: 100%;
            }
            /* éš±è—æ‰€æœ‰éå‚³çµ±åˆ—è¡¨çš„è¦–åœ– */
            body:not(.printing-suggested-view) .page-view:not(#traditional-list-view) {
                display: none !important;
            }
            body:not(.printing-suggested-view) #traditional-list-view {
                display: block !important; /* å¼·åˆ¶é¡¯ç¤ºå‚³çµ±åˆ—è¡¨ */
            }
            body:not(.printing-suggested-view) .main-controls-buttons,
            body:not(.printing-suggested-view) .view-controls .buttons-right,
            body:not(.printing-suggested-view) .view-controls-left #toggle-all-btn,
            body:not(.printing-suggested-view) .back-to-main-btn,
            body:not(.printing-suggested-view) #go-to-circle-view-btn,
            body:not(.printing-suggested-view) .page-header /* éš±è—æ‰€æœ‰åœ“åœˆé¸å–®çš„æ¨™é ­ */
            {
                display: none;
            }
            body:not(.printing-suggested-view) .main-controls { justify-content: flex-start; }
            body:not(.printing-suggested-view) hr { display: none; }
            body:not(.printing-suggested-view) .category,
            body:not(.printing-suggested-view) .product-item { break-inside: avoid; }
            body:not(.printing-suggested-view) .category-title.level-0 > .category-name,
            body:not(.printing-suggested-view) .product-status { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            body:not(.printing-suggested-view) .en-link-wrapper { display: none; }
            body:not(.printing-suggested-view) .suggested-summary-container { display: none !important; } /* ã€åŸç‰ˆã€‘åˆ—å°æ™‚éš±è—ç¸½è¦½ */
        }
    </style>
</head><body>
    <div class="container">

        <div id="main-menu-view" class="page-view active">
            <div class="page-header">
                <h1>å•†å“å°è¦½ä¸»é¸å–®</h1>
                <button id="go-to-suggested-view-btn">å»ºè­°æ›¸å•†å“å°è¦½</button>
                <button id="go-to-admin-view-btn">å‰å¾€å¾Œå°ç®¡ç†/åˆ—è¡¨</button>
            </div>
            <div id="main-menu-container" class="circle-menu-container">
            </div>
        </div>

        <div id="sub-menu-view" class="page-view">
            <div class="page-header">
                <button class="back-button" id="main-menu-back-btn">è¿”å›ä¸»é¸å–®</button>
                <h1 id="sub-menu-title"></h1>
            </div>
            <div id="sub-menu-container" class="circle-menu-container">
            </div>
        </div>

        <div id="product-list-view" class="page-view">
            <div class="page-header">
                <button class="back-button" id="product-list-back-btn">è¿”å›ä¸Šä¸€å±¤</button>
                <h1 id="product-list-title"></h1>
            </div>
            <div id="product-list-content">
            </div>
        </div>

        <div id="suggested-main-menu-view" class="page-view">

            <h1 class="print-only-suggested-title">å»ºè­°æ›¸å•†å“å°è¦½</h1>

            <div class="page-header">
                <button id="go-back-to-main-menu-btn" class="back-button">è¿”å›ä¸»é¸å–®</button>
                <h1>å»ºè­°æ›¸å•†å“å°è¦½</h1>
                <button id="print-suggested-view-btn">åˆ—å°æœ¬é </button>
            </div>
            <div id="suggested-main-menu-container" class="circle-menu-container">
            </div>
            <div id="l1-suggested-summary-container" class="suggested-summary-container">
            </div>
        </div>

        <div id="suggested-sub-menu-view" class="page-view">
            <div class="page-header">
                <button class="back-button" id="suggested-main-menu-back-btn">è¿”å›å»ºè­°æ›¸ä¸»é¸å–®</button>
                <h1 id="suggested-sub-menu-title"></h1>
            </div>
            <div id="suggested-sub-menu-container" class="circle-menu-container">
            </div>
            <div id="l2-suggested-summary-container" class="suggested-summary-container">
            </div>
        </div>

        <div id="suggested-product-list-view" class="page-view">
            <div class="page-header">
                <button class="back-button" id="suggested-product-list-back-btn">è¿”å›ä¸Šä¸€å±¤</button>
                <h1 id="suggested-product-list-title"></h1>
            </div>
            <div id="suggested-product-list-content">
            </div>
        </div>


        <div id="traditional-list-view" class="page-view">
            <div class="main-controls">
                <div class="title-and-back-button-container">
                    <a href="../ä¸»è¦å…¥å£.html" class="back-to-main-btn">å›å…¥å£</a>
                    <h1>ä¿éšªå•†å“å°è¦½(åŸç‰ˆ)</h1>
                    <button id="go-to-circle-view-btn">è¿”å›åœ“åœˆé¸å–®</button>
                </div>
                <div class="main-controls-buttons">
                    <button id="save-html-btn">å¦å­˜htmlæª”</button>
                    <button id="print-btn">åˆ—å°æª”</button>
                    <button id="open-management-modal-btn">ç®¡ç†å•†å“åˆ†é¡çµæ§‹</button>
                    <button id="open-suggested-modal-btn">è¨­å®šå»ºè­°å•†å“</button>
                </div>
            </div>

            <hr style="border: 1px solid #005a9c; margin: 40px 0;">

            <div class="view-controls">
                <div class="view-controls-left">
                    <h2>å•†å“å°è¦½</h2>
                    <button id="toggle-all-btn" class="filter-btn">å…¨éƒ¨æ”¶åˆ</button>
                </div>
                <div class="buttons-right">
                    <div class="filter-button-wrapper">
                        <span id="active-suggested-count" class="product-count-badge">0</span>
                        <button id="show-active-suggested-btn" class="filter-btn">éŠ·å”®ä¸­+å»ºè­°</button>
                    </div>
                    <div class="filter-button-wrapper">
                        <span id="suggested-count" class="product-count-badge">0</span>
                        <button id="show-suggested-btn" class="filter-btn">åƒ…é¡¯ç¤ºå»ºè­°å•†å“</button>
                    </div>
                    <div class="filter-button-wrapper">
                        <span id="discontinued-count" class="product-count-badge">0</span>
                        <button id="show-discontinued-btn" class="filter-btn">é¡¯ç¤ºå·²åœå”®ä¿å–®</button>
                    </div>
                </div>
            </div>
            <div id="product-tree-container"></div>
        </div>

        <div id="edit-modal" class="modal">
            <div class="modal-content">
                <div id="modal-list-view" class="modal-view active">
                    <div class="modal-header">
                        <h3>ä¸»åˆ†é¡ç®¡ç†</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <section id="color-manager">
                        <h4>å°è¦½é¡è‰²è¨­å®š</h4>
                        <div class="color-pickers-container">
                            <div class="color-picker-group"><label for="l0-bg-color">ç¬¬ä¸€å±¤èƒŒæ™¯:</label><input type="color" id="l0-bg-color" data-css-var="--level-0-bg"></div>
                            <div class="color-picker-group"><label for="l0-text-color">ç¬¬ä¸€å±¤æ–‡å­—:</label><input type="color" id="l0-text-color" data-css-var="--level-0-text"></div>
                            <div class="color-picker-group"><label for="l1-text-color">ç¬¬äºŒå±¤æ–‡å­—:</label><input type="color" id="l1-text-color" data-css-var="--level-1-text"></div>
                            <div class="color-picker-group"><label for="l2-text-color">ç¬¬ä¸‰å±¤æ–‡å­—:</label><input type="color" id="l2-text-color" data-css-var="--level-2-text"></div>
                            <div class="color-picker-group"><label for="l3-text-color">ç¬¬å››å±¤æ–‡å­—:</label><input type="color" id="l3-text-color" data-css-var="--level-3-text"></div>
                            <div class="color-picker-group"><label for="l4-text-color">ç¬¬äº”å±¤æ–‡å­—:</label><input type="color" id="l4-text-color" data-css-var="--level-4-text"></div>
                            <div class="color-picker-group"><label for="product-text-color">å•†å“æ–‡å­—:</label><input type="color" id="product-text-color" data-css-var="--product-text"></div>
                        </div>
                    </section>
                    <section id="category-manager">
                        <h4>åˆ†é¡çµæ§‹ç·¨è¼¯</h4>
                        <div class="manager-header">
                            <h5>æ‰€æœ‰ä¸»åˆ†é¡</h5>
                            <button id="add-main-category-btn">ï¼‹ æ–°å¢ä¸»åˆ†é¡</button>
                        </div>
                        <ul id="category-list"></ul>
                    </section>
                </div>
                <div id="modal-editor-view" class="modal-view">
                    <div class="modal-header">
                        <h3>ç·¨è¼¯åˆ†é¡çµæ§‹</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <div id="modal-form-container"></div>
                    <div class="modal-footer">
                        <button id="modal-save-btn">å„²å­˜æ‰€æœ‰è®Šæ›´</button>
                        <button id="modal-back-btn">è¿”å›</button>
                        <button id="modal-cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="suggested-product-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>è¨­å®šå»ºè­°å•†å“ <span id="suggested-count-display" class="header-count-badge"></span><button id="deselect-all-btn" class="deselect-btn">å…¨éƒ¨å–æ¶ˆå‹¾é¸</button></h3>
                    <span class="close-btn">&times;</span>
                </div>
                <p style="margin-top:0; color: #666;">è«‹å‹¾é¸æ‰€æœ‰æ‚¨æƒ³è¨­å®šç‚ºã€Œå»ºè­°å•†å“ã€çš„é …ç›®ã€‚æœªå‹¾é¸çš„é …ç›®å°‡æœƒè¢«è¨­ç‚ºã€ŒéŠ·å”®ä¸­ã€ã€‚</p>
                <div id="suggested-product-list-container">
                </div>
                <div class="modal-footer">
                    <button id="suggested-save-btn">å„²å­˜è®Šæ›´</button>
                    <button id="suggested-cancel-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- è³‡æ–™å„²å­˜æ ¸å¿ƒ ---
    const LOCAL_STORAGE_KEY = 'nanshanProductData';
    const COLOR_STORAGE_KEY = 'nanshanColorSettings';

    // é è¨­è³‡æ–™ (åƒ…åœ¨å®Œå…¨æ²’æœ‰ä»»ä½•å·²å­˜è³‡æ–™æ™‚è¼‰å…¥)
    const initialProductData = [
        {
            type: 'category', name: 'äººç”Ÿè²¡å‹™ç›®æ¨™è¦åŠƒ', url: '', children: [
                { type: 'category', name: 'å°å¹£ç†è²¡å‹å£½éšª', linkText: 'å‰å¾€å°å¹£ç†è²¡å‹ä»‹ç´¹', url: '#', children: [
                    { type: 'category', name: 'ç´¯ç©å‹', url: 'https://www.nanshangeneral.com.tw/', children: [
                         { type: 'category', name: 'ç¬¬å››å±¤ç¯„ä¾‹', children: [
                            { type: 'category', name: 'ç¬¬äº”å±¤ç¯„ä¾‹', children: [] }
                         ]},
                        { type: 'product', name: 'å•†å“1 (éŠ·å”®ä¸­)', status: 'active', links: [{text:'å»ºè­°å•†å“', url:'#'}, {text:'å½±éŸ³ç°¡å ±', url:'#'}, {text:'ç›®éŒ„', url:'#'}, {text:'æ¢æ¬¾', url:''}, {text:'EN', url:'#'}, {text:'', url:''}]},
                        { type: 'product', name: 'å•†å“2 (å·²åœå”®)', status: 'discontinued', discontinuedDate: '113.12.31', links: [{text:'', url:''}, {text:'', url:''}, {text:'', url:''}, {text:'', url:''}, {text:'', url:''}, {text:'', url:''}]},
                        { type: 'product', name: 'å•†å“3 (å»ºè­°)', status: 'suggested', links: [{text:'å»ºè­°å•†å“', url:'#'}, {text:'å½±éŸ³ç°¡å ±', url:'#'}, {text:'ç›®éŒ„', url:'#'}, {text:'æ¢æ¬¾', url:'#'}, {text:'EN', url:'#'}, {text:'', url:''}]}
                    ]},
                    { type: 'category', name: 'é‚„æœ¬å‹', url: '', children: [] }
                ]},
                { type: 'category', name: 'ç¾å…ƒç†è²¡å‹å£½éšª', url: '', children: [] },
                { type: 'category', name: 'æŠ•è³‡å‹-æœˆæ’¥å›', url: '', children: [] }
            ]
        },
        { type: 'category', name: 'ä¿éšœå®¶äººå®‰å…¨è¦åŠƒ', url: '', children: [] },
        { type: 'category', name: 'ä½é™¢å„é …è²¡å‹™è£œåŠ©', url: '', children: [] },
        { type: 'category', name: 'ç™Œç—‡é†«ç™‚', url: '', children: [] },
    ];

    const defaultColors = {
        '--level-0-bg': '#28a745',
        '--level-0-text': '#ffffff',
        '--level-1-text': '#007bff',
        '--level-2-text': '#654321',
        '--level-3-text': '#E65100',
        '--level-4-text': '#8E44AD',
        '--product-text': '#333333'
    };

    // ---
    // --- ã€ä¿®æ”¹ã€‘å”¯è®€æª”æ¡ˆè…³æœ¬æ¨¡æ¿ (View-only Script Template)
    // --- **æ³¨å…¥äº†åœ“åœˆé¸å–®çš„ HTML å’Œ JS**
    // ---
    const VIEW_ONLY_SCRIPT_TEMPLATE = `
        const productData = %%PRODUCT_DATA%%;
        let displayFilter = ['active', 'suggested'];
        const treeContainer = document.getElementById('product-tree-container');
        let suggestedModalTotalCount = 0;
        let currentMainIndex = -1;
        // ã€æ–°å¢ã€‘å»ºè­°æ›¸å°ˆç”¨
        let suggestedProductData = [];
        let currentSuggestedMainIndex = -1;


        // ---
        // --- æ–°å¢ï¼šåœ“åœˆé¸å–® JS
        // ---
        function showView(viewId) {
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            const viewToShow = document.querySelector(viewId);
            if(viewToShow) viewToShow.classList.add('active');
            window.scrollTo(0, 0);

            // --- ã€æ–°åŠŸèƒ½ã€‘é›¢é–‹ L2 æ™‚ï¼Œæ¸…ç©º L2 åˆ—è¡¨ ---
            if (viewId !== '#suggested-sub-menu-view') {
                const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
                if (l2SummaryContainer) {
                    l2SummaryContainer.innerHTML = '';
                    l2SummaryContainer.style.display = 'none';
                }
            }
            // --- ã€æ–°åŠŸèƒ½ã€‘é›¢é–‹ L1 æ™‚ï¼Œæ¸…ç©º L1 åˆ—è¡¨ ---
            if (viewId !== '#suggested-main-menu-view') {
                const l1SummaryContainer = document.getElementById('l1-suggested-summary-container');
                if (l1SummaryContainer) {
                    l1SummaryContainer.innerHTML = '';
                    l1SummaryContainer.style.display = 'none';
                }
            }
        }
function createCircleMenuProductTree(nodes, level = 0) {
            const ul = document.createElement('ul');
            ul.className = level === 0 ? 'product-tree' : 'children-container';

            nodes.forEach(node => {
                const li = document.createElement('li');

                if (node.type === 'category') {
                    li.className = 'tree-node category';
                    const nameElement = \`<span class="category-name">\${node.name}</span>\`;
                    const hasUrl = node.url && node.url.trim() !== '';
                    const hasLinkText = node.linkText && node.linkText.trim() !== '';
                    let linkElement = '';

                    if (hasUrl && hasLinkText) {
                        linkElement = \`<a href="\${node.url}" target="_blank" class="product-links">\${node.linkText.trim()}</a>\`;
                    } else if (hasUrl) {
                        linkElement = \`<a href="\${node.url}" target="_blank" title="é–‹å•Ÿé€£çµ: \${node.url}" class="link-icon-button">ğŸ“</a>\`;
                    }

                    li.innerHTML = \`<div class="category-title level-\${level}"><span class="toggle-icon">\${(node.children && node.children.length > 0) ? 'â–¼' : ''}</span>\${nameElement}\${linkElement}</div>\`;

                    if (node.children && node.children.length > 0) {
                        li.appendChild(createCircleMenuProductTree(node.children, level + 1));
                    }

                    li.querySelector('.category-title').addEventListener('click', (e) => {
                        if (e.target.tagName === 'A' || e.target.closest('a')) return;
                        const categoryNode = e.currentTarget.parentNode;
                        if (categoryNode.querySelector('.children-container')) {
                            categoryNode.classList.toggle('collapsed');
                            const icon = categoryNode.querySelector('.toggle-icon');
                            if (icon) icon.textContent = categoryNode.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
                        }
                    });

                } else if (node.type === 'product') {
                    li.className = 'tree-node product-item';

                    let statusText = '';
                    switch (node.status) {
                        case 'active': statusText = 'éŠ·å”®ä¸­'; break;
                        case 'discontinued': statusText = 'å·²åœå”®'; break;
                        case 'suggested': statusText = 'å»ºè­°å•†å“'; break;
                        default: statusText = 'éŠ·å”®ä¸­';
                    }

                    if (node.status === 'discontinued' && node.discontinuedDate) {
                        statusText += \` (\${node.discontinuedDate})\`;
                    }

                    let linksHTML = '';
                    if (node.links && Array.isArray(node.links)) {
                        // ==================================================================
                        // === ã€ç¬¬ä¸€é …ä¿®æ”¹ã€‘: åœ¨å¦å­˜çš„æª”æ¡ˆä¸­ï¼Œéæ¿¾æ‰ "EN" é€£çµ (åœ“åœˆé¸å–®åˆ—è¡¨) ===
                        // ==================================================================
                        const validLinks = node.links
                            .filter(link =>
                                link.text && link.text.trim() !== '' &&
                                link.url && link.url.trim() !== '' &&
                                link.text.trim().toUpperCase() !== 'EN' // ã€ä¿®æ”¹ã€‘éæ¿¾æ‰ EN
                            );

                        if (validLinks.length > 0) {
                            const linkContent = validLinks.map(link => {
                                // ã€ä¿®æ”¹ã€‘ç§»é™¤ isEnLink åˆ¤æ–·ï¼Œå› ç‚º EN å·²è¢«éæ¿¾
                                const wrapperClass = 'class="link-wrapper"';
                                return \`<span \${wrapperClass}><a href="\${link.url}" target="_blank">\${link.text.trim()}</a></span>\`;
                            }).join('');
                            linksHTML = \`<span class="product-links">\${linkContent}</span>\`;
                        }
                    }
                    li.innerHTML = \`<span class="product-name">\${node.name}</span><span class="product-status \${node.status || 'active'}">\${statusText}</span>\${linksHTML}\`;
                }

                ul.appendChild(li);
            });
            return ul;
        }

        // ---
        // --- ã€ä¿®æ”¹ã€‘ä¸»è¦åœ“åœˆé¸å–® (L1)
        // ---
        function renderMainMenu() {
            const container = document.getElementById('main-menu-container');
            if(!container) return;
            container.innerHTML = '';

            const numItems = productData.length;
            if (numItems === 0) return; // ã€ä¿®æ­£ã€‘åŠ ä¸Šåˆ†è™Ÿæˆ–æ›è¡Œ
            const radius = 300;
            const angleStep = (2 * Math.PI) / numItems;

            productData.forEach((category, index) => {
                const angle = index * angleStep - (Math.PI / 2);
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const positioner = document.createElement('div');
                positioner.className = 'circle-positioner';
                positioner.style.transform = \`translate(\${x}px, \${y}px)\`;

                const circle = document.createElement('div');
                circle.className = 'menu-circle';

                const hasLink = category.linkText && category.linkText.trim() !== '' && category.url && category.url.trim() !== '';
                const linkHTML = hasLink
                    ? \`<a href="\${category.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">\${category.linkText}</a>\`
                    : '';

                circle.innerHTML = \`
                    <div class="menu-circle-content">
                        <div class="menu-circle-name">\${category.name}</div>
                        \${linkHTML}
                    </div>
                \`;

                circle.onclick = () => {
                    showSubMenu(index);
                };

                positioner.appendChild(circle);
                container.appendChild(positioner);
            });
        }

        // ---
        // --- ã€ä¿®æ”¹ã€‘ä¸»è¦åœ“åœˆé¸å–® (L2)
        // ---
        function showSubMenu(mainIndex) {
            currentMainIndex = mainIndex;
            const mainCategory = productData[mainIndex];
            const subCategories = mainCategory.children || [];

            document.getElementById('sub-menu-title').innerText = mainCategory.name;
            const container = document.getElementById('sub-menu-container');
            container.innerHTML = '';

            const numItems = subCategories.length;
            if (numItems === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">æ­¤åˆ†é¡ä¸‹æ²’æœ‰å­é …ç›®ã€‚</p>';
                showView('#sub-menu-view');
                return;
            }

            const radius = 220;
            const angleStep = (2 * Math.PI) / numItems;

            subCategories.forEach((subCategory, subIndex) => {
                const angle = subIndex * angleStep - (Math.PI / 2);
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const positioner = document.createElement('div');
                positioner.className = 'circle-positioner';
                positioner.style.transform = \`translate(\${x}px, \${y}px)\`;

                const circle = document.createElement('div');
                circle.className = 'menu-circle';

                const hasLink = subCategory.linkText && subCategory.linkText.trim() !== '' && subCategory.url && subCategory.url.trim() !== '';
                const linkHTML = hasLink
                    ? \`<a href="\${subCategory.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">\${subCategory.linkText}</a>\`
                    : '';

                circle.innerHTML = \`
                    <div class="menu-circle-content">
                        <div class="menu-circle-name">\${subCategory.name}</div>
                        \${linkHTML}
                    </div>
                \`;

                circle.onclick = () => {
                    showProductList(mainIndex, subIndex);
                };

                positioner.appendChild(circle);
                container.appendChild(positioner);
            });

            showView('#sub-menu-view');
        }

        // ---
        // --- ã€ä¿®æ”¹ã€‘ä¸»è¦åœ“åœˆé¸å–® (L3)
        // ---
        function showProductList(mainIndex, subIndex) {
            const subCategory = productData[mainIndex].children[subIndex];
            const products = subCategory.children || [];

            document.getElementById('product-list-title').innerText = subCategory.name;
            const content = document.getElementById('product-list-content');
            content.innerHTML = '';

            const productTreeElement = createCircleMenuProductTree(products, 0);
            content.appendChild(productTreeElement);

            showView('#product-list-view');
        }

        // ---
        // --- ã€æ–°å¢ã€‘éæ¿¾å»ºè­°æ›¸å•†å“
        // ---
        function filterDataForSuggested(nodes) {
            const result = [];
            for (const node of nodes) {
                if (node.type === 'category') {
                    const filteredChildren = filterDataForSuggested(node.children || []);
                    if (filteredChildren.length > 0) {
                        result.push({ ...node, children: filteredChildren });
                    }
                } else if (node.type === 'product' && node.status === 'suggested') {
                    result.push(node);
                }
            }
            return result;
        }

        // ---
        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ ä¿®æ”¹å»ºè­°æ›¸ç¸½è¡¨ç›¸é—œå‡½å¼ (for å”¯è®€ç¯„æœ¬)ï¼ŒåŠ å…¥é€£çµ
        // ---
        function collectSuggestedProducts(nodes) {
            let products = [];
            for (const node of nodes) {
                if (node.type === 'category') {
                    products = products.concat(collectSuggestedProducts(node.children || []));
                } else if (node.type === 'product' && node.status === 'suggested') {
                    products.push(node);
                }
            }
            return products;
        }

        function renderUniqueSuggestedList(productList, targetContainer, title) {
            targetContainer.innerHTML = '';
            if (productList.length === 0) {
                targetContainer.style.display = 'none';
                return;
            }
            const uniqueProductsMap = new Map();
            productList.forEach(product => {
                if (!uniqueProductsMap.has(product.name)) {
                    uniqueProductsMap.set(product.name, product);
                }
            });
            const uniqueProducts = Array.from(uniqueProductsMap.values());
            uniqueProducts.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

            const listItems = uniqueProducts.map(product => {
                let linksHTML = '';
                if (product.links && Array.isArray(product.links)) {
                    // ====================================================================
                    // === ã€ç¬¬äºŒé …ä¿®æ”¹ã€‘: åœ¨å¦å­˜çš„æª”æ¡ˆä¸­ï¼Œéæ¿¾æ‰ "EN" é€£çµ (L1/L2 ç¸½è¦½åˆ—è¡¨) ===
                    // ====================================================================
                    linksHTML = product.links
                        .filter(link =>
                            link.text && link.text.trim() !== '' &&
                            link.url && link.url.trim() !== '' &&
                            link.text.trim().toUpperCase() !== 'EN' // ã€ä¿®æ”¹ã€‘éæ¿¾æ‰ EN
                        )
                        .map(link => \`<a href="\${link.url}" target="_blank" class="summary-link">\${link.text.trim()}</a>\`)
                        .join(' '); // ç”¨ç©ºæ ¼åˆ†éš”é€£çµ
                }
                // è¿”å›åŒ…å«åç¨±å’Œé€£çµçš„åˆ—è¡¨é … HTML
                return \`<li class="suggested-summary-item"><span class="summary-product-name">\${product.name}</span>\${linksHTML}</li>\`;
            }).join('');

            targetContainer.innerHTML = \`
                <h4>\${title} (å…± \${uniqueProducts.length} é …)</h4>
                <ul class="suggested-summary-list">
                    \${listItems}
                </ul>
            \`;
            targetContainer.style.display = 'block';
        }

        // ---
        // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸åœ“åœˆé¸å–® (L1)
        // ---
        function renderSuggestedMainMenu() {
            const container = document.getElementById('suggested-main-menu-container');
            container.innerHTML = '';

            const numItems = suggestedProductData.length;
            if (numItems === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">ç›®å‰æ²’æœ‰è¨­å®šå»ºè­°æ›¸å•†å“ã€‚</p>';
                // ã€æ–°åŠŸèƒ½ã€‘æ¸…ç©º L1 ç¸½è¡¨
                const l1SummaryContainer = document.getElementById('l1-suggested-summary-container');
                if (l1SummaryContainer) l1SummaryContainer.style.display = 'none';
                return;
            }

            const radius = 300;
            const angleStep = (2 * Math.PI) / numItems;

            suggestedProductData.forEach((category, index) => {
                const angle = index * angleStep - (Math.PI / 2);
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const positioner = document.createElement('div');
                positioner.className = 'circle-positioner';
                positioner.style.transform = \`translate(\${x}px, \${y}px)\`;

                const circle = document.createElement('div');
                circle.className = 'menu-circle';

                const hasLink = category.linkText && category.linkText.trim() !== '' && category.url && category.url.trim() !== '';
                const linkHTML = hasLink
                    ? \`<a href="\${category.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">\${category.linkText}</a>\`
                    : '';

                circle.innerHTML = \`
                    <div class="menu-circle-content">
                        <div class="menu-circle-name">\${category.name}</div>
                        \${linkHTML}
                    </div>
                \`;

                circle.onclick = () => {
                    showSuggestedSubMenu(index);
                };

                positioner.appendChild(circle);
                container.appendChild(positioner);
            });

            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ¸²æŸ“ L1 å•†å“ç¸½è¡¨ ---
            const allSuggestedProducts = collectSuggestedProducts(suggestedProductData);
            const l1SummaryContainer = document.getElementById('l1-suggested-summary-container');
            renderUniqueSuggestedList(allSuggestedProducts, l1SummaryContainer, 'å»ºè­°æ›¸å•†å“ç¸½è¦½');
        }

        // ---
        // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸åœ“åœˆé¸å–® (L2)
        // ---
        function showSuggestedSubMenu(mainIndex) {
            currentSuggestedMainIndex = mainIndex;
            const mainCategory = suggestedProductData[mainIndex];
            const subCategories = mainCategory.children || [];

            document.getElementById('suggested-sub-menu-title').innerText = mainCategory.name;
            const container = document.getElementById('suggested-sub-menu-container');
            container.innerHTML = '';

            const numItems = subCategories.length;
            if (numItems === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">æ­¤åˆ†é¡ä¸‹æ²’æœ‰å­é …ç›®ã€‚</p>';
                // ã€æ–°åŠŸèƒ½ã€‘æ¸…ç©º L2 ç¸½è¡¨
                const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
                if (l2SummaryContainer) l2SummaryContainer.style.display = 'none';
                showView('#suggested-sub-menu-view');
                return;
            }

            const radius = 220;
            const angleStep = (2 * Math.PI) / numItems;

            subCategories.forEach((subCategory, subIndex) => {
                const angle = subIndex * angleStep - (Math.PI / 2);
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const positioner = document.createElement('div');
                positioner.className = 'circle-positioner';
                positioner.style.transform = \`translate(\${x}px, \${y}px)\`;

                const circle = document.createElement('div');
                circle.className = 'menu-circle';

                const hasLink = subCategory.linkText && subCategory.linkText.trim() !== '' && subCategory.url && subCategory.url.trim() !== '';
                const linkHTML = hasLink
                    ? \`<a href="\${subCategory.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">\${subCategory.linkText}</a>\`
                    : '';

                circle.innerHTML = \`
                    <div class="menu-circle-content">
                        <div class="menu-circle-name">\${subCategory.name}</div>
                        \${linkHTML}
                    </div>
                \`;

                circle.onclick = () => {
                    showSuggestedProductList(mainIndex, subIndex);
                };

                positioner.appendChild(circle);
                container.appendChild(positioner);
            });

            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ¸²æŸ“ L2 å•†å“ç¸½è¡¨ ---
            const l2SuggestedProducts = collectSuggestedProducts(subCategories);
            const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
            renderUniqueSuggestedList(l2SuggestedProducts, l2SummaryContainer, \`ã€Œ\${mainCategory.name}ã€åˆ†é¡å•†å“\`);

            showView('#suggested-sub-menu-view');
        }

        // ---
        // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸åœ“åœˆé¸å–® (L3)
        // ---
        function showSuggestedProductList(mainIndex, subIndex) {
            const subCategory = suggestedProductData[mainIndex].children[subIndex];
            const products = subCategory.children || [];

            document.getElementById('suggested-product-list-title').innerText = subCategory.name;
            const content = document.getElementById('suggested-product-list-content');
            content.innerHTML = '';

            const productTreeElement = createCircleMenuProductTree(products, 0);
            content.appendChild(productTreeElement);

            showView('#suggested-product-list-view');
        }
        // --- åœ“åœˆé¸å–® JS çµæŸ ---


        // ---
        // --- ä»¥ä¸‹ç‚ºã€ŒåŸç‰ˆæª”æ¡ˆã€çš„ JS (View-Only ç‰ˆæœ¬)
        // ---
        function filterDataRecursive(nodes) {
            const result = [];
            for (const node of nodes) {
                if (node.type === 'category') {
                    const filteredChildren = filterDataRecursive(node.children || []);
                    if (filteredChildren.length > 0) {
                        result.push({ ...node, children: filteredChildren });
                    }
                } else {
                    const currentStatus = node.status || 'active';
                    if (displayFilter.includes(currentStatus)) {
                        result.push(node);
                    }
                }
            }
            return result;
        }

        function createTreeRecursive(nodes, level = 0) {
            const ul = document.createElement('ul');
            ul.className = level === 0 ? 'product-tree' : 'children-container';
            nodes.forEach(node => {
                const li = document.createElement('li');
                if (node.type === 'category') {
                    li.className = 'tree-node category';
                    const nameElement = \`<span class="category-name">\${node.name}</span>\`;
                    const hasUrl = node.url && node.url.trim() !== '';
                    const hasLinkText = node.linkText && node.linkText.trim() !== '';
                    let linkElement = '';
                    if (hasUrl && hasLinkText) {
                        linkElement = \`<a href="\${node.url}" target="_blank" class="product-links">\${node.linkText.trim()}</a>\`;
                    } else if (hasUrl) {
                        linkElement = \`<a href="\${node.url}" target="_blank" title="é–‹å•Ÿé€£çµ: \${node.url}" class="link-icon-button">ğŸ“</a>\`;
                    }
                    li.innerHTML = \`<div class="category-title level-\${level}"><span class="toggle-icon">\${(node.children && node.children.length > 0) ? 'â–¼' : ''}</span>\${nameElement}\${linkElement}</div>\`;
                    if (node.children && node.children.length > 0) {
                        li.appendChild(createTreeRecursive(node.children, level + 1));
                    }
                } else if (node.type === 'product') {
                    li.className = 'tree-node product-item';
                    let statusText = '';
                    switch (node.status) {
                        case 'active': statusText = 'éŠ·å”®ä¸­'; break;
                        case 'discontinued': statusText = 'å·²åœå”®'; break;
                        case 'suggested': statusText = 'å»ºè­°å•†å“'; break;
                        default: statusText = 'éŠ·å”®ä¸­';
                    }
                    if (node.status === 'discontinued' && node.discontinuedDate) {
                        statusText += \` (\${node.discontinuedDate})\`;
                    }

                    let linksHTML = '';
                    if (node.links && Array.isArray(node.links)) {
                        // ======================================================================
                        // === ã€ç¬¬ä¸‰é …ä¿®æ”¹ã€‘: åœ¨å¦å­˜çš„æª”æ¡ˆä¸­ï¼Œéæ¿¾æ‰ "EN" é€£çµ (å‚³çµ±åˆ—è¡¨æ¨¡å¼) ===
                        // ======================================================================
                        const validLinks = node.links
                            .filter(link =>
                                link.text && link.text.trim() !== '' &&
                                link.url && link.url.trim() !== '' &&
                                link.text.trim().toUpperCase() !== 'EN' // ã€ä¿®æ”¹ã€‘éæ¿¾æ‰ EN
                            );

                        if (validLinks.length > 0) {
                            const linkContent = validLinks.map(link => {
                                // ã€ä¿®æ”¹ã€‘ç§»é™¤ isEnLink åˆ¤æ–·
                                return \`<span class="link-wrapper"><a href="\${link.url}" target="_blank">\${link.text.trim()}</a></span>\`;
                            }).join('');
                            linksHTML = \`<span class="product-links">\${linkContent}</span>\`;
                        }
                    }
                    li.innerHTML = \`<span class="product-name">\${node.name}</span><span class="product-status \${node.status || 'active'}">\${statusText}</span>\${linksHTML}\`;
                }
                ul.appendChild(li);
            });
            return ul;
        }

        function renderProductTree() {
            const filteredData = filterDataRecursive(JSON.parse(JSON.stringify(productData)));
            treeContainer.innerHTML = '';
            if (filteredData.length > 0) {
                treeContainer.appendChild(createTreeRecursive(filteredData));
            } else {
                treeContainer.innerHTML = '<p style="text-align:center; color:#6c757d;">åœ¨æ­¤æª¢è¦–æ¨¡å¼ä¸‹æ²’æœ‰å¯é¡¯ç¤ºçš„å•†å“ã€‚</p>';
            }
        }

        function handleToggle(event) {
            const title = event.target.closest('.category-title');
            if (!title) return;
            if (event.target.tagName === 'A' || event.target.closest('a')) { return; }
            const categoryNode = title.parentNode;
            if (categoryNode.querySelector('.children-container')) {
                categoryNode.classList.toggle('collapsed');
                const icon = title.querySelector('.toggle-icon');
                if (icon) {
                    icon.textContent = categoryNode.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
                }
            }
        }

        function toggleAll(expand) {
            const allCategories = treeContainer.querySelectorAll('.category');
            const toggleAllBtn = document.getElementById('toggle-all-btn');
            allCategories.forEach(categoryNode => {
                if (categoryNode.querySelector('.children-container')) {
                    const icon = categoryNode.querySelector('.toggle-icon');
                    if (expand) {
                        categoryNode.classList.remove('collapsed');
                        if (icon) icon.textContent = 'â–¼';
                    } else {
                        categoryNode.classList.add('collapsed');
                        if (icon) icon.textContent = 'â–¶';
                    }
                }
            });
            toggleAllBtn.textContent = expand ? 'å…¨éƒ¨æ”¶åˆ' : 'å…¨éƒ¨å±•é–‹';
            toggleAllBtn.dataset.state = expand ? 'expanded' : 'collapsed';
        }

        function updateFilter(newFilter, activeBtn) {
            const allFilterBtns = document.querySelectorAll('.buttons-right .filter-btn');
            displayFilter = newFilter;
            allFilterBtns.forEach(btn => btn.classList.remove('active-filter'));
            activeBtn.classList.add('active-filter');
            renderProductTree();
            toggleAll(true);
        }

        function updateFilterCounts() {
            let activeSuggestedCount = 0, suggestedCount = 0, discontinuedCount = 0;
            function countProductsRecursive(nodes) {
                nodes.forEach(node => {
                    if (node.type === 'category' && node.children) {
                        countProductsRecursive(node.children);
                    } else if (node.type === 'product') {
                        const status = node.status || 'active';
                        if (status === 'active' || status === 'suggested') activeSuggestedCount++;
                        if (status === 'suggested') suggestedCount++;
                        if (status === 'discontinued') discontinuedCount++;
                    }
                });
            }
            countProductsRecursive(productData);
            document.getElementById('active-suggested-count').textContent = activeSuggestedCount;
            document.getElementById('suggested-count').textContent = suggestedCount;
            document.getElementById('discontinued-count').textContent = discontinuedCount;
        }
function updateSuggestedCountDisplay(checkedCount) {
            const suggestedCountDisplay = document.getElementById('suggested-count-display');
            if (suggestedCountDisplay) {
                suggestedCountDisplay.textContent = \`å·²å‹¾é¸ \${checkedCount} / ç¸½è¨ˆ \${suggestedModalTotalCount}\`;
            }
        }

        function renderSuggestedProductManager() {
            const suggestedProductListContainer = document.getElementById('suggested-product-list-container');
            suggestedProductListContainer.innerHTML = '';
            let totalCount = 0;
            let checkedCount = 0;

            function findAndRenderProductsRecursive(nodes, parentCategoryName) {
                nodes.forEach(node => {
                    if (node.type === 'product' && (node.status === 'active' || node.status === 'suggested')) {
                        totalCount++;
                        const isSuggested = node.status === 'suggested';
                        if (isSuggested) checkedCount++;

                        const itemLabel = document.createElement('label');
                        const safeNodeName = node.name.replace(/"/g, '&quot;');
                        itemLabel.innerHTML = \`<input type="checkbox" value="\${safeNodeName}" \${isSuggested ? 'checked' : ''}> <span>\${node.name}</span>\`;
                        const container = suggestedProductListContainer.querySelector(\`[data-category-name="\${parentCategoryName}"]\`);
                        if(container) container.appendChild(itemLabel);
                    }
                    if (node.type === 'category' && node.children) {
                        const currentCategoryName = \`\${parentCategoryName} > \${node.name}\`;
                        const categoryContainer = document.createElement('div');
                        categoryContainer.innerHTML = \`<h5>\${node.name}</h5>\`;
                        categoryContainer.dataset.categoryName = currentCategoryName;
                        suggestedProductListContainer.appendChild(categoryContainer);
                        findAndRenderProductsRecursive(node.children, currentCategoryName);
                        if (categoryContainer.querySelectorAll('label').length === 0) categoryContainer.remove();
                    }
                });
            }

            productData.forEach(mainCategory => {
                const mainCategoryContainer = document.createElement('div');
                mainCategoryContainer.innerHTML = \`<h5>\${mainCategory.name}</h5>\`;
                mainCategoryContainer.dataset.categoryName = mainCategory.name;
                suggestedProductListContainer.appendChild(mainCategoryContainer);
                if (mainCategory.children) {
                    findAndRenderProductsRecursive(mainCategory.children, mainCategory.name);
                }
                if (mainCategoryContainer.querySelectorAll('label').length === 0) mainCategoryContainer.remove();
            });

            suggestedModalTotalCount = totalCount;
            updateSuggestedCountDisplay(checkedCount);

            if (totalCount === 0) {
                suggestedProductListContainer.innerHTML = '<p>æ²’æœ‰å¯è¨­å®šç‚ºå»ºè­°çš„å•†å“ (ç‹€æ…‹ç‚º "éŠ·å”®ä¸­" æˆ– "å»ºè­°")ã€‚</p>';
            }
        }

        function closeSuggestedModal() {
            const suggestedProductModal = document.getElementById('suggested-product-modal');
            if (suggestedProductModal) {
                suggestedProductModal.style.display = 'none';
            }
        }

        function saveSuggestedProducts() {
            const suggestedProductListContainer = document.getElementById('suggested-product-list-container');
            const checkedInputs = suggestedProductListContainer.querySelectorAll('input[type="checkbox"]:checked');
            const suggestedProductNames = new Set(Array.from(checkedInputs).map(input => input.value));

            function updateStatusRecursive(nodes) {
                nodes.forEach(node => {
                    if (node.type === 'product') {
                        if (suggestedProductNames.has(node.name)) {
                            node.status = 'suggested';
                        } else if (node.status === 'suggested') {
                            node.status = 'active';
                        }
                    }
                    if (node.children) updateStatusRecursive(node.children);
                });
            }

            updateStatusRecursive(productData);

            const activeFilterBtn = document.querySelector('.buttons-right .active-filter') || document.getElementById('show-active-suggested-btn');
            updateFilter(displayFilter, activeFilterBtn);
            updateFilterCounts();

            closeSuggestedModal();
            alert('å»ºè­°å•†å“å·²åœ¨æœ¬é é¢æ›´æ–°ï¼\\nåˆ·æ–°æˆ–é—œé–‰é é¢å¾Œå°‡æœƒé‚„åŸã€‚');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- æ–°å¢ï¼šåœ“åœˆé¸å–®æŒ‰éˆ• ---
            const goToAdminBtn = document.getElementById('go-to-admin-view-btn');
            const mainMenuBackBtn = document.getElementById('main-menu-back-btn');
            const productListBackBtn = document.getElementById('product-list-back-btn');
            const goToCircleBtn = document.getElementById('go-to-circle-view-btn');
            // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½æŒ‰éˆ• ---
            const goToSuggestedViewBtn = document.getElementById('go-to-suggested-view-btn');
            const goBackToMainMenuBtn = document.getElementById('go-back-to-main-menu-btn');
            const suggestedMainMenuBackBtn = document.getElementById('suggested-main-menu-back-btn');
            const suggestedProductListBackBtn = document.getElementById('suggested-product-list-back-btn');
            const printSuggestedViewBtn = document.getElementById('print-suggested-view-btn'); // ã€æ–°å¢ã€‘å»ºè­°æ›¸åˆ—å°æŒ‰éˆ•


            // --- åŸç‰ˆï¼šå‚³çµ±åˆ—è¡¨æŒ‰éˆ• ---
            const showDiscontinuedBtn = document.getElementById('show-discontinued-btn');
            const showSuggestedBtn = document.getElementById('show-suggested-btn');
            const showActiveSuggestedBtn = document.getElementById('show-active-suggested-btn');
            const toggleAllBtn = document.getElementById('toggle-all-btn');
            const openSuggestedModalBtn = document.getElementById('open-suggested-modal-btn');
            const suggestedProductModal = document.getElementById('suggested-product-modal');
            const suggestedSaveBtn = document.getElementById('suggested-save-btn');
            const suggestedCancelBtn = document.getElementById('suggested-cancel-btn');
            const suggestedProductListContainer = document.getElementById('suggested-product-list-container');
            const printBtn = document.getElementById('print-btn');
            const deselectAllBtn = document.getElementById('deselect-all-btn');

            // ---
            // --- ã€ä¿®æ”¹ã€‘åˆå§‹åŒ–ï¼šåŒæ™‚åˆå§‹åŒ–å…©å€‹è¦–åœ–
            // ---
            updateFilterCounts(); // 1. è¨ˆç®—æ‰€æœ‰æ•¸å­—
            updateFilter(displayFilter, showActiveSuggestedBtn); // 2. æ¸²æŸ“å‚³çµ±åˆ—è¡¨ (éš±è—)
            renderMainMenu(); // 3. æ¸²æŸ“åœ“åœˆé¸å–® (é¡¯ç¤º)
            // 4. é è¨­è¦–åœ–å·²ç”± HTML class="active" è¨­å®š

            // --- æ–°å¢ï¼šåœ“åœˆé¸å–®å°èˆªäº‹ä»¶ ---
            if(goToAdminBtn) goToAdminBtn.addEventListener('click', () => showView('#traditional-list-view'));
            if(goToCircleBtn) goToCircleBtn.addEventListener('click', () => showView('#main-menu-view'));
            if(mainMenuBackBtn) mainMenuBackBtn.addEventListener('click', () => showView('#main-menu-view'));
            if(productListBackBtn) productListBackBtn.addEventListener('click', () => {
                if (currentMainIndex !== -1) showSubMenu(currentMainIndex);
            });

            // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½äº‹ä»¶ ---
            if(goToSuggestedViewBtn) goToSuggestedViewBtn.addEventListener('click', () => {
                suggestedProductData = filterDataForSuggested(JSON.parse(JSON.stringify(productData)));
                renderSuggestedMainMenu();
                showView('#suggested-main-menu-view');
            });
            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ è¿”å›æŒ‰éˆ•å¢åŠ æ¸…ç©ºç¸½è¦½åŠŸèƒ½ ---
            if(goBackToMainMenuBtn) goBackToMainMenuBtn.addEventListener('click', () => {
                showView('#main-menu-view');
            });
            if(suggestedMainMenuBackBtn) suggestedMainMenuBackBtn.addEventListener('click', () => {
                 showView('#suggested-main-menu-view');
            });
            if(suggestedProductListBackBtn) suggestedProductListBackBtn.addEventListener('click', () => {
                if (currentSuggestedMainIndex !== -1) showSuggestedSubMenu(currentSuggestedMainIndex);
            });

            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ å»ºè­°æ›¸åˆ—å°äº‹ä»¶ ---
            if(printSuggestedViewBtn) printSuggestedViewBtn.addEventListener('click', () => {
                // 1. åœ¨ body åŠ ä¸Šæ¨™è¨˜ class
                document.body.classList.add('printing-suggested-view');
                // 2. è§¸ç™¼ç€è¦½å™¨åˆ—å°
                window.print();
                // 3. åˆ—å°çµæŸå¾Œ (ç„¡è«–æ˜¯ç¢ºèªæˆ–å–æ¶ˆ)ï¼Œç§»é™¤æ¨™è¨˜ class
                //    ä½¿ç”¨ setTimeout ç¢ºä¿åˆ—å°å°è©±æ¡†æœ‰è¶³å¤ æ™‚é–“åæ‡‰
                setTimeout(() => {
                    document.body.classList.remove('printing-suggested-view');
                }, 500);
            });


            // --- åŸç‰ˆï¼šå‚³çµ±åˆ—è¡¨äº‹ä»¶ ---
            showActiveSuggestedBtn.addEventListener('click', () => updateFilter(['active', 'suggested'], showActiveSuggestedBtn));
            showSuggestedBtn.addEventListener('click', () => updateFilter(['suggested'], showSuggestedBtn));
            showDiscontinuedBtn.addEventListener('click', () => updateFilter(['discontinued'], showDiscontinuedBtn));
            treeContainer.addEventListener('click', handleToggle);

            toggleAllBtn.addEventListener('click', () => {
                const shouldExpand = toggleAllBtn.dataset.state === 'collapsed';
                toggleAll(shouldExpand);
            });

            openSuggestedModalBtn.addEventListener('click', () => {
                renderSuggestedProductManager();
                suggestedProductModal.style.display = 'block';
            });

            suggestedSaveBtn.addEventListener('click', saveSuggestedProducts);
            suggestedCancelBtn.addEventListener('click', closeSuggestedModal);

            if (suggestedProductModal) {
                suggestedProductModal.querySelector('.close-btn').addEventListener('click', closeSuggestedModal);
            }

            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', () => {
                    if (confirm("ç¢ºå®šè¦å–æ¶ˆå·²å‹¾é¸å•†å“?")) {
                        const checkboxes = suggestedProductListContainer.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            cb.checked = false;
                        });
                        updateSuggestedCountDisplay(0);
                    }
                });
            }

            suggestedProductListContainer.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    const currentCheckedCount = suggestedProductListContainer.querySelectorAll('input:checked').length;
                    updateSuggestedCountDisplay(currentCheckedCount);
                }
            });

            if (printBtn) {
                printBtn.addEventListener('click', () => {
                    // ã€é‡è¦ã€‘ç¢ºä¿åŸç‰ˆåˆ—å°ä¸å—å½±éŸ¿ (body ä¸Šæ²’æœ‰ .printing-suggested-view)
                    document.body.classList.remove('printing-suggested-view');
                    window.print();
                });
            }

            window.addEventListener('click', (event) => {
                if (event.target == suggestedProductModal) {
                    closeSuggestedModal();
                }
            });
        });
    `;

    let productData;
    let displayFilter = ['active', 'suggested'];
    // --- æ–°å¢ï¼šåœ“åœˆé¸å–®çš„å…¨åŸŸè®Šæ•¸ ---
    let currentMainIndex = -1;
    // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½çš„å…¨åŸŸè®Šæ•¸ ---
    let suggestedProductData = [];
    let currentSuggestedMainIndex = -1;

    // ---
    // --- æ–°å¢ï¼šåœ“åœˆé¸å–®çš„ JS å‡½å¼ (From å•†å“å»ºè­°æ›¸é¦–é 4.html)
    // ---

    /**
     * é¡¯ç¤ºæŒ‡å®šçš„é é¢è¦–åœ–
     */
    function showView(viewId) {
        document.querySelectorAll('.page-view').forEach(view => {
            view.classList.remove('active');
        });
        const viewToShow = document.querySelector(viewId);
        if(viewToShow) viewToShow.classList.add('active');
        window.scrollTo(0, 0);

        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ é›¢é–‹ L2 æ™‚ï¼Œæ¸…ç©º L2 åˆ—è¡¨ ---
        if (viewId !== '#suggested-sub-menu-view') {
            const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
            if (l2SummaryContainer) {
                l2SummaryContainer.innerHTML = '';
                l2SummaryContainer.style.display = 'none';
            }
        }
        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ é›¢é–‹ L1 æ™‚ï¼Œæ¸…ç©º L1 åˆ—è¡¨ ---
        if (viewId !== '#suggested-main-menu-view') {
            const l1SummaryContainer = document.getElementById('l1-suggested-summary-container');
            if (l1SummaryContainer) {
                l1SummaryContainer.innerHTML = '';
                l1SummaryContainer.style.display = 'none';
            }
        }
    }

    /**
     * å»ºç«‹å•†å“æ¨¹ç‹€åœ– (æ­¤å‡½å¼å°ˆé–€çµ¦åœ“åœˆé¸å–®çš„å•†å“åˆ—è¡¨é ä½¿ç”¨ï¼Œå› ç‚ºå®ƒåŒ…å«äº†è‡ªå·±çš„é»æ“Šäº‹ä»¶)
     * ã€*** é€™æ˜¯ç·¨è¼¯å™¨ã€Œç›®å‰ç•«é¢ã€çš„å‡½å¼ï¼Œä¿æŒåŸæ¨£ï¼Œé¡¯ç¤º EN ***ã€‘
     */
    function createCircleMenuProductTree(nodes, level = 0) {
        const ul = document.createElement('ul');
        ul.className = level === 0 ? 'product-tree' : 'children-container';

        nodes.forEach(node => {
            const li = document.createElement('li');

            if (node.type === 'category') {
                li.className = 'tree-node category';
                const nameElement = `<span class="category-name">${node.name}</span>`;
                const hasUrl = node.url && node.url.trim() !== '';
                const hasLinkText = node.linkText && node.linkText.trim() !== '';
                let linkElement = '';

                if (hasUrl && hasLinkText) {
                    linkElement = `<a href="${node.url}" target="_blank" class="product-links">${node.linkText.trim()}</a>`;
                } else if (hasUrl) {
                    linkElement = `<a href="${node.url}" target="_blank" title="é–‹å•Ÿé€£çµ: ${node.url}" class="link-icon-button">ğŸ“</a>`;
                }
                li.innerHTML = `<div class="category-title level-${level}"><span class="toggle-icon">${(node.children && node.children.length > 0) ? 'â–¼' : ''}</span>${nameElement}${linkElement}</div>`;

                if (node.children && node.children.length > 0) {
                    li.appendChild(createCircleMenuProductTree(node.children, level + 1));
                }

                // --- åœ“åœˆé¸å–®åˆ—è¡¨çš„å°ˆå±¬é»æ“Šäº‹ä»¶ ---
                li.querySelector('.category-title').addEventListener('click', (e) => {
                    if (e.target.tagName === 'A' || e.target.closest('a')) return;
                    const categoryNode = e.currentTarget.parentNode;
                    if (categoryNode.querySelector('.children-container')) {
                        categoryNode.classList.toggle('collapsed');
                        const icon = categoryNode.querySelector('.toggle-icon');
                        if (icon) icon.textContent = categoryNode.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
                    }
                });

            } else if (node.type === 'product') {
                li.className = 'tree-node product-item';

                let statusText = '';
                switch (node.status) {
                    case 'active': statusText = 'éŠ·å”®ä¸­'; break;
                    case 'discontinued': statusText = 'å·²åœå”®'; break;
                    case 'suggested': statusText = 'å»ºè­°å•†å“'; break;
                    default: statusText = 'éŠ·å”®ä¸­';
                }

                if (node.status === 'discontinued' && node.discontinuedDate) {
                    statusText += ` (${node.discontinuedDate})`;
                }

                let linksHTML = '';
                if (node.links && Array.isArray(node.links)) {
                    const validLinks = node.links
                        .filter(link => link.text && link.text.trim() !== '' && link.url && link.url.trim() !== '');

                    if (validLinks.length > 0) {
                        const linkContent = validLinks.map(link => {
                            // ã€ä¿æŒåŸæ¨£ã€‘
                            const isEnLink = link.text.trim().toUpperCase() === 'EN';
                            const wrapperClass = isEnLink ? 'class="link-wrapper en-link-wrapper"' : 'class="link-wrapper"';
                            return `<span ${wrapperClass}><a href="${link.url}" target="_blank">${link.text.trim()}</a></span>`;
                        }).join('');
                        linksHTML = `<span class="product-links">${linkContent}</span>`;
                    }
                }
                li.innerHTML = `<span class="product-name">${node.name}</span><span class="product-status ${node.status || 'active'}">${statusText}</span>${linksHTML}`;
            }

            ul.appendChild(li);
        });
        return ul;
    }


    /**
     * ç”¢ç”Ÿä¸»é¸å–® (L1 åœ“åœˆ)
     */
    function renderMainMenu() {
        const container = document.getElementById('main-menu-container');
        container.innerHTML = ''; // æ¸…ç©º

        const numItems = productData.length;
        if (numItems === 0) return; // ã€ä¿®æ­£ã€‘åŠ ä¸Šåˆ†è™Ÿæˆ–æ›è¡Œ
        const radius = 300; // L1 åŠå¾‘
        const angleStep = (2 * Math.PI) / numItems;

        productData.forEach((category, index) => {
            const angle = index * angleStep - (Math.PI / 2);
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);

            const positioner = document.createElement('div');
            positioner.className = 'circle-positioner';
            positioner.style.transform = `translate(${x}px, ${y}px)`;

            const circle = document.createElement('div');
            circle.className = 'menu-circle';

            const hasLink = category.linkText && category.linkText.trim() !== '' && category.url && category.url.trim() !== '';
            const linkHTML = hasLink
                ? `<a href="${category.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">${category.linkText}</a>`
                : '';

            circle.innerHTML = `
                <div class="menu-circle-content">
                    <div class="menu-circle-name">${category.name}</div>
                    ${linkHTML}
                </div>
            `;

            circle.onclick = () => {
                showSubMenu(index);
            };

            positioner.appendChild(circle);
            container.appendChild(positioner);
        });
    }

    /**
     * é¡¯ç¤ºæ¬¡é¸å–® (L2 åœ“åœˆ)
     */
    function showSubMenu(mainIndex) {
        currentMainIndex = mainIndex;
        const mainCategory = productData[mainIndex];
        const subCategories = mainCategory.children || [];

        document.getElementById('sub-menu-title').innerText = mainCategory.name;
        const container = document.getElementById('sub-menu-container');
        container.innerHTML = '';

        const numItems = subCategories.length;
        if (numItems === 0) {
            container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">æ­¤åˆ†é¡ä¸‹æ²’æœ‰å­é …ç›®ã€‚</p>';
            showView('#sub-menu-view');
            return;
        }

        const radius = 220; // L2 åŠå¾‘
        const angleStep = (2 * Math.PI) / numItems;

        subCategories.forEach((subCategory, subIndex) => {
            const angle = subIndex * angleStep - (Math.PI / 2);
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);

            const positioner = document.createElement('div');
            positioner.className = 'circle-positioner';
            positioner.style.transform = `translate(${x}px, ${y}px)`;

            const circle = document.createElement('div');
            circle.className = 'menu-circle';

            const hasLink = subCategory.linkText && subCategory.linkText.trim() !== '' && subCategory.url && subCategory.url.trim() !== '';
            const linkHTML = hasLink
                ? `<a href="${subCategory.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">${subCategory.linkText}</a>`
                : '';

            circle.innerHTML = `
                <div class="menu-circle-content">
                    <div class="menu-circle-name">${subCategory.name}</div>
                    ${linkHTML}
                </div>
            `;

            circle.onclick = () => {
                showProductList(mainIndex, subIndex);
            };

            positioner.appendChild(circle);
            container.appendChild(positioner);
        });

        showView('#sub-menu-view');
    }

    /**
     * é¡¯ç¤ºæœ€çµ‚çš„å•†å“åˆ—è¡¨
     */
    function showProductList(mainIndex, subIndex) {
        const subCategory = productData[mainIndex].children[subIndex];
        const products = subCategory.children || [];

        document.getElementById('product-list-title').innerText = subCategory.name;
        const content = document.getElementById('product-list-content');
        content.innerHTML = '';

        // --- ä¿®æ”¹ï¼šå‘¼å«å°ˆå±¬çš„ 'createCircleMenuProductTree' å‡½å¼ ---
        const productTreeElement = createCircleMenuProductTree(products, 0);
        content.appendChild(productTreeElement);

        showView('#product-list-view');
    }

    // ---
    // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ å»ºè­°æ›¸å°è¦½å°ˆç”¨å‡½å¼ (å³æ™‚ç·¨è¼¯)ï¼ŒåŠ å…¥é€£çµ
    // ---

    /**
     * @brief (æ–°) éè¿´æ”¶é›†æ‰€æœ‰ 'suggested' å•†å“
     * @param {Array} nodes - è¦æœå°‹çš„ç¯€é»
     * @returns {Array} - åŒ…å«å•†å“ç‰©ä»¶çš„é™£åˆ—
     */
    function collectSuggestedProducts(nodes) {
        let products = [];
        for (const node of nodes) {
            if (node.type === 'category') {
                products = products.concat(collectSuggestedProducts(node.children || []));
            } else if (node.type === 'product' && node.status === 'suggested') {
                products.push(node);
            }
        }
        return products;
    }/**
     * @brief (æ–°) å°‡å•†å“é™£åˆ—å»é‡ä¸¦æ¸²æŸ“åˆ°ç›®æ¨™å®¹å™¨ (åŒ…å«é€£çµ)
     * ã€*** é€™æ˜¯ç·¨è¼¯å™¨ã€Œç›®å‰ç•«é¢ã€çš„å‡½å¼ï¼Œä¿æŒåŸæ¨£ï¼Œé¡¯ç¤º EN ***ã€‘
     * @param {Array} productList - å•†å“ç‰©ä»¶é™£åˆ—
     * @param {HTMLElement} targetContainer - è¦æ¸²æŸ“çš„ DOM å…ƒç´ 
     * @param {string} title - é¡¯ç¤ºçš„æ¨™é¡Œ
     */
    function renderUniqueSuggestedList(productList, targetContainer, title) {
        targetContainer.innerHTML = ''; // æ¸…ç©º
        if (productList.length === 0) {
            targetContainer.style.display = 'none'; // å¦‚æœæ²’å•†å“ï¼Œéš±è—å®¹å™¨
            return;
        }

        // 1. ä¾æ“š 'name' å»é‡
        const uniqueProductsMap = new Map();
        productList.forEach(product => {
            if (!uniqueProductsMap.has(product.name)) {
                uniqueProductsMap.set(product.name, product);
            }
        });
        const uniqueProducts = Array.from(uniqueProductsMap.values());

        // 2. æ’åº
        uniqueProducts.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

        // 3. ç”¢ç”Ÿ HTML (åŒ…å«é€£çµ)
        const listItems = uniqueProducts.map(product => {
            let linksHTML = '';
            if (product.links && Array.isArray(product.links)) {
                linksHTML = product.links
                    // ã€ä¿æŒåŸæ¨£ã€‘ä¸éæ¿¾ EN
                    .filter(link => link.text && link.text.trim() !== '' && link.url && link.url.trim() !== '')
                    .map(link => `<a href="${link.url}" target="_blank" class="summary-link">${link.text.trim()}</a>`)
                    .join(' '); // ç”¨ç©ºæ ¼åˆ†éš”é€£çµ
            }
            // è¿”å›åŒ…å«åç¨±å’Œé€£çµçš„åˆ—è¡¨é … HTML
            return `<li class="suggested-summary-item"><span class="summary-product-name">${product.name}</span>${linksHTML}</li>`;
        }).join('');


        targetContainer.innerHTML = `
            <h4>${title} (å…± ${uniqueProducts.length} é …)</h4>
            <ul class="suggested-summary-list">
                ${listItems}
            </ul>
        `;
        targetContainer.style.display = 'block'; // é¡¯ç¤ºå®¹å™¨
    }


    /**
     * @brief éè¿´éæ¿¾å‡ºåªåŒ…å« "suggested" å•†å“çš„è³‡æ–™æ¨¹
     * @param {Array} nodes - è¦éæ¿¾çš„ç¯€é»é™£åˆ—
     * @returns {Array} - åªåŒ…å«å»ºè­°å•†å“åŠå…¶çˆ¶åˆ†é¡çš„æ–°é™£åˆ—
     */
    function filterDataForSuggested(nodes) {
        const result = [];
        for (const node of nodes) {
            if (node.type === 'category') {
                // éè¿´éæ¿¾å­ç¯€é»
                const filteredChildren = filterDataForSuggested(node.children || []);
                // å¦‚æœé€™å€‹åˆ†é¡æœ‰å­ç¯€é» (ä»£è¡¨å­ç¯€é»ä¸­æœ‰å»ºè­°å•†å“)ï¼Œå‰‡ä¿ç•™å®ƒ
                if (filteredChildren.length > 0) {
                    result.push({ ...node, children: filteredChildren });
                }
            } else if (node.type === 'product' && node.status === 'suggested') {
                // å¦‚æœæ˜¯å•†å“ä¸”ç‹€æ…‹ç‚º 'suggested'ï¼Œä¿ç•™å®ƒ
                result.push(node);
            }
        }
        return result;
    }

    /**
     * ã€æ–°å¢ã€‘ç”¢ç”Ÿå»ºè­°æ›¸ä¸»é¸å–® (L1 åœ“åœˆ)
     */
    function renderSuggestedMainMenu() {
        const container = document.getElementById('suggested-main-menu-container');
        container.innerHTML = ''; // æ¸…ç©º

        const numItems = suggestedProductData.length;
        if (numItems === 0) {
            container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">ç›®å‰æ²’æœ‰è¨­å®šå»ºè­°æ›¸å•†å“ã€‚</p>';
            // ã€æ–°åŠŸèƒ½ã€‘æ¸…ç©º L1 ç¸½è¡¨
            const l1SummaryContainer = document.getElementById('l1-suggested-summary-container');
            if (l1SummaryContainer) l1SummaryContainer.style.display = 'none';
            return;
        }

        const radius = 300; // L1 åŠå¾‘
        const angleStep = (2 * Math.PI) / numItems;

        suggestedProductData.forEach((category, index) => {
            const angle = index * angleStep - (Math.PI / 2);
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);

            const positioner = document.createElement('div');
            positioner.className = 'circle-positioner';
            positioner.style.transform = `translate(${x}px, ${y}px)`;

            const circle = document.createElement('div');
            circle.className = 'menu-circle';

            const hasLink = category.linkText && category.linkText.trim() !== '' && category.url && category.url.trim() !== '';
            const linkHTML = hasLink
                ? `<a href="${category.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">${category.linkText}</a>`
                : '';

            circle.innerHTML = `
                <div class="menu-circle-content">
                    <div class="menu-circle-name">${category.name}</div>
                    ${linkHTML}
                </div>
            `;

            circle.onclick = () => {
                showSuggestedSubMenu(index);
            };

            positioner.appendChild(circle);
            container.appendChild(positioner);
        });

        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ¸²æŸ“ L1 å•†å“ç¸½è¡¨ ---
        const allSuggestedProducts = collectSuggestedProducts(suggestedProductData);
        const l1SummaryContainer = document.getElementById('l1-suggested-summary-container');
        renderUniqueSuggestedList(allSuggestedProducts, l1SummaryContainer, 'å»ºè­°æ›¸å•†å“ç¸½è¦½');
        // --- çµæŸ ---
    }/**
     * ã€æ–°å¢ã€‘é¡¯ç¤ºå»ºè­°æ›¸æ¬¡é¸å–® (L2 åœ“åœˆ)
     */
    function showSuggestedSubMenu(mainIndex) {
        currentSuggestedMainIndex = mainIndex; // ä½¿ç”¨å»ºè­°æ›¸å°ˆç”¨çš„ index
        const mainCategory = suggestedProductData[mainIndex];
        const subCategories = mainCategory.children || [];

        document.getElementById('suggested-sub-menu-title').innerText = mainCategory.name;
        const container = document.getElementById('suggested-sub-menu-container');
        container.innerHTML = '';

        const numItems = subCategories.length;
        if (numItems === 0) {
            container.innerHTML = '<p style="text-align:center; color:#666; width:100%;">æ­¤åˆ†é¡ä¸‹æ²’æœ‰å­é …ç›®ã€‚</p>';
            // ã€æ–°åŠŸèƒ½ã€‘æ¸…ç©º L2 ç¸½è¡¨
            const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
            if (l2SummaryContainer) l2SummaryContainer.style.display = 'none';
            showView('#suggested-sub-menu-view');
            return;
        }

        const radius = 220; // L2 åŠå¾‘
        const angleStep = (2 * Math.PI) / numItems;

        subCategories.forEach((subCategory, subIndex) => {
            const angle = subIndex * angleStep - (Math.PI / 2);
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);

            const positioner = document.createElement('div');
            positioner.className = 'circle-positioner';
            positioner.style.transform = `translate(${x}px, ${y}px)`;

            const circle = document.createElement('div');
            circle.className = 'menu-circle';

            const hasLink = subCategory.linkText && subCategory.linkText.trim() !== '' && subCategory.url && subCategory.url.trim() !== '';
            const linkHTML = hasLink
                ? `<a href="${subCategory.url}" target="_blank" class="menu-circle-link" onclick="event.stopPropagation()">${subCategory.linkText}</a>`
                : '';

            circle.innerHTML = `
                <div class="menu-circle-content">
                    <div class="menu-circle-name">${subCategory.name}</div>
                    ${linkHTML}
                </div>
            `;

            circle.onclick = () => {
                showSuggestedProductList(mainIndex, subIndex);
            };

            positioner.appendChild(circle);
            container.appendChild(positioner);
        });

        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ¸²æŸ“ L2 å•†å“ç¸½è¡¨ ---
        // æ³¨æ„ï¼šé€™è£¡æ˜¯å¾ subCategories (L2) é–‹å§‹æ”¶é›†
        const l2SuggestedProducts = collectSuggestedProducts(subCategories);
        const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
        renderUniqueSuggestedList(l2SuggestedProducts, l2SummaryContainer, `ã€Œ${mainCategory.name}ã€åˆ†é¡å•†å“`);
        // --- çµæŸ ---

        showView('#suggested-sub-menu-view');
    }

    /**
     * ã€æ–°å¢ã€‘é¡¯ç¤ºå»ºè­°æ›¸æœ€çµ‚çš„å•†å“åˆ—è¡¨
     */
    function showSuggestedProductList(mainIndex, subIndex) {
        const subCategory = suggestedProductData[mainIndex].children[subIndex];
        const products = subCategory.children || [];

        document.getElementById('suggested-product-list-title').innerText = subCategory.name;
        const content = document.getElementById('suggested-product-list-content');
        content.innerHTML = '';

        const productTreeElement = createCircleMenuProductTree(products, 0);
        content.appendChild(productTreeElement);

        showView('#suggested-product-list-view');
    }

    // --- åœ“åœˆé¸å–® JS çµæŸ ---


    // ---
    // --- ä»¥ä¸‹ç‚ºã€ŒåŸç‰ˆæª”æ¡ˆã€çš„ JS (ä¿æŒä¸è®Š)
    // ---

    function saveData() {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(productData));
        } catch (e) {
            console.error("Error saving data to localStorage", e);
            alert("å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼");
        }
    }

    function loadData() {
        const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedData) {
            try {
                productData = JSON.parse(storedData);
            } catch (e) {
                console.error("Error parsing data from localStorage", e);
                productData = JSON.parse(JSON.stringify(initialProductData));
            }
        } else {
            productData = JSON.parse(JSON.stringify(initialProductData));
        }
    }

    function applyColors(colorSettings) {
        for (const [key, value] of Object.entries(colorSettings)) {
            document.documentElement.style.setProperty(key, value);
        }
    }

    function loadAndApplyColors() {
        const storedColors = localStorage.getItem(COLOR_STORAGE_KEY);
        const colors = storedColors ? JSON.parse(storedColors) : defaultColors;
        applyColors(colors);
        document.querySelectorAll('#color-manager input[type="color"]').forEach(picker => {
            const cssVar = picker.dataset.cssVar;
            if (colors[cssVar]) {
                picker.value = colors[cssVar];
            }
        });
    }

    function saveColorSettings() {
        const newSettings = {};
        document.querySelectorAll('#color-manager input[type="color"]').forEach(picker => {
            newSettings[picker.dataset.cssVar] = picker.value;
        });
        localStorage.setItem(COLOR_STORAGE_KEY, JSON.stringify(newSettings));
    }

    // ===================================================================================
    // === ã€ä¿®æ”¹ã€‘ã€Œå¦å­˜htmlæª”ã€åŠŸèƒ½ (å·²æ³¨å…¥åœ“åœˆé¸å–®çš„ HTML å’Œ JS, ä¸”æ›´æ–°äº†ç¸½è¦½åˆ—è¡¨) ===
    // ===================================================================================
    function generateAndDownloadHtml() {
        // 1. å–å¾—ç›®å‰çš„é¡è‰²è¨­å®š
        const currentColors = {};
        Object.keys(defaultColors).forEach(key => {
            currentColors[key] = getComputedStyle(document.documentElement).getPropertyValue(key).trim();
        });
        const colorStyleBlock = `:root { ${Object.entries(currentColors).map(([k, v]) => `${k}: ${v};`).join(' ')} }`;

        // 2. å°‡ç›®å‰çš„å•†å“è³‡æ–™è½‰æ›ç‚ºå®‰å…¨çš„æ–‡å­—å­—ä¸²
        const productDataString = JSON.stringify(productData, null, 2);

        // 3. å°‡å•†å“è³‡æ–™å®‰å…¨åœ°åµŒå…¥è…³æœ¬æ¨¡æ¿ä¸­
        //    ã€ä¿®æ”¹ã€‘æ³¨å…¥äº†å»ºè­°æ›¸å°è¦½çš„ç›¸é—œJS (å·²åŒ…å«æ›´æ–°å¾Œçš„ renderUniqueSuggestedList)
        //    ã€*** æ­¤è™• VIEW_ONLY_SCRIPT_TEMPLATE å·²åœ¨ç¬¬ 1ã€2 éƒ¨åˆ†è¢«ä¿®æ”¹ï¼Œæœƒéæ¿¾ EN ***ã€‘
        const finalScript = VIEW_ONLY_SCRIPT_TEMPLATE.replace('%%PRODUCT_DATA%%', productDataString);

        // 4. çµ„åˆå‡ºä¸€å€‹å…¨æ–°çš„ã€å®Œæ•´çš„ HTML å…§å®¹å­—ä¸² (åŒ…å«æ–°çš„è¦–åœ–çµæ§‹)
        //    ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ åœ¨ 'suggested-main-menu-view' ä¸­åŠ å…¥æ–°çš„åˆ—å°æŒ‰éˆ•
        const htmlParts = [
            '<!DOCTYPE html>',
            '<html lang="zh-Hant">',
            '<head>',
            '    <meta charset="UTF-8">',
            '    <meta name="viewport" content="width=device-width, initial-scale=1.0">',
            '    <title>ä¿éšªå•†å“å°è¦½</title>',
            '    <style>',
            document.querySelector('style').innerHTML, // åŒ…å« .summary-link å’Œæ–°çš„ @media print æ¨£å¼
            '    </style>',
            '    <style>',
            colorStyleBlock,
            '    </style>',
            '</head>',
            '<body>',
            '    <div class="container">',

            // --- ä¿®æ”¹ï¼šåœ“åœˆé¸å–®çš„ HTML çµæ§‹ (L1) ---
            '        <div id="main-menu-view" class="page-view active">',
            '            <div class="page-header">',
            '                <h1>å•†å“å°è¦½ä¸»é¸å–®</h1>',
            '                <button id="go-to-suggested-view-btn" style="background-color: #28a745;">å»ºè­°æ›¸å•†å“å°è¦½</button>', // ã€æ–°å¢ã€‘
            '                <button id="go-to-admin-view-btn" style="background-color: #005a9c;">å‰å¾€å‚³çµ±åˆ—è¡¨æ¨¡å¼</button>',
            '            </div>',
            '            <div id="main-menu-container" class="circle-menu-container"></div>',
            '        </div>',
            // --- åœ“åœˆé¸å–® (L2) ---
            '        <div id="sub-menu-view" class="page-view">',
            '            <div class="page-header">',
            '                <button class="back-button" id="main-menu-back-btn">è¿”å›ä¸»é¸å–®</button>',
            '                <h1 id="sub-menu-title"></h1>',
            '            </div>',
            '            <div id="sub-menu-container" class="circle-menu-container"></div>',
            '        </div>',
            // --- åœ“åœˆé¸å–® (L3) ---
            '        <div id="product-list-view" class="page-view">',
            '            <div class="page-header">',
            '                <button class="back-button" id="product-list-back-btn">è¿”å›ä¸Šä¸€å±¤</button>',
            '                <h1 id="product-list-title"></h1>',
            '            </div>',
            '            <div id="product-list-content"></div>',
            '        </div>',

            // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½ HTML çµæ§‹ (L1) ---
            '        <div id="suggested-main-menu-view" class="page-view">',

            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ ä¾æ‚¨çš„éœ€æ±‚ï¼Œåœ¨å¦å­˜çš„æª”æ¡ˆä¸­åŠ å…¥åˆ—å°æ¨™é¡Œ ---
            '            <h1 class="print-only-suggested-title">å»ºè­°æ›¸å•†å“å°è¦½</h1>',

            '            <div class="page-header">',
            '                <button id="go-back-to-main-menu-btn" class="back-button">è¿”å›ä¸»é¸å–®</button>',
            '                <h1>å»ºè­°æ›¸å•†å“å°è¦½</h1>',
            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ åœ¨å¦å­˜çš„æª”æ¡ˆä¸­ä¹ŸåŠ å…¥åˆ—å°æŒ‰éˆ• ---
            '                <button id="print-suggested-view-btn" style="background-color: #17a2b8;">åˆ—å°æœ¬é </button>',
            '            </div>',
            '            <div id="suggested-main-menu-container" class="circle-menu-container"></div>',
            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ–°å¢ L1 å»ºè­°å•†å“ç¸½è¦½æ¡†æ¶ ---
            '            <div id="l1-suggested-summary-container" class="suggested-summary-container"></div>',
            '        </div>',
            // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½ (L2) ---
            '        <div id="suggested-sub-menu-view" class="page-view">',
            '            <div class="page-header">',
            '                <button class="back-button" id="suggested-main-menu-back-btn">è¿”å›å»ºè­°æ›¸ä¸»é¸å–®</button>',
            '                <h1 id="suggested-sub-menu-title"></h1>',
            '            </div>',
            '            <div id="suggested-sub-menu-container" class="circle-menu-container"></div>',
            // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ æ–°å¢ L2 å»ºè­°å•†å“ç¸½è¦½æ¡†æ¶ ---
            '            <div id="l2-suggested-summary-container" class="suggested-summary-container"></div>',
            '        </div>',
            // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½ (L3) ---
            '        <div id="suggested-product-list-view" class="page-view">',
            '            <div class="page-header">',
            '                <button class="back-button" id="suggested-product-list-back-btn">è¿”å›ä¸Šä¸€å±¤</button>',
            '                <h1 id="suggested-product-list-title"></h1>',
            '            </div>',
            '            <div id="suggested-product-list-content"></div>',
            '        </div>',

            // --- ä¿®æ”¹ï¼šåŸå§‹çš„åˆ—è¡¨è¦–åœ– (åŒ…åœ¨ page-view ä¸­) ---
            '        <div id="traditional-list-view" class="page-view">',
            '            <div class="main-controls">',
            '                 <div class="title-and-back-button-container" style="justify-content: space-between; width: 100%;">',
            '                     <h1 style="margin:0;">ä¿éšªå•†å“å°è¦½ (åˆ—è¡¨æ¨¡å¼)</h1>',
            '                     <button id="go-to-circle-view-btn" style="background-color: #007bff;">è¿”å›åœ“åœˆé¸å–®</button>',
            '                 </div>',
            '            </div>',
            '            <div class="main-controls" style="margin-top: 20px;">',
            '                <h2 style="margin:0;"></h2>', // ä½”ä½
            '                <div class="main-controls-buttons">',
            '                     <button id="open-suggested-modal-btn" style="background-color: #007bff; font-size: 1.1em; padding: 12px 20px;">è¨­å®šå»ºè­°å•†å“</button>',
            '                     <button id="print-btn" style="background-color: #6c757d; font-size: 1.1em; padding: 12px 20px;">åˆ—å°</button>',
            '                </div>',
            '            </div>',
            '            <hr style="border: 1px solid #005a9c; margin: 40px 0;">',
            '            <div class="view-controls">',
            '                <div class="view-controls-left">',
            '                   <h2>å•†å“å°è¦½</h2>',
            '                   <button id="toggle-all-btn" class="filter-btn">å…¨éƒ¨æ”¶åˆ</button>',
            '                </div>',
            '                <div class="buttons-right">',
            '                     <div class="filter-button-wrapper">',
            '                        <span id="active-suggested-count" class="product-count-badge">0</span>',
            '                        <button id="show-active-suggested-btn" class="filter-btn">éŠ·å”®ä¸­+å»ºè­°</button>',
            '                    </div>',
            '                    <div class="filter-button-wrapper">',
            '                        <span id="suggested-count" class="product-count-badge">0</span>',
            '                        <button id="show-suggested-btn" class="filter-btn">åƒ…é¡¯ç¤ºå»ºè­°å•†å“</button>',
            '                    </div>',
            '                    <div class="filter-button-wrapper">',
            '                        <span id="discontinued-count" class="product-count-badge">0</span>',
            '                        <button id="show-discontinued-btn" class="filter-btn">é¡¯ç¤ºå·²åœå”®ä¿å–®</button>',
            '                    </div>',
            '                </div>',
            '            </div>',
            '            <div id="product-tree-container"></div>',
            '        </div>', // çµæŸ traditional-list-view

            // --- ä¿æŒä¸è®Šï¼šModal å½ˆçª— ---
            '        <div id="suggested-product-modal" class="modal">',
            '            <div class="modal-content">',
            '                <div class="modal-header">',
            '                    <h3>è¨­å®šå»ºè­°å•†å“ <span id="suggested-count-display" class="header-count-badge"></span><button id="deselect-all-btn" class="deselect-btn">å…¨éƒ¨å–æ¶ˆå‹¾é¸</button></h3>',
            '                    <span class="close-btn">&times;</span>',
            '                </div>',
            '                <p style="margin-top:0; color: #666;">è«‹å‹¾é¸æ‰€æœ‰æ‚¨æƒ³è¨­å®šç‚ºã€Œå»ºè­°å•†å“ã€çš„é …ç›®ã€‚æœªå‹¾é¸çš„é …ç›®å°‡æœƒè¢«è¨­ç‚ºã€ŒéŠ·å”®ä¸­ã€ã€‚</p>',
            '                <div id="suggested-product-list-container"></div>',
            '                <div class="modal-footer">',
            '                    <button id="suggested-save-btn">å„²å­˜è®Šæ›´</button>',
            '                    <button id="suggested-cancel-btn">å–æ¶ˆ</button>',
            '                </div>',
            '            </div>',
            '        </div>',
            '    </div>', // çµæŸ container
            '    <script>',
            finalScript,
            '    <\/script>',
            '</body>',
            '</html>'
        ];

        const cleanHtmlContent = htmlParts.join('\n');

        // 5. è§¸ç™¼ç€è¦½å™¨ä¸‹è¼‰
        const blob = new Blob([cleanHtmlContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ä¿éšªå•†å“å°è¦½.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    // === END OF THE NEW SAVE FUNCTION ===


    // --- ä»¥ä¸‹ç‚ºé é¢äº’å‹•é‚è¼¯ (Page Interaction Logic) ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- è®Šæ•¸å®£å‘Š (åŸç‰ˆ) ---
        const treeContainer = document.getElementById('product-tree-container');
        const categoryList = document.getElementById('category-list');
        const addMainCategoryBtn = document.getElementById('add-main-category-btn');
        const openManagementModalBtn = document.getElementById('open-management-modal-btn');
        const saveHtmlBtn = document.getElementById('save-html-btn');
        const printBtn = document.getElementById('print-btn');
        const showDiscontinuedBtn = document.getElementById('show-discontinued-btn');
        const showSuggestedBtn = document.getElementById('show-suggested-btn');
        const showActiveSuggestedBtn = document.getElementById('show-active-suggested-btn');
        const toggleAllBtn = document.getElementById('toggle-all-btn');
        const allFilterBtns = [showActiveSuggestedBtn, showSuggestedBtn, showDiscontinuedBtn];
        const modal = document.getElementById('edit-modal');
        const modalFormContainer = document.getElementById('modal-form-container');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalBackBtn = document.getElementById('modal-back-btn');
        const modalListView = document.getElementById('modal-list-view');
        const modalEditorView = document.getElementById('modal-editor-view');
        const openSuggestedModalBtn = document.getElementById('open-suggested-modal-btn');
        const suggestedProductModal = document.getElementById('suggested-product-modal');
        const suggestedProductListContainer = document.getElementById('suggested-product-list-container');
        const suggestedSaveBtn = document.getElementById('suggested-save-btn');
        const suggestedCancelBtn = document.getElementById('suggested-cancel-btn');
        const allCloseBtns = document.querySelectorAll('.close-btn');
        const suggestedCountDisplay = document.getElementById('suggested-count-display');
        const deselectAllBtn = document.getElementById('deselect-all-btn');

        // --- è®Šæ•¸å®£å‘Š (æ–°å¢ï¼šåœ“åœˆé¸å–®å°èˆª) ---
        const goToAdminBtn = document.getElementById('go-to-admin-view-btn');
        const goToCircleBtn = document.getElementById('go-to-circle-view-btn');
        const mainMenuBackBtn = document.getElementById('main-menu-back-btn');
        const productListBackBtn = document.getElementById('product-list-back-btn');
        // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½æŒ‰éˆ• ---
        const goToSuggestedViewBtn = document.getElementById('go-to-suggested-view-btn');
        const goBackToMainMenuBtn = document.getElementById('go-back-to-main-menu-btn');
        const suggestedMainMenuBackBtn = document.getElementById('suggested-main-menu-back-btn');
        const suggestedProductListBackBtn = document.getElementById('suggested-product-list-back-btn');
        const printSuggestedViewBtn = document.getElementById('print-suggested-view-btn'); // ã€æ–°å¢ã€‘


        let suggestedModalTotalCount = 0;
        let modalEditingL1Index = -1;
        let tempCategoryBranch = null;
        let originalCategoryBranchString = null;

        function renderMainCategoryManager() {
            categoryList.innerHTML = '';
            productData.forEach((category, index) => {
                const li = document.createElement('li');
                li.className = 'category-list-item';
                li.innerHTML = `
                    <span class="category-name-span">${category.name}</span>
                    <button class="btn-edit" data-index="${index}">ç·¨è¼¯çµæ§‹</button>
                    <button class="btn-delete" data-index="${index}">åˆªé™¤</button>
                `;
                categoryList.appendChild(li);
            });
        }

        function renderAll() {
            renderProductTree(); // æ›´æ–°å‚³çµ±åˆ—è¡¨
            renderMainMenu(); // æ›´æ–°åœ“åœˆé¸å–®
            updateFilterCounts(); // æ›´æ–°è¨ˆæ•¸å™¨

            // ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ å¦‚æœå»ºè­°æ›¸è³‡æ–™å·²è¼‰å…¥ï¼Œä¹ŸåŒæ­¥æ›´æ–°
            if (suggestedProductData.length > 0) {
                 // 1. é‡æ–°éæ¿¾æœ€æ–°çš„ productData
                suggestedProductData = filterDataForSuggested(JSON.parse(JSON.stringify(productData)));
                 // 2. é‡æ–°æ¸²æŸ“ L1 å»ºè­°æ›¸é¸å–® (é€™æœƒè‡ªå‹•æ›´æ–° L1 ç¸½è¡¨)
                renderSuggestedMainMenu();

                // 3. æ¸…ç†å¯èƒ½æ®˜ç•™çš„ L2 ç¸½è¡¨
                const l2SummaryContainer = document.getElementById('l2-suggested-summary-container');
                if (l2SummaryContainer) {
                    l2SummaryContainer.innerHTML = '';
                    l2SummaryContainer.style.display = 'none';
                }
            }
        }
        function updateTempDataFromForm() {
            if (!tempCategoryBranch) return;
            const newTempBranch = JSON.parse(JSON.stringify(tempCategoryBranch));

            modalFormContainer.querySelectorAll('[data-path][data-prop]').forEach(input => {
                const pathStr = input.dataset.path;
                const prop = input.dataset.prop;
                const value = input.value;
                const nodeToUpdate = getObjectByPath(newTempBranch, pathStr);
                if (nodeToUpdate) {
                    nodeToUpdate[prop] = value;
                }
            });

            modalFormContainer.querySelectorAll('[data-link-index]').forEach(input => {
                const pathStr = input.dataset.path;
                const linkIndex = parseInt(input.dataset.linkIndex);
                const linkProp = input.dataset.linkProp;
                const nodeToUpdate = getObjectByPath(newTempBranch, pathStr);
                if (nodeToUpdate && nodeToUpdate.type === 'product' && nodeToUpdate.links && nodeToUpdate.links[linkIndex]) {
                    nodeToUpdate.links[linkIndex][linkProp] = input.value;
                }
            });

            tempCategoryBranch = newTempBranch;
        }

        function createFormGroupRecursive(node, path) {
            const container = document.createElement('div');
            const group = document.createElement('div');
            group.className = 'category-form-group';

            const isCategory = node.type === 'category';

            const typeSelect = `<select class="type-select" data-path="${path}" data-prop="type"><option value="category" ${isCategory ? 'selected' : ''}>åˆ†é¡</option><option value="product" ${!isCategory ? 'selected' : ''}>å•†å“</option></select>`;
            const nameInput = `<input type="text" class="name-input" placeholder="åç¨±" value="${node.name}" data-path="${path}" data-prop="name">`;

            let otherInputs = '';
            let productLinksHTML = '';

            if (isCategory) {
                otherInputs = `
                    <div class="link-group">
                        <input type="text" placeholder="é€£çµæ–‡å­— (å¯é¸)" value="${node.linkText || ''}" data-path="${path}" data-prop="linkText">
                        <input type="text" placeholder="è¶…é€£çµç¶²å€ (å¯é¸)" value="${node.url || ''}" data-path="${path}" data-prop="url">
                    </div>
                `;
            } else {
                const status = node.status || 'active';
                otherInputs = `<select class="status-select" data-path="${path}" data-prop="status">
                                <option value="active" ${status === 'active' ? 'selected' : ''}>éŠ·å”®ä¸­</option>
                                <option value="discontinued" ${status === 'discontinued' ? 'selected' : ''}>å·²åœå”®</option>
                                <option value="suggested" ${status === 'suggested' ? 'selected' : ''}>å»ºè­°å•†å“</option>
                               </select>`;

                if (status === 'discontinued') {
                    otherInputs += `<input type="text" class="discontinued-date-input" placeholder="åœå”®æ—¥æœŸ (114.09.12)" value="${node.discontinuedDate || ''}" data-path="${path}" data-prop="discontinuedDate">`;
                }

                let linksHTML = '';
                for (let i = 0; i < 6; i++) {
                    const link = node.links ? (node.links[i] || { text: '', url: '' }) : { text: '', url: '' };
                    linksHTML += `
                        <div class="link-group">
                            <input type="text" placeholder="é€£çµæ–‡å­— ${i+1}" value="${link.text}" data-path="${path}" data-link-index="${i}" data-link-prop="text">
                            <input type="text" placeholder="è¶…é€£çµç¶²å€ ${i+1}" value="${link.url}" data-path="${path}" data-link-index="${i}" data-link-prop="url">
                        </div>
                    `;
                }
                productLinksHTML = `<div class="product-links-container">${linksHTML}</div>`;
            }

            const buttons = `${isCategory ? '<button class="btn-action btn-add-sub" data-path="'+path+'" title="æ–°å¢å­é …ç›®">ï¼‹</button>' : ''}<button class="btn-action btn-delete-sub" data-path="${path}" title="åˆªé™¤æ­¤é …ç›®">ï¼</button>`;

            group.innerHTML = typeSelect + nameInput + otherInputs + buttons;
            if(productLinksHTML){
                const linksContainerWrapper = document.createElement('div');
                linksContainerWrapper.style.flexBasis = '100%';
                linksContainerWrapper.innerHTML = productLinksHTML;
                group.appendChild(linksContainerWrapper);
            }
            container.appendChild(group);

            if (isCategory && node.children && node.children.length > 0) {
                const nestedContainer = document.createElement('div');
                nestedContainer.className = 'nested-group';
                node.children.forEach((child, index) => {
                    const newPath = path ? `${path}.children.${index}` : `children.${index}`;
                    nestedContainer.appendChild(createFormGroupRecursive(child, newPath));
                });
                container.appendChild(nestedContainer);
            }
            return container;
        }

        function handleModalClickActions(event) {
            const target = event.target;
            if (!target.classList.contains('btn-action')) return;
            updateTempDataFromForm();
            const pathStr = target.dataset.path;
            const node = getObjectByPath(tempCategoryBranch, pathStr);
            if (!node) return;

            if (target.classList.contains('btn-add-sub')) {
                if (!node.children) node.children = [];
                node.children.push({ type: 'category', name: 'æ–°åˆ†é¡', url: '', children: [] });
                buildEditForm();
            } else if (target.classList.contains('btn-delete-sub')) {
                 if (pathStr === "") {
                     alert("ç„¡æ³•åˆªé™¤æœ€é ‚å±¤åˆ†é¡ï¼Œè«‹åœ¨ä¸»ä»‹é¢æ“ä½œã€‚");
                     return;
                 }
                const path = pathStr.split('.');
                const parentPath = path.slice(0, -2).join('.');
                const parentNode = getObjectByPath(tempCategoryBranch, parentPath);
                const indexToDelete = parseInt(path[path.length - 1]);
                if (parentNode && parentNode.children) {
                    parentNode.children.splice(indexToDelete, 1);
                    buildEditForm();
                }
            }
        }

        function handleModalChangeActions(event) {
            const target = event.target;
            if (!target.dataset.path) return;

            updateTempDataFromForm();
            const pathStr = target.dataset.path;
            const node = getObjectByPath(tempCategoryBranch, pathStr);
            if (!node) return;

            if (target.dataset.prop === 'type') {
                 const newType = target.value;
                 if (newType === 'category') {
                     node.type = 'category';
                     node.children = node.children || [];
                     node.url = node.url || '';
                     node.linkText = node.linkText || '';
                     delete node.status;
                     delete node.links;
                     delete node.discontinuedDate;
                 } else {
                     node.type = 'product';
                     node.status = node.status || 'active';
                     node.links = Array(6).fill(null).map(() => ({text: '', url: ''}));
                     delete node.children;
                     delete node.url;
                     delete node.linkText;
                 }
            }

            if (target.dataset.prop === 'status') {
                if(target.value === 'active' || target.value === 'suggested') {
                    delete node.discontinuedDate;
                } else {
                    node.discontinuedDate = node.discontinuedDate || '';
                }
            }

            buildEditForm();
        }

        modalSaveBtn.addEventListener('click', () => {
            updateTempDataFromForm();
            let cleanData = JSON.parse(JSON.stringify(tempCategoryBranch));

            function cleanupData(node) {
                if (node.type === 'product') {
                    delete node.children;
                    delete node.url;
                    delete node.linkText;
                    if(node.status === 'active' || node.status === 'suggested'){
                        delete node.discontinuedDate;
                    }
                } else if (node.type === 'category') {
                    delete node.status;
                    delete node.links;
                    delete node.discontinuedDate;
                    if (node.children) {
                       node.children.forEach(cleanupData);
                    }
                }
            }
            cleanupData(cleanData);

            productData[modalEditingL1Index] = cleanData;

            saveData();
            renderAll(); // --- ä¿®æ”¹ï¼šæ›´æ–°æ‰€æœ‰è¦–åœ– ---
            showModalView('list');
        });

        function buildEditForm() {
            modalFormContainer.innerHTML = '';
            modalFormContainer.appendChild(createFormGroupRecursive(tempCategoryBranch, ''));
        }

        function getObjectByPath(obj, pathStr) {
            if (!pathStr) return obj;
            const path = pathStr.split('.');
            return path.reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : null, obj);
        }

        function showModalView(viewName) {
            if (viewName === 'list') {
                renderMainCategoryManager();
                modalListView.classList.add('active');
                modalEditorView.classList.remove('active');
            } else if (viewName === 'editor') {
                modalListView.classList.remove('active');
                modalEditorView.classList.add('active');
            }
        }

        function openModalForEditing(index) {
            modalEditingL1Index = index;
            tempCategoryBranch = JSON.parse(JSON.stringify(productData[index]));

            function ensureDataStructure(node){
                if (node.type === 'product') {
                    if (!Array.isArray(node.links)) node.links = [];
                    while(node.links.length < 6){
                        node.links.push({text:'', url:''});
                    }
                }
                if(node.children) node.children.forEach(ensureDataStructure);
            }
            ensureDataStructure(tempCategoryBranch);

            originalCategoryBranchString = JSON.stringify(tempCategoryBranch);
            buildEditForm();
            showModalView('editor');
        }

        function closeEditModal() {
            if (modalEditorView.classList.contains('active')) {
                updateTempDataFromForm();
                const currentBranchString = JSON.stringify(tempCategoryBranch);
                if (currentBranchString !== originalCategoryBranchString) {
                    if (confirm("æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦æ¨æ£„ä¸¦è¿”å›åˆ—è¡¨å—ï¼Ÿ")) {
                        showModalView('list');
                    }
                } else {
                    showModalView('list');
                }
            } else {
                modal.style.display = 'none';
            }
        }

        function forceCloseAllModals() {
            modal.style.display = 'none';
            suggestedProductModal.style.display = 'none';
            modalFormContainer.innerHTML = '';
            modalEditingL1Index = -1;
            tempCategoryBranch = null;
            originalCategoryBranchString = null;
            showModalView('list');
        }

        function filterDataRecursive(nodes) {
             const result = [];
             for (const node of nodes) {
                 if (node.type === 'category') {
                     const filteredChildren = filterDataRecursive(node.children || []);
                     if (filteredChildren.length > 0 || displayFilter.includes('discontinued')) {
                         result.push({ ...node, children: filteredChildren });
                     }
                 } else {
                     const currentStatus = node.status || 'active';
                     if (displayFilter.includes(currentStatus)) {
                         result.push(node);
                     }
                 }
             }
             return result;
         }

        function renderProductTree() {
            const filteredData = filterDataRecursive(JSON.parse(JSON.stringify(productData)));
            treeContainer.innerHTML = '';
            if(filteredData.length > 0) {
                treeContainer.appendChild(createTreeRecursive(filteredData));
            } else {
                treeContainer.innerHTML = `<p style="text-align:center; color:#6c757d;">åœ¨æ­¤æª¢è¦–æ¨¡å¼ä¸‹æ²’æœ‰å¯é¡¯ç¤ºçš„å•†å“ã€‚</p>`;
            }
        }

        /**
         * å»ºç«‹ã€Œå‚³çµ±åˆ—è¡¨ã€çš„æ¨¹ç‹€åœ– (ä¸åŒ…å«é»æ“Šäº‹ä»¶)
         * ã€*** é€™æ˜¯ç·¨è¼¯å™¨ã€Œç›®å‰ç•«é¢ã€çš„å‡½å¼ï¼Œä¿æŒåŸæ¨£ï¼Œé¡¯ç¤º EN ***ã€‘
         */
        function createTreeRecursive(nodes, level = 0) {
            const ul = document.createElement('ul');
            ul.className = level === 0 ? 'product-tree' : 'children-container';

            nodes.forEach(node => {
                const li = document.createElement('li');

                if (node.type === 'category') {
                    li.className = 'tree-node category';
                    const nameElement = `<span class="category-name">${node.name}</span>`;
                    const hasUrl = node.url && node.url.trim() !== '';
                    const hasLinkText = node.linkText && node.linkText.trim() !== '';
                    let linkElement = '';

                    if (hasUrl && hasLinkText) {
                        linkElement = `<a href="${node.url}" target="_blank" class="product-links">${node.linkText.trim()}</a>`;
                    } else if (hasUrl) {
                        linkElement = `<a href="${node.url}" target="_blank" title="é–‹å•Ÿé€£çµ: ${node.url}" class="link-icon-button">ğŸ“</a>`;
                    }

                    li.innerHTML = `<div class="category-title level-${level}"><span class="toggle-icon">${(node.children && node.children.length > 0) ? 'â–¼' : ''}</span>${nameElement}${linkElement}</div>`;

                    if (node.children && node.children.length > 0) {
                        li.appendChild(createTreeRecursive(node.children, level + 1));
                    }
                } else if (node.type === 'product') {
                    li.className = 'tree-node product-item';

                    let statusText = '';
                    switch (node.status) {
                        case 'active': statusText = 'éŠ·å”®ä¸­'; break;
                        case 'discontinued': statusText = 'å·²åœå”®'; break;
                        case 'suggested': statusText = 'å»ºè­°å•†å“'; break;
                        default: statusText = 'éŠ·å”®ä¸­';
                    }

                    if (node.status === 'discontinued' && node.discontinuedDate) {
                        statusText += ` (${node.discontinuedDate})`;
                    }

                    let linksHTML = '';
                    if (node.links && Array.isArray(node.links)) {
                        const validLinks = node.links
                            .filter(link => link.text && link.text.trim() !== '' && link.url && link.url.trim() !== '');

                        if (validLinks.length > 0) {
                            const linkContent = validLinks.map(link => {
                                // ã€ä¿æŒåŸæ¨£ã€‘
                                const isEnLink = link.text.trim().toUpperCase() === 'EN';
                                const wrapperClass = isEnLink ? 'class="link-wrapper en-link-wrapper"' : 'class="link-wrapper"';
                                return `<span ${wrapperClass}><a href="${link.url}" target="_blank">${link.text.trim()}</a></span>`;
                            }).join('');
                            linksHTML = `<span class="product-links">${linkContent}</span>`;
                        }
                    }
                    li.innerHTML = `<span class="product-name">${node.name}</span><span class="product-status ${node.status || 'active'}">${statusText}</span>${linksHTML}`;
                }

                ul.appendChild(li);
            });
            return ul;
        }

        function handleToggle(event) {
            const title = event.target.closest('.category-title');
            if (!title) return;
            if (event.target.tagName === 'A' || event.target.closest('a')) return;
            const categoryNode = title.parentNode;
            if (categoryNode.querySelector('.children-container')) {
                categoryNode.classList.toggle('collapsed');
                const icon = title.querySelector('.toggle-icon');
                if (icon) icon.textContent = categoryNode.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
            }
        }

        function handleMainManagerActions(event) {
            const target = event.target;
            if (target.dataset.index === undefined) return;
            const index = parseInt(target.dataset.index);

            if (target.classList.contains('btn-edit')) {
                openModalForEditing(index);
            } else if (target.classList.contains('btn-delete')) {
                if (confirm(`ç¢ºå®šè¦åˆªé™¤ä¸»åˆ†é¡ "${productData[index].name}" å—ï¼Ÿ`)) {
                    productData.splice(index, 1);
                    saveData();
                    renderMainCategoryManager();
                    renderAll(); // --- ä¿®æ”¹ï¼šæ›´æ–°æ‰€æœ‰è¦–åœ– ---
                }
            }
        }

        function renderSuggestedProductManager() {
            suggestedProductListContainer.innerHTML = '';
            let totalCount = 0;
            let checkedCount = 0;

            function findAndRenderProductsRecursive(nodes, parentCategoryName) {
                nodes.forEach(node => {
                    if (node.type === 'product' && (node.status === 'active' || node.status === 'suggested')) {
                        totalCount++;
                        const isSuggested = node.status === 'suggested';
                        if (isSuggested) checkedCount++;

                        const itemLabel = document.createElement('label');
                        const safeNodeName = node.name.replace(/"/g, '&quot;');
                        itemLabel.innerHTML = `<input type="checkbox" value="${safeNodeName}" ${isSuggested ? 'checked' : ''}> <span>${node.name}</span>`;
                        const container = suggestedProductListContainer.querySelector(`[data-category-name="${parentCategoryName}"]`);
                        if(container) container.appendChild(itemLabel);
                    }
                    if (node.type === 'category' && node.children) {
                        const currentCategoryName = `${parentCategoryName} > ${node.name}`;
                        const categoryContainer = document.createElement('div');
                        categoryContainer.innerHTML = `<h5>${node.name}</h5>`;
                        categoryContainer.dataset.categoryName = currentCategoryName;
                        suggestedProductListContainer.appendChild(categoryContainer);
                        findAndRenderProductsRecursive(node.children, currentCategoryName);
                        // If the category container has no product labels after recursion, remove it.
                        if (categoryContainer.querySelectorAll('label').length === 0) {
                             categoryContainer.remove();
                        }
                    }
                });
            }

            productData.forEach(mainCategory => {
                const mainCategoryContainer = document.createElement('div');
                mainCategoryContainer.innerHTML = `<h5>${mainCategory.name}</h5>`;
                mainCategoryContainer.dataset.categoryName = mainCategory.name;
                suggestedProductListContainer.appendChild(mainCategoryContainer);
                if (mainCategory.children) {
                    findAndRenderProductsRecursive(mainCategory.children, mainCategory.name);
                }
                 // If the main category container has no product labels after recursion, remove it.
                if (mainCategoryContainer.querySelectorAll('label').length === 0) {
                    mainCategoryContainer.remove();
                }
            });

            suggestedModalTotalCount = totalCount;
            updateSuggestedCountDisplay(checkedCount);

            if (totalCount === 0) {
                suggestedProductListContainer.innerHTML = '<p>æ²’æœ‰å¯è¨­å®šç‚ºå»ºè­°çš„å•†å“ (ç‹€æ…‹ç‚º "éŠ·å”®ä¸­" æˆ– "å»ºè­°")ã€‚</p>';
            }
        }

        function updateFilterCounts() {
            let activeSuggestedCount = 0, suggestedCount = 0, discontinuedCount = 0;
            function countProductsRecursive(nodes) {
                nodes.forEach(node => {
                    if (node.type === 'category' && node.children) {
                        countProductsRecursive(node.children);
                    } else if (node.type === 'product') {
                        const status = node.status || 'active';
                        if (status === 'active' || status === 'suggested') activeSuggestedCount++;
                        if (status === 'suggested') suggestedCount++;
                        if (status === 'discontinued') discontinuedCount++;
                    }
                });
            }
            countProductsRecursive(productData);
            document.getElementById('active-suggested-count').textContent = activeSuggestedCount;
            document.getElementById('suggested-count').textContent = suggestedCount;
            document.getElementById('discontinued-count').textContent = discontinuedCount;
        }

        function updateSuggestedCountDisplay(checkedCount) {
             suggestedCountDisplay.textContent = `å·²å‹¾é¸ ${checkedCount} / ç¸½è¨ˆ ${suggestedModalTotalCount}`;
        }

        function saveSuggestedProducts() {
            const checkedInputs = suggestedProductListContainer.querySelectorAll('input[type="checkbox"]:checked');
            const suggestedProductNames = new Set(Array.from(checkedInputs).map(input => input.value));

            function updateStatusRecursive(nodes) {
                nodes.forEach(node => {
                    if (node.type === 'product') {
                        if (suggestedProductNames.has(node.name)) {
                            node.status = 'suggested';
                        } else if (node.status === 'suggested') {
                            node.status = 'active';
                        }
                    }
                    if (node.children) updateStatusRecursive(node.children);
                });
            }

            updateStatusRecursive(productData);
            saveData();
            renderAll(); // --- ä¿®æ”¹ï¼šæ›´æ–°æ‰€æœ‰è¦–åœ– ---
            forceCloseAllModals();
            alert('å»ºè­°å•†å“å·²æˆåŠŸæ›´æ–°ï¼');
        }

        function toggleAll(expand) {
            const allCategories = treeContainer.querySelectorAll('.category');
            allCategories.forEach(categoryNode => {
                if (categoryNode.querySelector('.children-container')) {
                    const icon = categoryNode.querySelector('.toggle-icon');
                    if (expand) {
                        categoryNode.classList.remove('collapsed');
                        if (icon) icon.textContent = 'â–¼';
                    } else {
                        categoryNode.classList.add('collapsed');
                        if (icon) icon.textContent = 'â–¶';
                    }
                }
            });
            toggleAllBtn.textContent = expand ? 'å…¨éƒ¨æ”¶åˆ' : 'å…¨éƒ¨å±•é–‹';
            toggleAllBtn.dataset.state = expand ? 'expanded' : 'collapsed';
        }

        // ---
        // --- ã€ä¿®æ”¹ã€‘åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
        // ---
        loadData();
        loadAndApplyColors();
        updateFilter(displayFilter, showActiveSuggestedBtn); // 1. æ¸²æŸ“å‚³çµ±åˆ—è¡¨ (éš±è—)
        updateFilterCounts(); // 2. è¨ˆç®—æ•¸å­—
        renderMainMenu(); // 3. æ¸²æŸ“åœ“åœˆé¸å–®
        showView('#main-menu-view'); // 4. é¡¯ç¤ºåœ“åœˆé¸å–®

        // --- æ–°å¢ï¼šåœ“åœˆé¸å–®å°èˆªäº‹ä»¶ ---
        goToAdminBtn.addEventListener('click', () => showView('#traditional-list-view'));
        goToCircleBtn.addEventListener('click', () => showView('#main-menu-view'));
        mainMenuBackBtn.addEventListener('click', () => showView('#main-menu-view'));
        productListBackBtn.addEventListener('click', () => {
            if (currentMainIndex !== -1) showSubMenu(currentMainIndex);
        });

        // --- ã€æ–°å¢ã€‘å»ºè­°æ›¸å°è¦½äº‹ä»¶ ---
        goToSuggestedViewBtn.addEventListener('click', () => {
            // æ¯æ¬¡é»æ“Šéƒ½é‡æ–°éæ¿¾ä¸€æ¬¡ï¼Œç¢ºä¿è³‡æ–™æœ€æ–°
            suggestedProductData = filterDataForSuggested(JSON.parse(JSON.stringify(productData)));
            renderSuggestedMainMenu();
            showView('#suggested-main-menu-view');
        });
        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ è¿”å›æŒ‰éˆ•ï¼ˆå› ç‚º showView å·²ç¶“æœƒè™•ç†æ¸…ç©ºï¼Œé€™è£¡ä¸ç”¨é¡å¤–å¯«ï¼‰ ---
        goBackToMainMenuBtn.addEventListener('click', () => showView('#main-menu-view'));
        suggestedMainMenuBackBtn.addEventListener('click', () => showView('#suggested-main-menu-view'));

        suggestedProductListBackBtn.addEventListener('click', () => {
            if (currentSuggestedMainIndex !== -1) showSuggestedSubMenu(currentSuggestedMainIndex);
        });

        // --- ã€ï¼æœ¬æ¬¡ä¿®æ”¹ï¼ã€‘ å»ºè­°æ›¸åˆ—å°äº‹ä»¶ ---
        if (printSuggestedViewBtn) { // Add null check for safety
            printSuggestedViewBtn.addEventListener('click', () => {
                // 1. åœ¨ body åŠ ä¸Šæ¨™è¨˜ class
                document.body.classList.add('printing-suggested-view');
                // 2. è§¸ç™¼ç€è¦½å™¨åˆ—å°
                window.print();
                // 3. åˆ—å°çµæŸå¾Œ (ç„¡è«–æ˜¯ç¢ºèªæˆ–å–æ¶ˆ)ï¼Œç§»é™¤æ¨™è¨˜ class
                //    ä½¿ç”¨ setTimeout ç¢ºä¿åˆ—å°å°è©±æ¡†æœ‰è¶³å¤ æ™‚é–“åæ‡‰
                setTimeout(() => {
                    document.body.classList.remove('printing-suggested-view');
                }, 500);
            });
        }


        // --- åŸç‰ˆï¼šå¾Œå°ç®¡ç†äº‹ä»¶ ---
        openManagementModalBtn.addEventListener('click', () => { modal.style.display = 'block'; showModalView('list'); });
        openSuggestedModalBtn.addEventListener('click', () => { renderSuggestedProductManager(); suggestedProductModal.style.display = 'block'; });
        suggestedSaveBtn.addEventListener('click', saveSuggestedProducts);
        suggestedCancelBtn.addEventListener('click', forceCloseAllModals);

        if (deselectAllBtn) { // Add null check
            deselectAllBtn.addEventListener('click', () => {
                if (confirm("ç¢ºå®šè¦å–æ¶ˆå·²å‹¾é¸å•†å“?")) {
                    const checkboxes = suggestedProductListContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = false;
                    });
                    updateSuggestedCountDisplay(0);
                }
            });
        }

        if (suggestedProductListContainer) { // Add null check
             suggestedProductListContainer.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    const currentCheckedCount = suggestedProductListContainer.querySelectorAll('input:checked').length;
                    updateSuggestedCountDisplay(currentCheckedCount);
                }
            });
        }


        allCloseBtns.forEach(btn => btn.addEventListener('click', forceCloseAllModals));

        if (addMainCategoryBtn) { // Add null check
            addMainCategoryBtn.addEventListener('click', () => {
                const newName = prompt("è«‹è¼¸å…¥æ–°çš„ä¸»åˆ†é¡åç¨±ï¼š");
                if (newName && newName.trim()) {
                     if (productData.some(cat => cat.name === newName.trim())) {
                         alert('åˆ†é¡åç¨±å·²å­˜åœ¨ï¼');
                         return;
                     }
                     productData.push({ type: 'category', name: newName.trim(), url: '', children: [] });
                     saveData();
                     renderMainCategoryManager();
                     renderAll(); // --- ä¿®æ”¹ï¼šæ›´æ–°æ‰€æœ‰è¦–åœ– ---
                }
            });
        }


        function updateFilter(newFilter, activeBtn) {
            displayFilter = newFilter;
            allFilterBtns.forEach(btn => btn.classList.remove('active-filter'));
            if(activeBtn) activeBtn.classList.add('active-filter'); // Check if activeBtn exists
            renderProductTree();
            toggleAll(true);
        }

        if(showActiveSuggestedBtn) showActiveSuggestedBtn.addEventListener('click', () => updateFilter(['active', 'suggested'], showActiveSuggestedBtn));
        if(showSuggestedBtn) showSuggestedBtn.addEventListener('click', () => updateFilter(['suggested'], showSuggestedBtn));
        if(showDiscontinuedBtn) showDiscontinuedBtn.addEventListener('click', () => updateFilter(['discontinued'], showDiscontinuedBtn));

        if(treeContainer) treeContainer.addEventListener('click', handleToggle);
        if(categoryList) categoryList.addEventListener('click', handleMainManagerActions);
        if(modalFormContainer) modalFormContainer.addEventListener('click', handleModalClickActions);
        if(modalFormContainer) modalFormContainer.addEventListener('change', handleModalChangeActions);

        if(modalBackBtn) modalBackBtn.addEventListener('click', () => showModalView('list'));
        if(modalCancelBtn) modalCancelBtn.addEventListener('click', forceCloseAllModals);

        if(toggleAllBtn) { // Add null check
            toggleAllBtn.addEventListener('click', () => {
                const shouldExpand = toggleAllBtn.dataset.state === 'collapsed';
                toggleAll(shouldExpand);
            });
        }

        if(saveHtmlBtn) saveHtmlBtn.addEventListener('click', generateAndDownloadHtml);
        if(printBtn) { // Add null check
             printBtn.addEventListener('click', () => {
                // ã€é‡è¦ã€‘ç¢ºä¿åŸç‰ˆåˆ—å°ä¸å—å½±éŸ¿
                document.body.classList.remove('printing-suggested-view');
                window.print();
            });
        }


        // é¡è‰²é¸æ“‡å™¨
        const colorPickers = document.querySelectorAll('#color-manager input[type="color"]');
        colorPickers.forEach(picker => {
            picker.addEventListener('input', () => {
                document.documentElement.style.setProperty(picker.dataset.cssVar, picker.value);
            });
            picker.addEventListener('change', saveColorSettings); // Save on final change
        });

        // å…¨å±€é»æ“Šé—œé–‰ Modal
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                closeEditModal();
            } else if (event.target == suggestedProductModal) {
                forceCloseAllModals();
            }
        });
    });
</script>
</body>
</html>