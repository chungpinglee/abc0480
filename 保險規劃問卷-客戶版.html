<html lang="zh-Hant"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>請說說您的想法? - 情境問卷系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&amp;display=swap" rel="stylesheet">
    
    <style>
        /* 自訂樣式與動畫 */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .game-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 0.3);
            transition: max-width 0.4s ease-in-out;
        }
        
        /* 擴大資料庫頁面的寬度 */
        .game-container.db-mode {
            max-width: 900px; 
        }

        /* 畫面切換動畫 */
        .game-screen { display: none; animation: fadeIn 0.6s ease-out; }
        .game-screen.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* (新) 題庫編輯頁面樣式 */
        .qdb-container { max-height: 70vh; overflow-y: auto; padding: 0.5rem; }
        .qdb-card { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; padding: 1.5rem; }
        .qdb-card h3 { font-size: 1.25rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem; }
        .qdb-label { display: block; font-weight: 500; color: #475569; margin-bottom: 0.25rem; font-size: 0.875rem; }
        .qdb-input, .qdb-textarea, .qdb-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .qdb-input:focus, .qdb-textarea:focus, .qdb-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .qdb-textarea { min-height: 80px; }
        .qdb-options-grid { display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;}
        .qdb-options-grid .qdb-input { text-align: right; }


        /* 按鈕、進度條等其他樣式... (與前版本相同) */
        #question-text { color: #2563eb; }
        #question-desc { color: #15803d; }
        .option-btn { background-color: #ffffff; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1rem; font-size: 1rem; font-weight: 500; color: #333; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .option-btn:hover { background-color: #ef4444; border-color: #ef4444; color: #ffffff; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .option-btn.selected { background-color: #fbcfe8; color: #ef4444; border-color: #fbcfe8; font-weight: 700; transform: scale(1.05); }
        .progress-bar-container { background-color: #e0e0e0; border-radius: 99px; height: 12px; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; border-radius: 99px; transition: width 0.5s ease-out; }
        #animation-container svg { width: 3rem; height: 3rem; margin: 0 auto; }
        .income-btn { background-color: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1rem; font-size: 1.125rem; font-weight: 500; color: #333; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .income-btn:hover { background-color: #ef4444; border-color: #ef4444; color: #ffffff; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); animation: fadeInModal 0.3s ease-out; }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); position: relative; animation: slideInModal 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .modal-close-btn { color: #aaa; position: absolute; top: 1rem; right: 1rem; font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: #333; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .primary-btn { background-color: #6366f1; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .primary-btn:hover { background-color: #4f46e5; }
        .secondary-btn { background-color: #6b7280; color: white; font-weight: 500; padding: 0.75rem 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .secondary-btn:hover { background-color: #4b5563; }
        .success-btn { background-color: #10b981; color: white; font-weight: 700; }
        .success-btn:hover { background-color: #059669; }
        .danger-btn { background-color: #ef4444; color: white; font-weight: 500; }
        .danger-btn:hover { background-color: #dc2626; }
        .db-table-wrapper { max-height: 60vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; }
        .db-table { width: 100%; min-width: 700px; border-collapse: collapse; }
        .db-table th, .db-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; white-space: nowrap; }
        .db-table th { background-color: #f8f9fa; color: #4b5563; font-size: 0.875rem; text-transform: uppercase; position: sticky; top: 0; }
        .db-table .action-btn { padding: 4px 10px; border-radius: 6px; font-size: 0.875rem; margin-right: 6px; }
        /* 列印樣式 */
        @media print {
            body { background: #ffffff !important; padding: 0; margin: 0; }
            .game-container { box-shadow: none; border: none; width: 100%; max-width: 100%; border-radius: 0; }
            .game-screen:not(#result-screen) { display: none !important; }
            #result-screen { display: block !important; padding: 0 !important; }
            .max-h-60.overflow-y-auto { max-height: none !important; overflow: visible !important; }
            #result-screen .button-container, #open-explanation-btn { display: none !important; }
            .modal { display: none !important; }
            .bg-gradient-to-r.from-purple-50.to-blue-50 { background: #f8f9fa !important; box-shadow: none !important; border: 1px solid #ddd; }
            #notes-section { display: block !important; page-break-before: auto; }
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0px}.col-span-1{grid-column:span 1 / span 1}.col-span-2{grid-column:span 2 / span 2}.-mx-8{margin-left:-2rem;margin-right:-2rem}.my-2{margin-top:0.5rem;margin-bottom:0.5rem}.my-6{margin-top:1.5rem;margin-bottom:1.5rem}.-mt-8{margin-top:-2rem}.mb-10{margin-bottom:2.5rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mr-2{margin-right:0.5rem}.flex{display:flex}.grid{display:grid}.h-24{height:6rem}.h-32{height:8rem}.h-4{height:1rem}.h-40{height:10rem}.max-h-60{max-height:15rem}.max-h-\[60vh\]{max-height:60vh}.min-h-\[50px\]{min-height:50px}.min-h-\[80px\]{min-height:80px}.w-full{width:100%}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.overflow-y-auto{overflow-y:auto}.whitespace-pre-wrap{white-space:pre-wrap}.rounded-2xl{border-radius:1rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded-t-lg{border-top-left-radius:0.5rem;border-top-right-radius:0.5rem}.border{border-width:1px}.border-2{border-width:2px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-blue-700{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-purple-50{--tw-gradient-from:#faf5ff var(--tw-gradient-from-position);--tw-gradient-to:rgb(250 245 255 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-purple-600{--tw-gradient-from:#9333ea var(--tw-gradient-from-position);--tw-gradient-to:rgb(147 51 234 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-blue-50{--tw-gradient-to:#eff6ff var(--tw-gradient-to-position)}.to-blue-600{--tw-gradient-to:#2563eb var(--tw-gradient-to-position)}.bg-clip-text{-webkit-background-clip:text;background-clip:text}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.pr-4{padding-right:1rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-7xl{font-size:4.5rem;line-height:1}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-amber-900{--tw-text-opacity:1;color:rgb(120 53 15 / var(--tw-text-opacity, 1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52 / var(--tw-text-opacity, 1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206 / var(--tw-text-opacity, 1))}.text-purple-800{--tw-text-opacity:1;color:rgb(107 33 168 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-transparent{color:transparent}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.text-pink-500{--tw-text-opacity:1;color:rgb(236 72 153 / var(--tw-text-opacity, 1))}.text-cyan-500{--tw-text-opacity:1;color:rgb(6 182 212 / var(--tw-text-opacity, 1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4 / var(--tw-text-opacity, 1))}.text-purple-500{--tw-text-opacity:1;color:rgb(168 85 247 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-800:hover{--tw-bg-opacity:1;background-color:rgb(30 64 175 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.hover\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}@media (min-width: 768px){.md\:col-span-2{grid-column:span 2 / span 2}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:p-10{padding:2.5rem}.md\:p-12{padding:3rem}.md\:text-5xl{font-size:3rem;line-height:1}}</style></head>
<body>

    

    <div id="game-container" class="game-container">

        <div id="start-screen" class="game-screen p-8 md:p-12 text-center active">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600 mb-6">
                請說說您的想法?
            </h1>
            <p class="text-lg text-gray-700 mb-10">
                這是一個保險規畫需求問卷，透過一系列的選擇，來看看你的綜合分析結果吧！
            </p>
            <button id="start-btn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                我們開始吧
            </button>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                
                
                
                
                
                
            </div>
        </div>

        

        <div id="name-screen" class="game-screen p-8 md:p-12 text-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">請輸入你的稱呼</h2>
            <p class="text-lg text-gray-700 mb-10">這個稱呼將會顯示在最後的結果頁面上。</p>
            <div class="mb-6">
                <input type="text" id="name-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:border-blue-500" placeholder="例如：王大明">
                <p id="name-error" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
            <button id="name-next-btn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">下一步</button>
        </div>

        <div id="income-screen" class="game-screen p-8 md:p-12 text-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">第一步：選擇年收入</h2>
            <p class="text-lg text-gray-700 mb-10">許多情境與收入相關，請選擇你希望的假設年收入區間。</p>
            <div class="grid grid-cols-1 gap-4">
                <button class="income-btn" data-income="500000">60萬 以下</button>
                <button class="income-btn" data-income="800000">61 - 100萬</button>
                <button class="income-btn" data-income="1250000">101 - 150萬</button>
                <button class="income-btn" data-income="2000000">151萬 以上</button>
            </div>
        </div>

        <div id="game-screen" class="game-screen p-6 md:p-10">
            <div class="mb-6">
                <p id="progress-text" class="text-sm font-medium text-gray-600 mb-2 text-center">關卡 10 / 10</p>
                <div class="progress-bar-container"><div id="progress-bar" class="progress-bar-fill" style="width: 0%;"></div></div>
            </div>
            <div id="animation-container" class="w-full h-24 mb-4 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="19" r="3"></circle><circle cx="19" cy="19" r="3"></circle><path d="M10.1 6H20a2 2 0 0 1 2 2v6"></path><path d="M12 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14"></path><path d="M3 12h4"></path></svg></div>
            <div class="mb-8 min-h-[80px]">
                <h2 id="question-text" class="text-2xl font-bold text-gray-900 mb-3 text-center">情境十：長期照護</h2>
                <p id="question-desc" class="text-base text-gray-600 text-center">如果未來需要長期照護，你預期每月需要多少錢來支付開銷？</p>
            </div>
            <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"><button class="option-btn" disabled="">3萬 (外籍看護)</button><button class="option-btn selected" disabled="">5萬 (基本開銷)</button><button class="option-btn" disabled="">7萬 (本國看護)</button><button class="option-btn" disabled="">9萬以上 (含營養品等)</button></div>
        </div>

        <div id="notes-screen" class="game-screen p-8 md:p-12">
            <h2 class="text-3xl font-bold text-blue-600 mb-4 text-center">我的想法</h2>
            <p class="text-lg text-gray-700 mb-6 text-center">對於以上的規劃，您是否有其他想補充說明的地方？（可選填）</p>
            <textarea id="user-notes-area" class="w-full h-40 p-3 border-2 border-gray-300 rounded-lg text-base focus:outline-none focus:border-blue-500" placeholder="請在此輸入您的想法..."></textarea>
            <button id="notes-finish-btn" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">完成問卷，查看結果</button>
        </div>

        <div id="result-screen" class="game-screen p-6 md:p-10">
            <h2 class="text-3xl font-bold text-center text-blue-800 mb-6">GRRY的綜合分析結果！</h2>
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-2xl shadow-inner mb-8 text-center">
                <p class="text-base font-medium text-purple-800">你的綜合得分為</p>
                <p id="total-score" class="text-7xl font-bold text-purple-700 my-2">170</p>
                <div class="mt-4">
                    <p class="text-lg font-bold text-gray-800">你的分析類型</p>
                    <p id="score-analysis" class="text-xl font-bold text-blue-600">隨遇而安型</p>
                </div>
                <p id="analysis-desc" class="text-sm text-gray-600 mt-2">你傾向於活在當下，認為船到橋頭自然直。</p>
                <p class="text-sm text-gray-600 mt-4">年收入假設： <b id="result-income" class="text-gray-800">60萬 以下</b></p>
                <p class="text-sm text-gray-600 mt-2">填寫時間： <b id="result-date" class="text-gray-800">民國 114 年 10 月 24 日</b></p>
            </div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-green-800">得分詳情</h3>
                <button id="open-explanation-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium">計分說明</button>
            </div>
            <div class="max-h-60 overflow-y-auto rounded-lg border border-gray-200">
                <table id="result-table" class="w-full text-left">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="text-sm font-semibold text-amber-900">關卡</th>
                            <th class="text-sm font-semibold text-amber-900">你的選擇</th>
                            <th class="text-sm font-semibold text-amber-900 text-right">得分</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body"><tr><td class="text-sm text-gray-700">情境一：生病住院</td><td class="text-sm text-gray-600">雙人房 (兼顧預算與品質)</td><td class="text-sm font-medium text-gray-900 text-right">20</td></tr><tr><td class="text-sm text-gray-700">情境二：收入補貼</td><td class="text-sm text-gray-600">2,000元</td><td class="text-sm font-medium text-gray-900 text-right">10</td></tr><tr><td class="text-sm text-gray-700">情境三：癌症津貼</td><td class="text-sm text-gray-600">3,000元</td><td class="text-sm font-medium text-gray-900 text-right">20</td></tr><tr><td class="text-sm text-gray-700">情境四：新式手術</td><td class="text-sm text-gray-600">10萬以內</td><td class="text-sm font-medium text-gray-900 text-right">10</td></tr><tr><td class="text-sm text-gray-700">情境五：手術津貼</td><td class="text-sm text-gray-600">2 個月收入 (約 8 萬)</td><td class="text-sm font-medium text-gray-900 text-right">20</td></tr><tr><td class="text-sm text-gray-700">情境六：意外門診</td><td class="text-sm text-gray-600">8萬</td><td class="text-sm font-medium text-gray-900 text-right">30</td></tr><tr><td class="text-sm text-gray-700">情境七：骨折補貼</td><td class="text-sm text-gray-600">2 個月收入 (約 8 萬)</td><td class="text-sm font-medium text-gray-900 text-right">10</td></tr><tr><td class="text-sm text-gray-700">情境八：家庭責任</td><td class="text-sm text-gray-600">300萬</td><td class="text-sm font-medium text-gray-900 text-right">20</td></tr><tr><td class="text-sm text-gray-700">情境九：重大疾病</td><td class="text-sm text-gray-600">50萬</td><td class="text-sm font-medium text-gray-900 text-right">10</td></tr><tr><td class="text-sm text-gray-700">情境十：長期照護</td><td class="text-sm text-gray-600">5萬 (基本開銷)</td><td class="text-sm font-medium text-gray-900 text-right">20</td></tr></tbody>
                </table>
            </div>
            <div id="notes-section" class="mt-8" style="display: block;">
                <h3 class="text-xl font-bold text-green-800 mb-3">客戶備註</h3>
                <p id="result-notes" class="text-base text-gray-700 bg-gray-50 border border-gray-200 rounded-lg p-4 min-h-[50px] whitespace-pre-wrap">FBGFB</p>
            </div>
            <div class="button-container grid grid-cols-2 gap-4 mt-8">
                <button id="print-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl text-base shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300">列印本頁自存</button>
                <button id="restart-btn" class="w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-xl text-base shadow-lg hover:bg-gray-800 transform hover:scale-105 transition-all duration-300">返回首頁</button>
                <button id="open-export-btn" class="col-span-2 w-full success-btn font-bold py-3 px-6 rounded-xl text-base shadow-lg hover:bg-green-600 transform hover:scale-105 transition-all duration-300">產生代碼(請貼到LINE，傳給顧問)</button>
            </div>
        </div>
        
        

    </div>

    <div id="explanation-modal" class="modal" style="display: none;"><div class="modal-content"><span id="close-explanation-btn" class="modal-close-btn">×</span><h3 class="text-2xl font-bold text-blue-600 bg-gray-100 p-4 rounded-t-lg -mx-8 -mt-8 mb-6 text-center">計分方式說明</h3><div id="modal-body" class="max-h-[60vh] overflow-y-auto pr-4">
                    <p class="text-gray-700 mb-4">總分是根據您在 10 個情境中的選擇加總而來。</p>
                    <p class="text-gray-700 mb-4">每個選項的分數從 10分 (最低規劃) 到 40分 (最高規劃) 不等，代表您對該情境的風險規劃偏好程度。</p>
                    <p class="text-gray-700 mb-6">以目前啟用的 10 個問題計算，分數範圍為：</p>
                    <ul class="list-disc list-inside space-y-3 bg-gray-50 p-4 rounded-lg">
                        <li><b><span class="text-purple-700">最低總分：</span></b> 100 分 ( 10 x 10分 )</li>
                        <li><b><span class="text-purple-700">最高總分：</span></b> 400 分 ( 10 x 40分 )</li>
                    </ul>
                    <hr class="my-6">
                    <h4 class="text-lg font-bold text-green-800 mb-3">分析類型判定標準 (依總分區間)：</h4>
                    <div class="space-y-2">
                        <p><b><span class="text-purple-700">隨遇而安型：</span></b> 100 - 175 分</p>
                        <p><b><span class="text-purple-700">穩健平衡型：</span></b> 176 - 280 分</p>
                        <p><b><span class="text-purple-700">深思熟慮型：</span></b> 281 - 370 分</p>
                        <p><b><span class="text-purple-700">萬全準備型：</span></b> 371 - 400 分</p>
                    </div>
                </div></div></div>
    
    
    
    <div id="export-modal" class="modal" style="display: none;"><div class="modal-content"><span id="close-export-btn" class="modal-close-btn">×</span><h3 class="text-2xl font-bold text-green-600 mb-4 text-center">產生分享代碼</h3><p class="text-gray-600 text-center mb-4">請複製以下代碼，並傳送給您的顧問：</p><textarea id="export-code-area" class="w-full h-32 p-3 border border-gray-300 rounded-lg bg-gray-50" readonly=""></textarea><p id="copy-success" class="text-green-600 text-sm mt-2 h-4 text-center">已成功複製！</p><button id="copy-code-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg hover:bg-green-600 transition-all duration-300">複製代碼</button></div></div>

    <script>
        // --- 預設題庫資料庫 (共 20 個情境) ---
        // 這是系統的預設值。實際使用的題庫會從瀏覽器儲存 (Local Storage) 中讀取，如果沒有儲存過，則使用此預設值。
        let QUESTIONS_DATABASE = [
            { id: 'q1', disabled: false, question: "情境一：生病住院", description: "如果生病住院，在可以選擇的情況下，你會希望住什麼等級的病房？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7"></path><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2"></path><path d="M7 7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2"></path></svg>`, type: 'static', options: [ { text: "健保房 (省錢為主)", score: 10 }, { text: "雙人房 (兼顧預算與品質)", score: 20 }, { text: "單人房 (需要安靜休養)", score: 30 }, { text: "特等房 (最高享受)", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q2', disabled: false, question: "情境二：收入補貼", description: "住院期間，希望每天有多少「收入補貼」？(用來支付薪水損失、看護費等)", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M12 16h.01" /><path d="M12 12h.01" /><path d="m15.5 16-.7.7-2.8-2.8" /><path d="m8.8 15.3.7.7 2-2" /></svg>`, type: 'static', options: [ { text: "2,000元", score: 10 }, { text: "3,000元", score: 20 }, { text: "5,000元", score: 30 }, { text: "8,000元 以上", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q3', disabled: false, question: "情境三：癌症津貼", description: "若因「癌症或重大傷病」住院，希望每日津貼『再增加』多少？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 3A5 5 0 0 0 9 8.5c0 .7.1 1.4.3 2L4 16v3h3l6.5-6.5c.6.2 1.3.3 2 .3a5 5 0 0 0 5-5c0-2.8-2.2-5-5-5Z"/><path d="m12 15 3.5 3.5"/><path d="M19 8.5V12h3.5"/></svg>`, type: 'static', options: [ { text: "2,000元", score: 10 }, { text: "3,000元", score: 20 }, { text: "5,000元", score: 30 }, { text: "8,000元 以上", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q4', disabled: false, question: "情境四：新式手術", description: "醫生說有一種新式手術，效果好但需自費。你願意接受的自費上限是？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`, type: 'static', options: [ { text: "10萬以內", score: 10 }, { text: "20萬", score: 20 }, { text: "30萬", score: 30 }, { text: "50萬以上，效果好就行", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q5', disabled: false, question: "情境五：手術津貼", description: "若住院動手術，依嚴重性，希望最多可有多少個月的收入作為術後休養津貼?", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-cyan-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.6 12.2-6.4 6.4-6.4-6.4 6.4-6.4 6.4 6.4Z"/><path d="m21.6 12.2-6.4 6.4-6.4-6.4 6.4-6.4 6.4 6.4Z" transform="translate(-10.8 0)"/><path d="m12.2 21.6-6.4-6.4 6.4-6.4 6.4 6.4-6.4 6.4Z"/><path d="m12.2 21.6-6.4-6.4 6.4-6.4 6.4 6.4-6.4 6.4Z" transform="translate(0 -10.8)"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`, type: 'dynamicIncome', options: [ { text: "", score: 0 }, { text: "", score: 0 }, { text: "", score: 0 }, { text: "", score: 0 } ], dynamicOptions: [ [1,10], [2,20], [3,30], [6,40] ] },
            { id: 'q6', disabled: false, question: "情境六：意外門診", description: "若因意外受傷看門診(無住院)，您希望自費醫材的理賠額度是多少？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-yellow-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.6 21.4 12 11 8.4 4.6a2 2 0 0 0-3.8 0L1 11l5.6 10.4A2 2 0 0 0 8.4 22H15.6a2 2 0 0 0 2-0.6z"/><path d="m8 11 4 6 4-6"/><path d="M12 22V17"/></svg>`, type: 'static', options: [ { text: "3萬", score: 10 }, { text: "5萬", score: 20 }, { text: "8萬", score: 30 }, { text: "10萬以上", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q7', disabled: false, question: "情境七：骨折補貼", description: "若發生骨折(如手臂骨折)，依嚴重程度，您希望最多可有多少個月的收入作為休養補貼？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20h2"/><path d="M11 14h2"/><path d="M11 8h2"/><path d="M15 4h2a2 2 0 0 1 2 2v2"/><path d="M15 20h2a2 2 0 0 0 2-2v-2"/><path d="M9 4H7a2 2 0 0 0-2 2v2"/><path d="M9 20H7a2 2 0 0 1-2-2v-2"/><line x1="14" y1="12" x2="10" y2="12" /></svg>`, type: 'dynamicIncome', options: [ { text: "", score: 0 }, { text: "", score: 0 }, { text: "", score: 0 }, { text: "", score: 0 } ], dynamicOptions: [ [2,10], [4,20], [6,30], [12,40] ] },
            { id: 'q8', disabled: false, question: "情境八：家庭責任", description: "你認為如果自己發生萬一，需要留給家人多少「生活預備金」才安心？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`, type: 'static', options: [ { text: "100萬", score: 10 }, { text: "300萬", score: 20 }, { text: "500萬", score: 30 }, { text: "1000萬以上", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q9', disabled: false, question: "情境九：重大疾病", description: "當面對癌症或重大疾病時，你認為需要準備多少「一次性給付」的醫療基金才會有安全感？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path><path d="M10 11h4" /><path d="M12 9v4" /></svg>`, type: 'static', options: [ { text: "50萬", score: 10 }, { text: "100萬", score: 20 }, { text: "200萬", score: 30 }, { text: "300萬以上", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q10', disabled: false, question: "情境十：長期照護", description: "如果未來需要長期照護，你預期每月需要多少錢來支付開銷？", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="19" r="3"/><circle cx="19" cy="19" r="3"/><path d="M10.1 6H20a2 2 0 0 1 2 2v6"/><path d="M12 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14"/><path d="M3 12h4"/></svg>`, type: 'static', options: [ { text: "3萬 (外籍看護)", score: 10 }, { text: "5萬 (基本開銷)", score: 20 }, { text: "7萬 (本國看護)", score: 30 }, { text: "9萬以上 (含營養品等)", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q11', disabled: true, question: "情境十一：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q12', disabled: true, question: "情境十二：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q13', disabled: true, question: "情境十三：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q14', disabled: true, question: "情境十四：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q15', disabled: true, question: "情境十五：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q16', disabled: true, question: "情境十六：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q17', disabled: true, question: "情境十七：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q18', disabled: true, question: "情境十八：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q19', disabled: true, question: "情境十九：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q20', disabled: true, question: "情境二十：(尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
        ];
        
        // --- 全域變數與常數 ---
        const CLIENT_DB_KEY = 'clientQuestionnaireDB';
        const QUESTION_BANK_DB_KEY = 'questionBankDB';
        let clientDatabase = [];
        let activeQuestions = [];
        let userAnswers = [], totalScore = 0, userAnnualIncome = 0, userMonthlyIncome = 0;
        let userName = "", completionDate = "", userNotes = "";
        let currentQuestionIndex = 0;

        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM 元素 ---
            const allElements = {
                gameContainer: document.getElementById('game-container'),
                startScreen: document.getElementById('start-screen'),
                nameScreen: document.getElementById('name-screen'),
                incomeScreen: document.getElementById('income-screen'),
                gameScreen: document.getElementById('game-screen'),
                notesScreen: document.getElementById('notes-screen'),
                resultScreen: document.getElementById('result-screen'),
                databaseScreen: document.getElementById('database-screen'),
                questionDbScreen: document.getElementById('question-db-screen'), // 新
                startBtn: document.getElementById('start-btn'),
                nameInput: document.getElementById('name-input'),
                nameNextBtn: document.getElementById('name-next-btn'),
                nameError: document.getElementById('name-error'),
                incomeBtns: document.querySelectorAll('.income-btn'),
                notesTextArea: document.getElementById('user-notes-area'),
                notesFinishBtn: document.getElementById('notes-finish-btn'),
                restartBtn: document.getElementById('restart-btn'),
                printBtn: document.getElementById('print-btn'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                animationContainer: document.getElementById('animation-container'),
                questionText: document.getElementById('question-text'),
                questionDesc: document.getElementById('question-desc'),
                optionsGrid: document.getElementById('options-grid'),
                totalScoreEl: document.getElementById('total-score'),
                scoreAnalysisEl: document.getElementById('score-analysis'),
                analysisDescEl: document.getElementById('analysis-desc'),
                resultIncomeEl: document.getElementById('result-income'),
                resultDateEl: document.getElementById('result-date'),
                resultTableBody: document.getElementById('result-table-body'),
                notesSection: document.getElementById('notes-section'),
                resultNotesEl: document.getElementById('result-notes'),
                // Modals
                explanationModal: document.getElementById('explanation-modal'),
                openExplanationBtn: document.getElementById('open-explanation-btn'),
                closeExplanationBtn: document.getElementById('close-explanation-btn'),
                importModal: document.getElementById('import-modal'),
                openImportBtn: document.getElementById('open-import-btn'),
                closeImportBtn: document.getElementById('close-import-btn'),
                importCodeArea: document.getElementById('import-code-area'),
                importLoadBtn: document.getElementById('import-load-btn'),
                importError: document.getElementById('import-error'),
                exportModal: document.getElementById('export-modal'),
                openExportBtn: document.getElementById('open-export-btn'),
                closeExportBtn: document.getElementById('close-export-btn'),
                exportCodeArea: document.getElementById('export-code-area'),
                copyCodeBtn: document.getElementById('copy-code-btn'),
                copySuccess: document.getElementById('copy-success'),
                // Client DB elements
                openDbBtn: document.getElementById('open-db-btn'),
                dbBackBtn: document.getElementById('db-back-btn'),
                dbTableBody: document.getElementById('db-table-body'),
                exportCsvBtn: document.getElementById('export-csv-btn'),
                clearDbBtn: document.getElementById('clear-db-btn'),
                csvImportInput: document.getElementById('csv-import-input'),
                importCsvBtn: document.getElementById('import-csv-btn'),
                // Question DB elements (新)
                openQdbBtn: document.getElementById('open-qdb-btn'),
                qdbBackBtn: document.getElementById('qdb-back-btn'),
                qdbSaveBtn: document.getElementById('qdb-save-btn'),
                qdbResetBtn: document.getElementById('qdb-reset-btn'),
                qdbContainer: document.getElementById('qdb-questions-container'),
                
                // (★★★★★ 新增：另存HTML按鈕)
                saveClientHtmlBtn: document.getElementById('save-client-html-btn')
            };

            const originalDocumentTitle = document.title; // (★★★★★ 新增：儲存原始標題)

            // --- (新) 題庫管理功能 ---
            function loadQuestionDatabase() {
                const storedQuestions = localStorage.getItem(QUESTION_BANK_DB_KEY);
                if (storedQuestions) {
                    try {
                        QUESTIONS_DATABASE = JSON.parse(storedQuestions);
                    } catch (e) {
                        console.error("無法解析儲存的題庫，將使用預設題庫。", e);
                        // 如果解析失敗，保留預設值
                    }
                }
            }

            function saveQuestionDatabase() {
                const newDb = [];
                const questionCards = allElements.qdbContainer.querySelectorAll('.qdb-card');
                
                questionCards.forEach((card, index) => {
                    const qData = { id: `q${index + 1}` };
                    qData.disabled = !card.querySelector(`[data-q-index="${index}"][data-prop="disabled"]`).checked;
                    qData.question = card.querySelector(`[data-q-index="${index}"][data-prop="question"]`).value;
                    qData.description = card.querySelector(`[data-q-index="${index}"][data-prop="description"]`).value;
                    qData.animationSvg = card.querySelector(`[data-q-index="${index}"][data-prop="animationSvg"]`).value;
                    qData.type = card.querySelector(`[data-q-index="${index}"][data-prop="type"]`).value;
                    
                    qData.options = [];
                    for (let i = 0; i < 4; i++) {
                        qData.options.push({
                            text: card.querySelector(`[data-q-index="${index}"][data-opt-index="${i}"][data-prop="text"]`).value,
                            score: parseInt(card.querySelector(`[data-q-index="${index}"][data-opt-index="${i}"][data-prop="score"]`).value, 10) || 0,
                        });
                    }

                    qData.dynamicOptions = [];
                    for (let i = 0; i < 4; i++) {
                        qData.dynamicOptions.push([
                            parseInt(card.querySelector(`[data-q-index="${index}"][data-d-opt-index="${i}"][data-prop="months"]`).value, 10) || 0,
                            parseInt(card.querySelector(`[data-q-index="${index}"][data-d-opt-index="${i}"][data-prop="d-score"]`).value, 10) || 0,
                        ]);
                    }
                    newDb.push(qData);
                });

                QUESTIONS_DATABASE = newDb;
                localStorage.setItem(QUESTION_BANK_DB_KEY, JSON.stringify(QUESTIONS_DATABASE));
                alert("題庫已成功儲存！");
            }

            function populateQuestionEditor() {
                allElements.qdbContainer.innerHTML = '';
                QUESTIONS_DATABASE.forEach((q, index) => {
                    const card = document.createElement('div');
                    card.className = 'qdb-card';
                    let optionsHtml = '';
                    let dynamicOptionsHtml = '';

                    for (let i=0; i<4; i++) {
                        optionsHtml += `
                            <div class="qdb-options-grid">
                                <input type="text" class="qdb-input" value="${q.options[i]?.text || ''}" data-q-index="${index}" data-opt-index="${i}" data-prop="text" placeholder="選項 ${i+1} 文字">
                                <input type="number" class="qdb-input" value="${q.options[i]?.score || 0}" data-q-index="${index}" data-opt-index="${i}" data-prop="score">
                            </div>`;
                        dynamicOptionsHtml += `
                             <div class="qdb-options-grid">
                                <input type="number" class="qdb-input" value="${q.dynamicOptions[i]?.[0] || 0}" data-q-index="${index}" data-d-opt-index="${i}" data-prop="months" placeholder="月數">
                                <input type="number" class="qdb-input" value="${q.dynamicOptions[i]?.[1] || 0}" data-q-index="${index}" data-d-opt-index="${i}" data-prop="d-score" placeholder="分數">
                            </div>`;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3>情境 ${index + 1}</h3>
                            <div class="flex items-center">
                                <label for="q-enabled-${index}" class="qdb-label mr-2">啟用此問題</label>
                                <input type="checkbox" id="q-enabled-${index}" ${!q.disabled ? 'checked' : ''} data-q-index="${index}" data-prop="disabled">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="qdb-label">問題標題</label>
                                <input type="text" class="qdb-input" value="${q.question}" data-q-index="${index}" data-prop="question">
                            </div>
                            <div>
                                <label class="qdb-label">問題類型</label>
                                <select class="qdb-select" data-q-index="${index}" data-prop="type">
                                    <option value="static" ${q.type === 'static' ? 'selected' : ''}>靜態選項</option>
                                    <option value="dynamicIncome" ${q.type === 'dynamicIncome' ? 'selected' : ''}>動態收入選項</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="qdb-label">問題描述</label>
                                <textarea class="qdb-textarea" data-q-index="${index}" data-prop="description">${q.description}</textarea>
                            </div>
                             <div class="md:col-span-2">
                                <label class="qdb-label">SVG 圖示程式碼</label>
                                <textarea class="qdb-textarea" data-q-index="${index}" data-prop="animationSvg">${q.animationSvg}</textarea>
                            </div>
                            <div>
                                <label class="qdb-label">靜態選項 (文字 / 分數)</label>
                                ${optionsHtml}
                            </div>
                             <div>
                                <label class="qdb-label">動態選項 (月數 / 分數)</label>
                                ${dynamicOptionsHtml}
                            </div>
                        </div>
                    `;
                    allElements.qdbContainer.appendChild(card);
                });
            }
            
            function resetQuestionDatabase() {
                if (confirm("您確定要重置為系統預設的題庫嗎？所有已儲存的修改將會遺失。")) {
                    localStorage.removeItem(QUESTION_BANK_DB_KEY);
                    alert("題庫已重置。頁面將會重新整理。");
                    location.reload();
                }
            }


            // --- 遊戲邏輯 ---
            function showScreen(screenElement) {
                document.querySelectorAll('.game-screen').forEach(screen => screen.classList.remove('active'));
                screenElement.classList.add('active');
            }

            // (★★★★★ 已修改：加入確認警語)
            function goBackToStart() {
                if (!confirm("所有問卷資料將清除，要繼續嗎?")) {
                    return; // 如果使用者按下「取消」，則中止函式
                }
                
                userName = "";
                allElements.nameInput.value = "";
                completionDate = "";
                userNotes = "";
                allElements.notesTextArea.value = "";
                allElements.gameContainer.classList.remove('db-mode');
                showScreen(allElements.startScreen);
                allElements.progressBar.style.width = `0%`;
            }

            function selectIncome(income) {
                userAnnualIncome = income;
                userMonthlyIncome = Math.round(income / 12);
                activeQuestions = QUESTIONS_DATABASE.filter(q => !q.disabled);
                currentQuestionIndex = 0; userAnswers = []; totalScore = 0; completionDate = ""; userNotes = "";
                if (activeQuestions.length === 0) {
                    alert("錯誤：沒有可用的問題。請在題庫編輯中至少啟用一個問題。");
                    return;
                }
                showScreen(allElements.gameScreen);
                showQuestion(currentQuestionIndex);
            }

            function showQuestion(index) {
                const question = activeQuestions[index];
                allElements.progressText.textContent = `關卡 ${index + 1} / ${activeQuestions.length}`;
                allElements.progressBar.style.width = `${((index + 1) / activeQuestions.length) * 100}%`;
                allElements.animationContainer.innerHTML = question.animationSvg;
                allElements.questionText.textContent = question.question;
                allElements.questionDesc.textContent = question.description;
                allElements.optionsGrid.innerHTML = '';
                
                const optionsToShow = (question.type === 'dynamicIncome' ? question.dynamicOptions : question.options);
                optionsToShow.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    let text, score;
                    if(question.type === 'dynamicIncome') {
                        const [months, s] = option;
                        const amountInTenThousands = Math.round((userMonthlyIncome * months) / 10000);
                        text = `${months} 個月收入 (約 ${amountInTenThousands} 萬)`;
                        score = s;
                    } else {
                        text = option.text;
                        score = option.score;
                    }
                    button.textContent = text;
                    button.onclick = (e) => selectAnswer(score, text, e.currentTarget);
                    allElements.optionsGrid.appendChild(button);
                });
            }

            function selectAnswer(score, text, selectedButton) {
                userAnswers.push({ question: activeQuestions[currentQuestionIndex].question, text, score });
                totalScore += score;
                allElements.optionsGrid.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                selectedButton.classList.add('selected');
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < activeQuestions.length) {
                        showQuestion(currentQuestionIndex);
                    } else {
                        showScreen(allElements.notesScreen);
                    }
                }, 700);
            }

            function getAnalysis(score) {
                // (★★★★★ 修正：確保 activeQuestions 有效)
                const numQuestions = activeQuestions.length > 0 ? activeQuestions.length : QUESTIONS_DATABASE.filter(q => !q.disabled).length;
                if (numQuestions === 0) return { analysis: "無資料", description: "題庫中沒有啟用的問題。" };

                const maxScore = numQuestions * 40;
                const minScore = numQuestions * 10;
                const range = maxScore - minScore;
                const level1Max = minScore + (range * 0.25);
                const level2Max = minScore + (range * 0.60);
                const level3Max = minScore + (range * 0.90);
                let analysis, description;
                if (score <= level1Max) { analysis = "隨遇而安型"; description = "你傾向於活在當下，認為船到橋頭自然直。"; } 
                else if (score <= level2Max) { analysis = "穩健平衡型"; description = "你兼顧當下與未來，是個務實的規劃者。"; } 
                else if (score <= level3Max) { analysis = "深思熟慮型"; description = "你對風險有高度警覺，希望做好萬全準備。"; } 
                else { analysis = "萬全準備型"; description = "你追求最高標準的安全感，不確定性降到最低。"; }
                return { analysis, description };
            }
            
            function showResults() {
                allElements.gameContainer.classList.remove('db-mode');
                showScreen(allElements.resultScreen);
                allElements.resultScreen.querySelector('h2').textContent = `${userName}的綜合分析結果！`;
                allElements.totalScoreEl.textContent = totalScore;
                const { analysis, description } = getAnalysis(totalScore);
                allElements.scoreAnalysisEl.textContent = analysis;
                allElements.analysisDescEl.textContent = description;
                allElements.resultIncomeEl.textContent = {500000: "60萬 以下", 800000: "61 - 100萬", 1250000: "101 - 150萬", 2000000: "151萬 以上"}[userAnnualIncome] || `${userAnnualIncome.toLocaleString()} 元`;
                if (!completionDate) {
                    const today = new Date();
                    completionDate = `民國 ${today.getFullYear() - 1911} 年 ${today.getMonth() + 1} 月 ${today.getDate()} 日`;
                }
                allElements.resultDateEl.textContent = completionDate;
                allElements.resultTableBody.innerHTML = userAnswers.map(ans => `<tr><td class="text-sm text-gray-700">${ans.question}</td><td class="text-sm text-gray-600">${ans.text}</td><td class="text-sm font-medium text-gray-900 text-right">${ans.score}</td></tr>`).join('');
                allElements.resultNotesEl.textContent = userNotes && userNotes.length > 0 ? userNotes : '無';
                allElements.notesSection.style.display = 'block';
            }
            
            // --- 客戶資料庫與匯出入功能 (與前版本類似) ---
            function loadClientDatabase() {
                const dbJson = localStorage.getItem(CLIENT_DB_KEY);
                clientDatabase = dbJson ? JSON.parse(dbJson) : [];
            }
            function saveClientDatabase() {
                localStorage.setItem(CLIENT_DB_KEY, JSON.stringify(clientDatabase));
            }
            // ... (其他客戶資料庫、CSV、代碼匯入匯出等功能與前版本相同)
            function handleCsvImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let csvText = e.target.result;
                        if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.substring(1);
                        parseCSVToDatabase(csvText);
                    } catch (err) { alert("讀取檔案時發生錯誤: " + err.message); }
                };
                reader.readAsText(file, 'UTF-8');
            }
            function parseCSVToDatabase(csvText) {
                const lines = csvText.split(/\r\n|\n/).slice(1);
                let importedCount = 0, skippedCount = 0;
                lines.forEach((line, i) => {
                    if (line.trim() === "") return;
                    const fields = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(f => f.startsWith('"') && f.endsWith('"') ? f.substring(1, f.length-1).replace(/""/g, '"') : f);
                    if (fields.length < 6 || fields[0] === "") return;
                    const [clientName, completionDate] = fields;
                    if (clientDatabase.some(c => c.userName === clientName && c.completionDate === completionDate)) {
                        skippedCount++; return;
                    }
                    const newClient = {
                        id: Date.now().toString() + i, userName: clientName, completionDate,
                        userAnnualIncome: { "60萬 以下": 500000, "61 - 100萬": 800000, "101 - 150萬": 1250000, "151萬 以上": 2000000 }[fields[2]] || 0,
                        totalScore: parseInt(fields[3], 10) || 0, analysisType: fields[4], userNotes: fields[5] || "", userAnswers: []
                    };
                    for (let j = 0; j < 20; j++) {
                        const [q, a, s] = [fields[6 + j*3], fields[7 + j*3], fields[8 + j*3]];
                        if (!q || q === "") break;
                        newClient.userAnswers.push({ question: q, text: a || "", score: parseInt(s, 10) || 0 });
                    }
                    if (newClient.userAnswers.length > 0) { clientDatabase.push(newClient); importedCount++; }
                });
                saveClientDatabase();
                populateClientDatabaseTable();
                alert(`CSV 匯入完成。\n成功匯入 ${importedCount} 筆新資料。\n${skippedCount} 筆重複資料已略過。`);
            }
            function populateClientDatabaseTable() {
                allElements.dbTableBody.innerHTML = '';
                if (clientDatabase.length === 0) {
                    allElements.dbTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">目前沒有任何客戶資料。</td></tr>'; return;
                }
                [...clientDatabase].reverse().forEach(client => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="font-medium">${client.userName}</td><td>${client.completionDate}</td><td>${{500000:"60萬 以下",800000:"61 - 100萬",1250000:"101 - 150萬",2000000:"151萬 以上"}[client.userAnnualIncome] || 'N/A'}</td><td class="font-medium text-blue-600">${client.totalScore}</td><td>${client.analysisType}</td><td><button class="action-btn primary-btn view-report-btn" data-id="${client.id}">查看</button><button class="action-btn danger-btn delete-entry-btn" data-id="${client.id}">刪除</button></td>`;
                    allElements.dbTableBody.appendChild(tr);
                });
                allElements.dbTableBody.querySelectorAll('.view-report-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const clientData = clientDatabase.find(c => c.id === e.target.dataset.id);
                    if(clientData) { userName = clientData.userName; userAnnualIncome = clientData.userAnnualIncome; userAnswers = clientData.userAnswers; completionDate = clientData.completionDate; totalScore = clientData.totalScore; userNotes = clientData.userNotes || ""; userMonthlyIncome = Math.round(userAnnualIncome / 12); showResults(); }
                }));
                allElements.dbTableBody.querySelectorAll('.delete-entry-btn').forEach(btn => btn.addEventListener('click', (e) => {
                     if (confirm("您確定要刪除這筆客戶資料嗎？")) { clientDatabase = clientDatabase.filter(c => c.id !== e.target.dataset.id); saveClientDatabase(); populateClientDatabaseTable(); }
                }));
            }
            function generateExportCode() {
                try {
                    return btoa(encodeURIComponent(JSON.stringify({ userName, userAnnualIncome, userAnswers, completionDate, userNotes })));
                } catch (e) { return "產生代碼時發生錯誤。"; }
            }

            // --- (匯入代碼處理函式) ---
            function handleImportCode() {
                const code = allElements.importCodeArea.value.trim();
                if (code === "") {
                    allElements.importError.textContent = "請貼上代碼。";
                    return;
                }
                try {
                    allElements.importError.textContent = ""; // 清除舊錯誤
                    const decodedJson = decodeURIComponent(atob(code));
                    const data = JSON.parse(decodedJson);
                    
                    if (!data.userName || !data.userAnswers || !data.completionDate) {
                        throw new Error("代碼格式不正確。");
                    }

                    // 載入資料
                    userName = data.userName;
                    userAnnualIncome = data.userAnnualIncome;
                    userAnswers = data.userAnswers;
                    completionDate = data.completionDate;
                    userNotes = data.userNotes || "";
                    userMonthlyIncome = Math.round(userAnnualIncome / 12);
                    
                    // 重新計算總分
                    totalScore = userAnswers.reduce((acc, ans) => acc + (ans.score || 0), 0);
                    
                    // (★★★★★ 修正：確保 activeQuestions 被設置，以便 getAnalysis 能運作)
                    // 我們從匯入的答案數量來反推當時啟用的問題數量
                    activeQuestions = data.userAnswers.map((ans, i) => ({
                        id: `q${i+1}`, // 這是個假設的id，但對計分不影響
                        question: ans.question,
                        // ... 其他屬性在計分時用不到
                    }));

                    // 顯示結果
                    showResults();
                    allElements.importModal.style.display = 'none';
                    
                    // (可選) 詢問是否存入資料庫
                    if (confirm("匯入成功！您是否要將這筆資料儲存到本機的客戶資料庫中？")) {
                        const { analysis, _ } = getAnalysis(totalScore);
                        const newClientEntry = {
                            id: Date.now().toString(),
                            userName: userName,
                            completionDate: completionDate,
                            userAnnualIncome: userAnnualIncome,
                            totalScore: totalScore,
                            analysisType: analysis,
                            userNotes: userNotes,
                            userAnswers: userAnswers
                        };
                        // 檢查是否重複
                        if (!clientDatabase.some(c => c.userName === userName && c.completionDate === completionDate)) {
                            clientDatabase.push(newClientEntry);
                            saveClientDatabase();
                            alert("已儲存至資料庫。");
                        } else {
                            alert("這筆資料已存在資料庫中，無需重複儲存。");
                        }
                    }
                } catch (e) {
                    console.error("Import error:", e);
                    allElements.importError.textContent = "代碼無效或已損毀。";
                }
            }

            // --- (匯出 CSV 處理函式) ---
            function exportDatabaseToCSV() {
                if (clientDatabase.length === 0) {
                    alert("資料庫中沒有資料可匯出。");
                    return;
                }

                // Helper to escape CSV fields
                const escapeCSV = (str) => {
                    if (str === null || str === undefined) str = "";
                    str = String(str);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                // Define headers
                let headers = ["客戶姓名", "填寫日期", "年收入", "總分", "分析類型", "客戶備註"];
                const maxQuestions = 20; // As defined by the import logic
                for (let i = 1; i <= maxQuestions; i++) {
                    headers.push(`Q${i}-問題`, `Q${i}-答案`, `Q${i}-分數`);
                }
                
                let csvContent = headers.join(',') + '\r\n';

                // Add rows
                clientDatabase.forEach(client => {
                    const incomeMap = {500000:"60萬 以下", 800000:"61 - 100萬", 1250000:"101 - 150萬", 2000000:"151萬 以上"};
                    let row = [
                        escapeCSV(client.userName),
                        escapeCSV(client.completionDate),
                        escapeCSV(incomeMap[client.userAnnualIncome] || 'N/A'),
                        client.totalScore,
                        escapeCSV(client.analysisType),
                        escapeCSV(client.userNotes || "")
                    ];
                    
                    for (let i = 0; i < maxQuestions; i++) {
                        if (client.userAnswers[i]) {
                            row.push(escapeCSV(client.userAnswers[i].question));
                            row.push(escapeCSV(client.userAnswers[i].text));
                            row.push(client.userAnswers[i].score);
                        } else {
                            row.push("", "", ""); // Fill empty slots
                        }
                    }
                    csvContent += row.join(',') + '\r\n';
                });

                // Create download link
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // UTF-8 BOM
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                const today = new Date();
                const dateStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `客戶資料庫_${dateStr}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- (★★★★★ 新增：計分說明彈窗函式) ---
            function showExplanationModal() {
                const modalBody = document.getElementById('modal-body');
                
                // 檢查目前啟用的問題數
                // 如果在結果頁 (activeQuestions 已有值)，就用它
                // 如果在開始頁就點擊 (activeQuestions 為空)，就從主題庫計算
                const numQuestions = activeQuestions.length > 0 ? activeQuestions.length : QUESTIONS_DATABASE.filter(q => !q.disabled).length;
                
                if (numQuestions === 0) {
                    modalBody.innerHTML = '<p class="text-gray-700">目前題庫中沒有啟用的問題，無法計算分數範圍。</p>';
                    allElements.explanationModal.style.display = 'block';
                    return;
                }

                const maxScore = numQuestions * 40;
                const minScore = numQuestions * 10;
                const range = maxScore - minScore;
                // 使用 Math.floor 確保整數
                const level1Max = Math.floor(minScore + (range * 0.25));
                const level2Max = Math.floor(minScore + (range * 0.60));
                const level3Max = Math.floor(minScore + (range * 0.90));

                modalBody.innerHTML = `
                    <p class="text-gray-700 mb-4">總分是根據您在 ${numQuestions} 個情境中的選擇加總而來。</p>
                    <p class="text-gray-700 mb-4">每個選項的分數從 10分 (最低規劃) 到 40分 (最高規劃) 不等，代表您對該情境的風險規劃偏好程度。</p>
                    <p class="text-gray-700 mb-6">以目前啟用的 ${numQuestions} 個問題計算，分數範圍為：</p>
                    <ul class="list-disc list-inside space-y-3 bg-gray-50 p-4 rounded-lg">
                        <li><b><span class="text-purple-700">最低總分：</span></b> ${minScore} 分 ( ${numQuestions} x 10分 )</li>
                        <li><b><span class="text-purple-700">最高總分：</span></b> ${maxScore} 分 ( ${numQuestions} x 40分 )</li>
                    </ul>
                    <hr class="my-6">
                    <h4 class="text-lg font-bold text-green-800 mb-3">分析類型判定標準 (依總分區間)：</h4>
                    <div class="space-y-2">
                        <p><b><span class="text-purple-700">隨遇而安型：</span></b> ${minScore} - ${level1Max} 分</p>
                        <p><b><span class="text-purple-700">穩健平衡型：</span></b> ${level1Max + 1} - ${level2Max} 分</p>
                        <p><b><span class="text-purple-700">深思熟慮型：</span></b> ${level2Max + 1} - ${level3Max} 分</p>
                        <p><b><span class="text-purple-700">萬全準備型：</span></b> ${level3Max + 1} - ${maxScore} 分</p>
                    </div>
                `;
                
                allElements.explanationModal.style.display = 'block';
            }

            // (★★★★★ 新增：另存客戶版HTML函式)
            function saveClientVersion() {
                // Clone the entire document
                const clonedDoc = document.cloneNode(true);
                
                // 定義要移除的 顧問專用 ID
                const idsToRemove = [
                    'open-import-btn',    // 匯入代碼按鈕
                    'open-db-btn',        // 資料庫管理按鈕
                    'open-qdb-btn',       // 編輯題庫按鈕
                    'save-client-html-btn', // 另存HTML按鈕 (自己)
                    'question-db-screen', // 題庫編輯畫面
                    'database-screen',    // 資料庫管理畫面
                    'import-modal',       // 匯入代碼彈窗
                    'csv-import-input'    // CSV匯入的input
                ];

                // 從複製的文檔中移除這些元素
                idsToRemove.forEach(id => {
                    const el = clonedDoc.getElementById(id);
                    el?.remove();
                });

                // 取得修改後的 HTML 字串
                let clientHtml = clonedDoc.documentElement.outerHTML;

                // 建立 Blob 物件
                const blob = new Blob([clientHtml], { type: 'text/html;charset=utf-8' });
                
                // 建立下載連結
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", "保險規劃問卷-客戶版.html");
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                
                // 觸發下載
                link.click();
                
                // 清理
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }


            // --- 初始設定與事件綁定 ---
            // (★★★★★ 已修改：所有綁定都增加了 'if' 檢查，以防止在客戶版中出錯)
            loadQuestionDatabase();
            loadClientDatabase();

            // 畫面切換
            if (allElements.startBtn) allElements.startBtn.addEventListener('click', () => showScreen(allElements.nameScreen));
            
            if (allElements.nameNextBtn) allElements.nameNextBtn.addEventListener('click', () => {
                const name = allElements.nameInput.value.trim();
                if (name === "") { allElements.nameError.textContent = "請輸入一個稱呼！"; } 
                else { userName = name; allElements.nameError.textContent = ""; showScreen(allElements.incomeScreen); }
            });
            
            if (allElements.incomeBtns) allElements.incomeBtns.forEach(btn => btn.addEventListener('click', () => selectIncome(parseInt(btn.dataset.income, 10))));
            
            if (allElements.notesFinishBtn) allElements.notesFinishBtn.addEventListener('click', () => { userNotes = allElements.notesTextArea.value.trim(); showResults(); });
            
            if (allElements.restartBtn) allElements.restartBtn.addEventListener('click', goBackToStart);
            if (allElements.dbBackBtn) allElements.dbBackBtn.addEventListener('click', goBackToStart);
            if (allElements.qdbBackBtn) allElements.qdbBackBtn.addEventListener('click', goBackToStart); // 新
            
            if (allElements.openDbBtn) allElements.openDbBtn.addEventListener('click', () => { allElements.gameContainer.classList.add('db-mode'); populateClientDatabaseTable(); showScreen(allElements.databaseScreen); });
            if (allElements.openQdbBtn) allElements.openQdbBtn.addEventListener('click', () => { allElements.gameContainer.classList.add('db-mode'); populateQuestionEditor(); showScreen(allElements.questionDbScreen); }); // 新
            
            // 功能按鈕
            if (allElements.printBtn) allElements.printBtn.addEventListener('click', () => {
                const today = new Date();
                const rocYear = today.getFullYear() - 1911;
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                const newFilename = `${rocYear}${month}${day}-保險規劃問卷-${userName || '客戶'}`;
                document.title = newFilename;
                window.print();
            });
            
            if (allElements.qdbSaveBtn) allElements.qdbSaveBtn.addEventListener('click', saveQuestionDatabase); // 新
            if (allElements.qdbResetBtn) allElements.qdbResetBtn.addEventListener('click', resetQuestionDatabase); // 新
            
            if (allElements.clearDbBtn) allElements.clearDbBtn.addEventListener('click', () => { if(confirm("確定要清空所有客戶資料嗎？")){ clientDatabase = []; saveClientDatabase(); populateClientDatabaseTable(); } });
            
            if (allElements.importCsvBtn) allElements.importCsvBtn.addEventListener('click', () => allElements.csvImportInput.click());
            if (allElements.csvImportInput) allElements.csvImportInput.addEventListener('change', handleCsvImport);
            
            // (綁定 CSV 匯出按鈕)
            if (allElements.exportCsvBtn) allElements.exportCsvBtn.addEventListener('click', exportDatabaseToCSV);

            // (綁定代碼匯入/匯出彈窗)
            if (allElements.openImportBtn) allElements.openImportBtn.addEventListener('click', () => { allElements.importCodeArea.value = ''; allElements.importError.textContent = ''; allElements.importModal.style.display = 'block'; });
            if (allElements.importLoadBtn) allElements.importLoadBtn.addEventListener('click', handleImportCode);
            
            if (allElements.openExportBtn) allElements.openExportBtn.addEventListener('click', () => { allElements.exportCodeArea.value = generateExportCode(); allElements.copySuccess.textContent = ''; allElements.exportModal.style.display = 'block'; });
            if (allElements.copyCodeBtn) allElements.copyCodeBtn.addEventListener('click', () => { allElements.exportCodeArea.select(); try { document.execCommand('copy'); allElements.copySuccess.textContent = "已成功複製！"; } catch (err) { allElements.copySuccess.textContent = "複製失敗。"; } });
            
            // (★★★★★ 新增：綁定計分說明彈窗按鈕)
            if (allElements.openExplanationBtn) allElements.openExplanationBtn.addEventListener('click', showExplanationModal);
            
            // (★★★★★ 新增：綁定另存HTML按鈕)
            if (allElements.saveClientHtmlBtn) allElements.saveClientHtmlBtn.addEventListener('click', saveClientVersion);

            // (綁定所有彈窗的關閉按鈕)
            if (allElements.closeImportBtn) allElements.closeImportBtn.addEventListener('click', () => allElements.importModal.style.display = 'none');
            if (allElements.closeExportBtn) allElements.closeExportBtn.addEventListener('click', () => allElements.exportModal.style.display = 'none');
            if (allElements.closeExplanationBtn) allElements.closeExplanationBtn.addEventListener('click', () => allElements.explanationModal.style.display = 'none');
            
            window.addEventListener('click', (e) => { 
                if(e.target == allElements.importModal) allElements.importModal.style.display = 'none'; 
                if(e.target == allElements.exportModal) allElements.exportModal.style.display = 'none'; 
                if(e.target == allElements.explanationModal) allElements.explanationModal.style.display = 'none'; 
            });

            // (★★★★★ 新增：列印後恢復原始標題)
            window.addEventListener('afterprint', () => {
                document.title = originalDocumentTitle;
            });
        });
    </script>


</body></html>