<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿å–®è³‡ç”¢ç®¡ç† - å‚³å®¶æ¨‚åˆ—å°å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@300;400;700&family=Noto+Sans+TC:wght@300;400;700&family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style id="print-dynamic-style"></style>

    <style id="main-style">
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #f9f6ea; 
            --text-primary: #594a42;
            --font-title: 'Noto Serif TC', serif;
            --font-body: 'Noto Sans TC', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: var(--font-body);
            color: var(--text-primary);
            overflow: hidden;
            position: fixed; width: 100%; height: 100%;
            touch-action: manipulation;
        }

        .font-title { font-family: var(--font-title); }
        .font-body { font-family: var(--font-body); }

        /* --- Toast Notification Style --- */
        #toast-notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: rgba(45, 42, 38, 0.85);
            color: #fff;
            padding: 10px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 2500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px);
            font-family: 'Noto Sans TC', sans-serif;
            letter-spacing: 0.05em;
        }
        #toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* --- Page Number Style (Right Bottom) --- */
        .card-page-num {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            opacity: 0.4;
            font-family: 'Noto Sans TC', monospace;
            z-index: 50;
            pointer-events: none;
        }

        /* --- Admin UI --- */
        #admin-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 56px; height: 56px;
            background: #2d2a26;
            border: 3px solid #fff;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff;
            z-index: 1000; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }
        #admin-btn:hover { transform: scale(1.1); background: #4a453f; }

        #admin-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; 
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            pointer-events: none;
        }

        #admin-panel > * { pointer-events: auto; }
        .admin-layout-container { pointer-events: none; }
        .admin-sidebar, .admin-editor, .admin-header { pointer-events: auto; }

        .admin-header {
            background: white; border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-sidebar { 
            background: white; 
            border-right: 1px solid #e5e7eb; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }
        .admin-editor { background: #f8f9fa; overflow-y: auto; }

        .admin-card-item {
            padding: 1rem; border-bottom: 1px solid #f3f4f6; cursor: pointer;
            transition: background 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .admin-card-item:hover { background: #f9fafb; }
        .admin-card-item.active { background: #eff6ff; border-left: 4px solid #3b82f6; }

        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .form-input {
            width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            margin-bottom: 1rem; font-family: 'Noto Sans TC', sans-serif;
        }
        .form-input:focus { outline: none; border-color: #3b82f6; ring: 2px solid #93c5fd; }

        .global-settings {
            background: #fff; border-bottom: 1px solid #e5e7eb; padding: 1rem;
            flex-shrink: 0; 
        }

        /* --- Text Library Styles --- */
        .library-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
            margin-bottom: 24px;
        }
        .lib-section-title {
            background: #f1f5f9;
            padding: 8px 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .lib-area { padding: 12px; }
        .lib-area + .lib-section-title { border-top: 1px solid #e2e8f0; }

        .lib-item {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .lib-item:hover { background-color: #f8fafc; }
        .lib-item.active {
            background-color: #e0e7ff; 
            color: #4338ca; 
            font-weight: bold;
            border-left: 3px solid #4338ca;
        }

        /* --- Card Styles --- */
        #card-stack {
            position: fixed;
            width: 360px; height: 520px; 
            left: 50%; top: 50%;
            transform: translate(-50%, -50%); 
            margin: 0;
            z-index: 100;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--card-bg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px; padding: 2rem;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: grab; user-select: none;
            will-change: transform; 
            transform-origin: 50% 100%;
            overflow: hidden; 
            touch-action: none;
            display: none; 
        }
        
        .card.preview-focus {
            z-index: 1000 !important;
            transform: scale(1.05) translate(0, 0) rotate(0deg) !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2) !important;
            border: 2px solid #3b82f6;
            opacity: 1 !important; 
            pointer-events: auto !important;
            display: flex !important;
        }

        .card:active { cursor: grabbing; }

        .card-sheen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.4) 45%, rgba(255, 255, 255, 0.0) 55%, transparent 100%);
            pointer-events: none; z-index: 10; opacity: 0; 
            transition: opacity 0.5s ease-out; mix-blend-mode: screen;
        }

        .card-content {
            position: relative; z-index: 5; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none; 
        }

        .back-btn {
            position: absolute; top: 10px; left: 10px;
            font-size: 0.7rem; font-family: 'Noto Sans TC', sans-serif; font-weight: 700;
            color: #808080; background: rgba(255, 255, 255, 0.5);
            padding: 2px 6px; border-radius: 4px; cursor: pointer; z-index: 50;
            text-transform: uppercase; letter-spacing: 0.05em;
            transition: all 0.2s; border: 1px solid transparent;
            pointer-events: auto;
        }
        .back-btn:hover { color: #333; background: rgba(255, 255, 255, 0.9); border-color: #ddd; }

        a { pointer-events: auto; }
        a.text-link { text-decoration: underline; text-decoration-style: dotted; text-underline-offset: 4px; transition: all 0.2s; }
        a.text-link:hover { opacity: 0.7; }

        /* æ”¯æ´æ–‡å­—é¡è‰²èªæ³•èˆ‡é€£çµ */
        span[style*="color"] { display: inline; }
        a[href] { cursor: pointer; }

        /* ç‰¹æ®Šç‰ˆå‹æ¨£å¼ */
        .timeline-item { position: relative; padding-left: 20px; border-left: 2px solid currentColor; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 5px; width: 10px; height: 10px; background: currentColor; border-radius: 50%; }
        .timeline-item:last-child { border-left: none; }
        
        .grid-box { border: 1px solid currentColor; padding: 10px; border-radius: 4px; text-align: center; pointer-events: auto; }
        .key-value { display: flex; justify-content: space-between; border-bottom: 1px dashed currentColor; padding: 8px 0; width: 100%; }

        .bar-container { width: 100%; display: flex; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
        .bar-label { width: 30%; text-align: right; padding-right: 10px; opacity: 0.8; }
        .bar-track { flex: 1; height: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: currentColor; opacity: 0.7; border-radius: 4px; }
        .bar-value { width: 15%; padding-left: 8px; font-size: 0.7rem; opacity: 0.6; }

        .custom-scrollbar { pointer-events: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

        /* --- PRINT STYLES --- */
        @media print {
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                background: white !important;
                background-image: none !important;
                overflow: visible !important;
                height: auto !important;
                position: relative !important;
                zoom: 1 !important; -moz-transform: none !important;
            }
            #admin-btn, #admin-panel, #start-overlay, .card-sheen, #save-file-btn, #add-page-btn, #close-admin-btn, #print-file-btn, #print-settings-modal, .back-btn, #toast-notification { 
                display: none !important; 
            }
            #card-stack {
                position: static !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                transform: none !important;
                display: grid !important;
                gap: 20px;
                margin: 0 !important;
                padding: 20px;
                top: auto !important;
                left: auto !important;
            }
            .card {
                position: relative !important;
                width: 100% !important;
                height: 480px !important;
                top: auto !important;
                left: auto !important;
                transform: none !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
                break-inside: avoid;
                margin-bottom: 20px;
                background-color: var(--card-bg) !important;
                display: flex !important;
            }
            .card-content { zoom: 0.9; }
            a { text-decoration: none !important; color: inherit !important; pointer-events: none; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start h-screen w-screen overflow-hidden relative">

    <button id="admin-btn" title="é€²å…¥å¾Œå°ç·¨è¼¯">
        <i class="fas fa-cog text-2xl"></i>
    </button>
    
    <div id="toast-notification">å·²ç¶“æ˜¯ç¬¬ä¸€é å›‰ï¼</div>

    <div id="print-settings-modal" class="fixed inset-0 bg-black/60 z-[3000] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-[340px] overflow-hidden">
            <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold flex items-center gap-2"><i class="fas fa-print"></i> åˆ—å° / PDF è¨­å®š</h3>
                <button onclick="closePrintModal()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">1. æª”æ¡ˆå„ªåŒ–</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer border border-gray-200 rounded p-2 hover:border-blue-500 hover:bg-blue-50 transition flex flex-col items-center gap-1 group has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50">
                            <input type="radio" name="print_mode" value="original" class="hidden" checked>
                            <i class="fas fa-palette text-lg text-gray-400 group-has-[:checked]:text-blue-600"></i>
                            <span class="text-xs font-bold text-gray-700">ä¿æŒåŸæ¨£</span>
                        </label>
                        <label class="cursor-pointer border border-gray-200 rounded p-2 hover:border-red-600 hover:bg-red-600 transition flex flex-col items-center gap-1 group has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                            <input type="radio" name="print_mode" value="compress" class="hidden">
                            <i class="fas fa-font text-lg text-gray-400 group-hover:text-white group-has-[:checked]:text-green-600"></i>
                            <span class="text-xs font-bold text-gray-700 group-hover:text-white">è®Šæ›´å­—é«”</span>
                        </label>
                        </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wide">2. æ’åˆ—æ–¹å¼</label>
                    <select id="print-layout" class="w-full border border-gray-300 rounded p-2 text-sm bg-white">
                        <option value="2" selected>ç›´å¼æ’åˆ— (2å¼µ/é )</option>
                        <option value="4">ç”°å­—æ’åˆ— (4å¼µ/é )</option>
                    </select>
                </div>
            </div>
            <div class="p-3 border-t bg-gray-50 flex justify-end gap-2">
                <button onclick="closePrintModal()" class="px-3 py-1.5 text-gray-500 hover:bg-gray-200 rounded text-xs font-medium transition">å–æ¶ˆ</button>
                <button onclick="executePrint()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-bold shadow transition flex items-center gap-1">
                    <i class="fas fa-print"></i> åˆ—å°
                </button>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="flex flex-row">
        <div class="admin-header w-full h-16 flex justify-between items-center px-6 fixed top-0 left-0 z-50">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-edit text-blue-500"></i> 20æ¬¾ç‰ˆé¢ç·¨è¼¯å™¨
            </h2>
            <div class="flex gap-3">
                <button id="print-file-btn" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 transition shadow-sm text-sm font-bold flex items-center">
                    <i class="fas fa-print mr-2"></i> åˆ—å°è¨­å®š
                </button>
                <div class="w-[1px] h-8 bg-gray-300 mx-2"></div>
                <button id="save-file-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition shadow-sm text-sm font-bold flex items-center">
                    <i class="fas fa-save mr-2"></i> å„²å­˜ä¸¦ä¸‹è¼‰æ–°æª”
                </button>
                <div class="w-[1px] h-8 bg-gray-300 mx-2"></div>
                <button id="add-page-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition shadow-sm text-sm">
                    <i class="fas fa-plus mr-1"></i> æ–°å¢é é¢
                </button>
                <button id="close-admin-btn" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-black transition shadow-sm text-sm">
                    é—œé–‰
                </button>
            </div>
        </div>

        <div class="admin-layout-container flex w-full h-full pt-16">
            <div class="w-[35%] h-full hidden md:block"></div>

            <div class="admin-sidebar w-full md:w-[25%] h-full flex flex-col bg-white border-r border-gray-200 shadow-sm relative z-10">
                <div class="global-settings">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">ğŸ¨ å…¨å±€é¢¨æ ¼è¨­å®š</h4>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">ç´™å¼µé¡è‰²</label>
                            <input type="color" id="global-paper-color" class="w-full h-8 p-0 border rounded cursor-pointer" value="#f9f6ea">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-b text-xs font-bold text-gray-400 uppercase tracking-wider flex-shrink-0">é é¢åˆ—è¡¨</div>
                <div id="page-list-container" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                <div class="p-4 border-t flex-shrink-0">
                    <button id="reset-data-btn" class="text-red-400 hover:text-red-600 text-xs underline w-full text-center">æ¢å¾©åŸå§‹ç¯„ä¾‹</button>
                </div>
            </div>

            <div class="admin-editor flex-1 h-full p-8 overflow-y-auto border-l border-gray-100 bg-[#f8f9fa]">
                <div id="editor-empty" class="h-full flex flex-col items-center justify-center text-gray-400">
                    <i class="fas fa-arrow-left text-4xl mb-4"></i><p>è«‹é»é¸å·¦å´é é¢é–‹å§‹ç·¨è¼¯</p>
                </div>

                <div id="editor-form" class="hidden w-full bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <h3 class="text-lg font-bold text-gray-800">ç·¨è¼¯é é¢å…§å®¹</h3>
                        <span id="editing-id-display" class="text-xs text-gray-400 font-mono"></span>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="form-label">ç‰ˆå‹é¸æ“‡</label>
                            <select id="edit-type" class="form-input bg-gray-50 font-bold text-gray-700 text-sm">
                                <optgroup label="åŠŸèƒ½é é¢">
                                    <option value="total_toc">â˜… è‡ªå‹•ç¸½ç›®éŒ„ (Auto TOC)</option>
                                    <option value="cover">1. å°é¢ (Cover)</option>
                                    <option value="intro">2. å‰è¨€/æ•˜è¿° (Intro)</option>
                                    <option value="toc">3. æ‰‹å‹•ç›®éŒ„ (Manual Index)</option>
                                    <option value="chapter">4. ç« ç¯€é  (Chapter)</option>
                                    <option value="quote">5. é‡‘å¥ (Quote)</option>
                                </optgroup>
                                <optgroup label="æ¸…å–®èˆ‡æ¢åˆ—">
                                    <option value="standard">6. é …ç›®æ¸…å–® (Bullets)</option>
                                    <option value="numbered">7. æ•¸å­—æ¸…å–® (1.2.3)</option>
                                    <option value="checklist">8. æª¢æŸ¥è¡¨ (Checklist)</option>
                                    <option value="grid">9. ç¶²æ ¼åœ–æ¨™ (Grid 4)</option>
                                    <option value="grid3">10. ç¶²æ ¼åœ–æ¨™ (Grid 3)</option>
                                </optgroup>
                                <optgroup label="è³‡è¨Šåœ–è¡¨">
                                    <option value="stat">11. é—œéµæ•¸å­— (Big Stat)</option>
                                    <option value="keyvalue">12. è¦æ ¼æ•¸å€¼ (Specs)</option>
                                    <option value="chart">13. ç°¡æ˜“é•·æ¢åœ– (Chart)</option>
                                    <option value="comparison">14. å°ç…§æ¯”è¼ƒ (VS)</option>
                                    <option value="table">15. è¡¨æ ¼ (Table)</option>
                                </optgroup>
                                <optgroup label="æµç¨‹èˆ‡å…¶ä»–">
                                    <option value="timeline">16. å‚ç›´æ™‚é–“è»¸ (Timeline)</option>
                                    <option value="process">17. æ©«å‘æµç¨‹ (Process)</option>
                                    <option value="qa">18. å•èˆ‡ç­” (Q&A)</option>
                                    <option value="warning">19. è­¦èª/æ³¨æ„ (Warning)</option>
                                    <option value="contact">20. åç‰‡/çµå°¾ (Contact)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ä¸»é¡Œè‰²ç³»</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="edit-color" class="h-[42px] w-[60px] cursor-pointer border rounded p-1">
                                <span class="text-xs text-gray-400">é»æ“Šæ›´æ›æ–‡å­—èˆ‡è£é£¾é¡è‰²</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6">
                         <div class="col-span-2">
                            <label class="form-label">ä¸»æ¨™é¡Œ</label>
                            
                            <input type="text" id="edit-title" class="form-input font-bold mb-2" placeholder="è¼¸å…¥æ¨™é¡Œå…§å®¹...">
                            
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-500">ç¸®æ”¾æ¯”ä¾‹ï¼š</label>
                                <select id="edit-title-scale" class="form-input w-32 mb-0 text-sm bg-gray-50 cursor-pointer font-mono text-center p-1 h-8 py-0" title="èª¿æ•´æ¨™é¡Œå¤§å°æ¯”ä¾‹">
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                    <option value="110">110%</option>
                                    <option value="120">120%</option>
                                    <option value="custom">è‡ªè¨‚ %...</option>
                                </select>
                            </div>
                         </div>
                         <div>
                            <label class="form-label">å´é‚Šæ¨™ç±¤/å°æ¨™</label>
                            <input type="text" id="edit-tag" class="form-input">
                         </div>
                    </div>

                    <div class="library-container">
                        <div class="lib-section-title text-green-700 bg-green-50 border-green-200 flex justify-between items-center">
                            <span><i class="fas fa-plus-circle mr-1"></i> æ–°å¢è³‡æ–™åˆ°é¡Œåº«</span>
                            <button onclick="lib_add_new()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-green-700 whitespace-nowrap">
                                <i class="fas fa-save"></i> å­˜å…¥
                            </button>
                        </div>
                        <div class="lib-area bg-green-50/30">
                            <div class="flex flex-col gap-2">
                                <div class="relative">
                                    <textarea id="lib-new-content" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æˆ–è²¼ä¸Šæ–‡å­— (é‡è¤‡å…§å®¹å°‡è¢«æ‹’çµ•)..." class="w-full h-16 text-sm border border-gray-300 rounded p-2 focus:outline-none focus:border-green-500 resize-none font-mono"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="lib-section-title text-indigo-700 bg-indigo-50 border-indigo-200">
                            <span><i class="fas fa-list-ul mr-1"></i> é¡Œåº«åˆ—è¡¨ (é»é¸ä»¥åç™½)</span>
                        </div>
                        <div class="lib-area bg-indigo-50/30">
                            <div id="lib-list-container" class="bg-white border border-gray-300 rounded overflow-y-auto custom-scrollbar mb-2" style="height: 160px;"></div>
                            
                            <div class="flex gap-2">
                                <button onclick="lib_insert_at_cursor()" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                                    <i class="fas fa-mouse-pointer"></i> æ’å…¥æ–‡å­—
                                </button>
                                <button onclick="lib_delete()" class="flex-1 bg-white text-red-500 hover:bg-red-50 px-3 py-2 rounded border border-red-200 text-sm font-bold shadow-sm transition flex items-center justify-center gap-2" title="åˆªé™¤é¸ä¸­çš„é¡Œåº«">
                                    <i class="fas fa-trash-alt"></i> åˆªé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                    <label class="form-label flex justify-between items-end">
                        <div>
                            å…§å®¹ç·¨è¼¯ <span class="text-xs text-orange-500 ml-2">(èªæ³•ï¼šæ–‡å­—## é€£çµ | [link:..] | [color:..])</span>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-100 px-2 py-1 rounded border border-gray-200">
                            <button onclick="insertLink()" class="text-gray-600 hover:text-blue-600 hover:bg-white p-1 rounded transition" title="æ’å…¥è¶…é€£çµ (è‡ªå‹•ç¢ºèª)">
                                <i class="fas fa-link"></i>
                            </button>
                            <div class="w-[1px] h-4 bg-gray-300"></div>
                            <label class="flex items-center gap-1 cursor-pointer text-gray-600 hover:text-gray-900">
                                <i class="fas fa-palette text-sm"></i>
                                <input type="color" id="text-color-picker" class="w-5 h-5 p-0 border-0 bg-transparent cursor-pointer" value="#000000" title="é¸æ“‡é¡è‰²ï¼Œé€£çµæ™‚å°‡è‡ªå‹•å¥—ç”¨" onchange="insertColorCode(this.value)">
                            </label>
                        </div>
                    </label>
                    
                    <div id="hint-text" class="text-xs font-normal text-gray-500 mt-1 bg-yellow-50 p-2 rounded border border-yellow-100 mb-2">
                        æç¤ºå€
                    </div>
                    
                    <textarea id="edit-content" class="form-input h-48 font-mono text-sm leading-relaxed"></textarea>

                    <div class="flex justify-end pt-4 border-t mt-4 gap-3">
                        <button id="delete-page-btn" class="px-4 py-2 text-red-500 hover:bg-red-50 rounded transition text-sm">åˆªé™¤æ­¤é </button>
                        <button id="apply-change-btn" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow">ç¢ºèªä¿®æ”¹ (æš«å­˜)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="start-overlay" class="fixed top-0 left-0 w-full h-full bg-[#fdfcf8] z-[1500] flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="text-center p-8 border-y border-stone-200">
            <h1 class="text-4xl font-bold text-stone-700 mb-2 tracking-widest font-title">ä¿å–®è³‡ç”¢ç®¡ç†</h1>
            <p class="text-sm text-stone-400 tracking-[0.5em] font-body">20 STYLES COLLECTION</p>
        </div>
        <button id="start-btn" class="mt-12 px-12 py-3 border border-stone-600 text-stone-600 hover:bg-stone-600 hover:text-white transition-all rounded-sm tracking-widest font-body">
            é–‹å§‹ç¿»é–±
        </button>
    </div>

    <div id="card-stack"></div>

    <script id="main-script">
        // --- DATA START ---
        window.bakedData = {"cards":[{"id":"c_01","type":"cover","title":"ä¿å–®è³‡ç”¢ç®¡ç†","tag":"Vol.1","color":"#594a42","content":"äººç„¡é æ…® â€¢ å¿…æœ‰è¿‘æ†‚\n\nå®ˆè­·ç¾åœ¨ â€¢ é ç´„æœªä¾†\n","titleScale":"80"},{"id":"c_02","type":"intro","title":"å‰è¨€","tag":"Intro","color":"#4a5568","content":"é€™æ˜¯ä¸€ä»½å°ˆç‚ºæ‚¨åŠå®¶äººè¨­è¨ˆçš„ä¿å–®æ¬Šç›ŠåŠè³‡ç”¢ç´°ç¯€èªªæ˜ã€‚\n\nä¿éšªåœ¨äººç”Ÿé¢¨éšªã€è²¡ç”¢é¢¨éšªåŠè³‡ç”¢ç®¡ç†æ‰€æ‰®æ¼”é‡è¦åŠŸèƒ½ï¼Œæœ‰å…¶ä¸å¯æ›¿ä»£æ€§ã€‚\n\næœŸæœ›é€™ä»½å ±å‘Šèƒ½å¹«åŠ©æ‚¨æ›´æ¸…æ¥šå…¨å®¶äººçš„ä¿éšªå…§å®¹èˆ‡è³‡ç”¢å…¨è²Œã€‚","titleScale":"100"},{"id":"c_toc_auto","type":"total_toc","title":"ç¸½ç›®éŒ„","tag":"Index","color":"#683e27","content":"","titleScale":"100"},{"id":"c_family_stats","type":"numbered","title":"å…¨å®¶ä¿éšªå„å¼çµ±è¨ˆè¡¨","tag":"Step","color":"#5f5b58","list":["å…¨å®¶ä¿éšœçµ±è¨ˆè¡¨","å…¨å®¶ä¿å–®åƒ¹å€¼çµ±è¨ˆè¡¨","å…¨å®¶é‚„æœ¬.æ’¥å›é‡‘çµ±è¨ˆè¡¨","å…¨å®¶ä¿è²»çµ±è¨ˆè¡¨"],"titleScale":"100"},{"id":"c_08","type":"checklist","title":"è²¡å¯Œç®¡ç†å°ˆå€","tag":"Check","color":"#059669","list":["è²¡å¯Œå‚³æ‰¿åŠç¨…å‹™åˆ†æèªéŸ³ç‰ˆ","å…¨å®¶è²¡å¯Œç®¡ç†å ±è¡¨","å…¨å®¶ç¨…å‹™åˆ†æ","ä¿å–®è³‡ç”¢åŠç¾é‡‘æµåˆ†æ"],"titleScale":"100"},{"id":"c_13","type":"chart","title":"æŠ•è³‡å‹ä¿å–®å°ˆå€","tag":"Chart","color":"#b91c1c","list":["ç¬¬ 5 å¹´## 20","ç¬¬ 10 å¹´## 45","ç¬¬ 20 å¹´## 80","ç¬¬ 30 å¹´## 150"],"titleScale":"100"},{"id":"c_1764389140940","type":"toc","title":"ç”¢ç‰©ä¿éšªå°ˆå€","tag":"Index","color":"#2d3748","list":["ğŸ”ï¸ğŸ å—å±±ç”¢ç‰©--ç¸½è¡¨## P.01","ğŸš—ğŸ›¡ï¸æ±½è»Šéšª## P.05","ğŸ›µğŸ›¡ï¸æ©Ÿè»Šéšª## P.08","ğŸ ğŸ”¥ä½å®…ç«éšª## P.12","ğŸ’°ğŸ§˜â€â™‚ï¸é‡‘å¦‚æ„å€‹äººæ„å¤–éšª"],"titleScale":"100"},{"id":"c_1764389535621","type":"chapter","title":"å„ç¨®å”®å¾Œæœå‹™è³‡æº","tag":"01","color":"#881337","content":"è«‹æŒ‰æ­¤!","titleScale":"80"},{"id":"c_10","type":"grid3","title":"æä»²å¹³ä¿å–®","tag":"Svc","color":"#4338ca","list":["ä¿å–®å¥æª¢(åœ–è¡¨)","ä¿å–®å¥æª¢èªªæ˜(èªéŸ³)","å—å±±äººå£½ä¿å–®æ ¡æ­£è¡¨","æŠ•ä¿ç´€éŒ„","æœå‹™ç´€éŒ„","ç†è³ ç´€éŒ„","å°è©±ç´€éŒ„.æ–‡ä»¶å­˜æª”"],"titleScale":"100"},{"id":"c_03","type":"toc","title":"ç›®éŒ„ç´¢é©¥","tag":"Index","color":"#2d3748","list":["æ ¸å¿ƒåƒ¹å€¼èˆ‡ç†å¿µ## P.01","ä¿éšœè¦åŠƒé‡é»## P.05","æ•¸æ“šåˆ†æåœ–è¡¨## P.08","å¸¸è¦‹å•é¡Œè§£æ## P.12"]},{"id":"c_1764389303026","type":"toc","title":"ç›®éŒ„ç´¢é©¥ (è¤‡è£½)","tag":"Index","color":"#2d3748","list":["æ ¸å¿ƒåƒ¹å€¼èˆ‡ç†å¿µ## P.01","ä¿éšœè¦åŠƒé‡é»## P.05","æ•¸æ“šåˆ†æåœ–è¡¨## P.08","å¸¸è¦‹å•é¡Œè§£æ## P.12"]},{"id":"c_04","type":"chapter","title":"æ ¸å¿ƒç†å¿µ","tag":"01","color":"#881337","content":"ç¬¬ä¸€ç« "},{"id":"c_05","type":"quote","title":"è¯å€«Â·å·´è²ç‰¹","tag":"Quote","color":"#1f2937","content":"ã€Œä¸è¦æŠŠæ‰€æœ‰é›è›‹\næ”¾åœ¨åŒä¸€å€‹ç±ƒå­è£¡ã€‚ã€"},{"id":"c_06","type":"standard","title":"ä¿éšœé‡é»","tag":"List","color":"#c2410c","list":["é«˜æ§“æ¡¿ä¿éšœå€æ•¸## #","è±å…ä¿è²»æ©Ÿåˆ¶å•Ÿå‹•## #","å®¶åº­è²¬ä»»å®Œæ•´å®ˆè­·## #"]},{"id":"c_07","type":"numbered","title":"æŠ•ä¿ä¸‰æ­¥é©Ÿ","tag":"Step","color":"#047857","list":["éœ€æ±‚åˆ†æèˆ‡è¨è«–","å»ºè­°æ›¸è¦åŠƒèˆ‡èª¿æ•´","æ­£å¼ç°½ç´„èˆ‡é€ä»¶"]},{"id":"c_09","type":"grid","title":"å››å¤§ç‰¹è‰²","tag":"Feat.","color":"#0369a1","list":["å½ˆæ€§ç¹³è²»","å¤šå¹£åˆ¥","é«˜é¡å›é¥‹","ä¿¡è¨—å°æ¥"]},{"id":"c_11","type":"stat","title":"æŠ•è³‡å‹ä¿å–®å°ˆå€","tag":"Data","color":"#be123c","content":"125%## é ä¼°20å¹´ç¸½å ±é…¬","titleScale":"120"},{"id":"c_12","type":"keyvalue","title":"ä¿å–®è¦æ ¼","tag":"Spec","color":"#374151","list":["æŠ•ä¿å¹´é½¡## 0-70æ­²","ç¹³è²»å¹´æœŸ## 6/10/20å¹´","è¨ˆåƒ¹å¹£åˆ¥## ç¾å…ƒUSD","é å®šåˆ©ç‡## 2.5%"]},{"id":"c_1764388708299","type":"keyvalue","title":"ä¿å–®è¦æ ¼ (è¤‡è£½)","tag":"Spec","color":"#374151","list":["æŠ•ä¿å¹´é½¡## 0-70æ­²","ç¹³è²»å¹´æœŸ## 6/10/20å¹´","è¨ˆåƒ¹å¹£åˆ¥## ç¾å…ƒUSD","é å®šåˆ©ç‡## 2.5%"]},{"id":"c_14","type":"comparison","title":"æ–¹æ¡ˆæ¯”è¼ƒ","tag":"VS","color":"#1e3a8a","list":["å‚³çµ±å„²è“„éšª## è®Šé¡è¬èƒ½å£½éšª","å›ºå®šåˆ©ç‡## å¸‚å ´é€£å‹•","è³‡é‡‘é–‰é–æœŸé•·## å½ˆæ€§æé ˜"]},{"id":"c_15","type":"table","title":"è²»ç‡ä¸€è¦½è¡¨","tag":"Table","color":"#475569","list":["30æ­²ç”·æ€§## 2,500/æœˆ","30æ­²å¥³æ€§## 2,100/æœˆ","40æ­²ç”·æ€§## 3,800/æœˆ","40æ­²å¥³æ€§## 3,200/æœˆ"]},{"id":"c_16","type":"timeline","title":"äººç”Ÿéšæ®µ","tag":"Time","color":"#d97706","list":["25æ­²ï¼šåˆå…¥è·å ´","35æ­²ï¼šæˆå®¶ç«‹æ¥­","50æ­²ï¼šè²¡å¯Œç©ç´¯","65æ­²ï¼šå®‰äº«é€€ä¼‘"]},{"id":"c_17","type":"process","title":"ç†è³ æµç¨‹","tag":"Flow","color":"#0891b2","list":["äº‹æ•…ç™¼ç”Ÿ","é€šçŸ¥é¡§å•","æº–å‚™æ–‡ä»¶","é€ä»¶å¯©æ ¸","æ’¥æ¬¾"]},{"id":"c_18","type":"qa","title":"å¸¸è¦‹å•ç­”","tag":"Q&A","color":"#6d28d9","list":["Q: ç¹³è²»æœŸé–“å¯ä»¥æ›´æ”¹å—ï¼Ÿ## A: å¯ä»¥ï¼Œä½†éœ€åœ¨é€±å¹´æ—¥ç”³è«‹ã€‚","Q: å—ç›Šäººå¦‚ä½•è®Šæ›´ï¼Ÿ## A: å¡«å¯«è®Šæ›´ç”³è«‹æ›¸ä¸¦ç°½åå³å¯ã€‚"]},{"id":"c_19","type":"warning","title":"é‡è¦è²æ˜","tag":"Note","color":"#991b1b","list":["æå‰è§£ç´„å¯èƒ½æå¤±æœ¬é‡‘","å¤–å¹£ä¿å–®éœ€ç•™æ„åŒ¯å…Œé¢¨éšª","æœ¬æ–‡ä»¶åƒ…ä¾›åƒè€ƒï¼Œè©³è¦‹æ¢æ¬¾"]},{"id":"c_20","type":"contact","title":"å°ˆå±¬é¡§å•","tag":"Info","color":"#111827","content":"ç‹å°æ˜ (Ming)\n0912-345-678\nLINE: ming_ins## https://line.me"}],"style":{"fontTitle":"'Noto Serif TC', serif","fontBody":"'Noto Sans TC', sans-serif","paperColor":"#f9f6ea","textureOpacity":"0.5"},"library":[{"content":"ä¸è¦æŠŠæ‰€æœ‰é›è›‹\næ”¾åœ¨åŒä¸€å€‹ç±ƒå­è£¡ã€‚"},{"content":"çœŸæ­£çš„è²¡å¯Œç®¡ç†ï¼Œå§‹æ–¼å°ç´°ç¯€çš„å …æŒã€‚\n\né€™æ˜¯ä¸€ä»½å°ˆç‚ºå®¶æ—å‚³æ‰¿è¨­è¨ˆçš„è¦åŠƒæ›¸ï¼ŒåŒ…å«äº†å¾æ³•å¾‹æ¶æ§‹ã€ç¨…å‹™åˆ†æåˆ°ä¿å–®é…ç½®çš„å®Œæ•´è§£æ±ºæ–¹æ¡ˆã€‚æˆ‘å€‘è‡´åŠ›æ–¼ç¢ºä¿æ‚¨çš„å¿ƒæ„ï¼Œèƒ½ç©¿è¶Šæ™‚é–“çš„è€ƒé©—ï¼Œå®Œæ•´å‚³éçµ¦ä¸‹ä¸€ä»£ã€‚"},{"content":"å¯¦æ”¯å¯¦ä»˜è¦†è“‹é«˜é¡è‡ªè²»## #\né›™å€æ‰‹è¡“çµ¦ä»˜å€æ•¸## #\nåŒ…å«é–€è¨ºæ‰‹è¡“é›œè²»## #"},{"content":"æœ¬å»ºè­°æ›¸åƒ…ä¾›åƒè€ƒï¼Œè©³ç´°å…§å®¹ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–\næŠ•è³‡å‹ä¿å–®å‡æœ‰é¢¨éšªï¼Œè«‹è©³é–±å…¬é–‹èªªæ˜æ›¸\nå¤–å¹£ä¿å–®éœ€ç•™æ„åŒ¯å…Œé¢¨éšª"}]};
        // --- DATA END ---
        
        let currentScaleFactor = 1;
        // æ§åˆ¶ç›®å‰è§€çœ‹åˆ°çš„é é¢ Index
        let viewingStartIndex = 0;

        const defaultStyle = {
            fontTitle: "'Noto Serif TC', serif",
            fontBody: "'Noto Sans TC', sans-serif",
            paperColor: "#f9f6ea",
            textureOpacity: "0.5"
        };

        // é è¨­è³‡æ–™åƒ…ä½œå‚™ä»½ï¼Œå¯¦éš›ä½¿ç”¨ bakedData
        const defaultCards = []; 
        let cardsData = [];
        let styleConfig = {};
        let textLibrary = [];
        let currentEditId = null;
        let selectedLibIndex = -1; 

        function initData() {
            if (window.bakedData) {
                cardsData = window.bakedData.cards;
                styleConfig = window.bakedData.style;
                textLibrary = window.bakedData.library || [];
            } else {
                cardsData = [];
                styleConfig = { ...defaultStyle };
                textLibrary = [];
            }
            
            applyStyles();
            renderCards();
            renderSidebar(); 
            initAdminUI();
            renderLibraryList(); 
            adjustLayout();
        }

        function adjustLayout() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            const stack = document.getElementById('card-stack');
            const adminPanel = document.getElementById('admin-panel');
            
            if (adminPanel.style.display === 'flex') {
                const leftColumnWidth = w * 0.35; 
                const targetX = leftColumnWidth / 2; 
                const targetY = h * 0.55; 
                
                let scale = (leftColumnWidth * 0.85) / 360; 
                if(scale > 0.8) scale = 0.8; 
                
                stack.style.left = targetX + 'px';
                stack.style.top = targetY + 'px';
                stack.style.transform = `translate(-50%, -50%) scale(${scale})`;
                
                currentScaleFactor = scale;
                return;
            }

            const isPortrait = h > w;
            let scale = 1;

            if (isPortrait) {
                scale = (w * 0.85) / 360; 
            } else {
                scale = Math.min((h * 0.85) / 520, 1.1); 
            }
            
            if(scale < 0.6) scale = 0.6;
            if(scale > 2.0) scale = 2.0;

            currentScaleFactor = scale;
            stack.style.left = '50%';
            stack.style.top = '50%';
            stack.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        window.addEventListener('resize', adjustLayout);
        
        // éµç›¤å°èˆª
        window.addEventListener('keydown', (e) => {
            if (document.getElementById('admin-panel').style.display === 'flex') return;
            if (e.key === 'ArrowRight') changePage(1);
            if (e.key === 'ArrowLeft') changePage(-1);
        });

        function updateMemoryState() { applyStyles(); renderCards(); renderSidebar(); }

        function applyStyles() {
            const r = document.documentElement.style;
            r.setProperty('--card-bg', styleConfig.paperColor);
        }

        function initAdminUI() {
            document.getElementById('global-paper-color').value = styleConfig.paperColor;
            document.getElementById('global-paper-color').addEventListener('input', (e) => { styleConfig.paperColor = e.target.value; applyStyles(); });

            document.getElementById('edit-title-scale').addEventListener('change', function() {
                if(this.value === 'custom') {
                    const val = prompt("è«‹è¼¸å…¥è‡ªè¨‚ç¸®æ”¾æ¯”ä¾‹ (æ•¸å­—ï¼Œä¾‹å¦‚ 150):", "100");
                    if(val && !isNaN(val)) {
                        const opt = new Option(`${val}%`, val);
                        this.add(opt, this.options[this.length-1]);
                        this.value = val;
                        applyCurrentEdit(true); 
                    } else {
                        this.value = "100";
                    }
                }
            });
        }

        // --- Color & Link Insertion Logic ---
        window.insertColorCode = function(color) {
            const textarea = document.getElementById('edit-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let insertText = '';
            if (selectedText) {
                insertText = `[color:${color}]${selectedText}[/color]`;
            } else {
                insertText = `[color:${color}]æ–‡å­—[/color]`;
            }
            
            textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start;
            textarea.selectionEnd = start + insertText.length;
        }

        window.insertLink = function() {
            const textarea = document.getElementById('edit-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            let selectedText = textarea.value.substring(start, end);

            if (!selectedText) selectedText = "é€£çµæ–‡å­—";

            const url = prompt("è«‹è¼¸å…¥è¶…é€£çµç¶²å€ (ä¾‹å¦‚: https://line.me)ï¼š", "https://");
            if (!url) return; 

            const colorPicker = document.getElementById('text-color-picker');
            const currentColor = colorPicker.value;

            let finalString = selectedText;

            if (!selectedText.includes('[color:') && currentColor !== '#000000') {
                finalString = `[color:${currentColor}]${selectedText}[/color]`;
            }

            finalString = `[link:${url}]${finalString}[/link]`;

            textarea.value = textarea.value.substring(0, start) + finalString + textarea.value.substring(end);

            textarea.focus();
            textarea.selectionStart = start + finalString.length;
            textarea.selectionEnd = start + finalString.length;

            setTimeout(() => {
                applyCurrentEdit(false); 
            }, 100);
        }

        // --- Library Logic ---
        function renderLibraryList() {
            const container = document.getElementById('lib-list-container');
            container.innerHTML = ''; 
            
            if (textLibrary.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-xs text-gray-400">å°šç„¡é¡Œåº«è³‡æ–™</div>';
                return;
            }

            textLibrary.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'lib-item';
                if (index === selectedLibIndex) div.classList.add('active');
                div.innerText = item.content; 
                div.onclick = () => {
                    selectedLibIndex = index;
                    renderLibraryList(); 
                };
                container.appendChild(div);
            });
        }

        function lib_add_new() {
            const contentInput = document.getElementById('lib-new-content');
            const content = contentInput.value.trim();
            if (!content) { alert('å…§å®¹ä¸èƒ½ç‚ºç©ºï¼'); return; }
            const isDuplicate = textLibrary.some(item => item.content.trim() === content);
            if (isDuplicate) { 
                alert('ã€é‡è¤‡è­¦å‘Šã€‘\nè³‡æ–™åº«ä¸­å·²ç¶“æœ‰å®Œå…¨ç›¸åŒçš„å…§å®¹ï¼\nç³»çµ±æ‹’çµ•å­˜å…¥é‡è¤‡è³‡æ–™ã€‚'); 
                return; 
            }
            textLibrary.push({ content: content });
            contentInput.value = '';
            selectedLibIndex = textLibrary.length - 1;
            renderLibraryList();
            const container = document.getElementById('lib-list-container');
            container.scrollTop = container.scrollHeight;
        }

        function lib_delete() {
            if (selectedLibIndex === -1) { alert('è«‹å…ˆé»é¸åˆ—è¡¨ä¸­çš„æ–‡å­—è¡Œé€²è¡Œåç™½ï¼'); return; }
            const item = textLibrary[selectedLibIndex];
            if(confirm(`ã€åˆªé™¤ç¢ºèªã€‘\n\næ‚¨ç¢ºå®šè¦åˆªé™¤é¸å–çš„å…§å®¹å—ï¼Ÿ\n"${item.content.substring(0, 20)}..."\n\næ­¤å‹•ä½œå°‡ç„¡æ³•å¾©åŸï¼`)) {
                textLibrary.splice(selectedLibIndex, 1);
                selectedLibIndex = -1; 
                renderLibraryList();
            }
        }

        function lib_insert_at_cursor() {
            if (selectedLibIndex === -1) { alert('è«‹å…ˆé»é¸åˆ—è¡¨ä¸­çš„æ–‡å­—è¡Œé€²è¡Œåç™½ï¼'); return; }
            const txtToInsert = textLibrary[selectedLibIndex].content;
            const textarea = document.getElementById('edit-content');
            if (textarea.selectionStart || textarea.selectionStart == '0') {
                var startPos = textarea.selectionStart;
                var endPos = textarea.selectionEnd;
                textarea.value = textarea.value.substring(0, startPos) + txtToInsert + textarea.value.substring(endPos, textarea.value.length);
                textarea.focus();
                textarea.selectionStart = startPos + txtToInsert.length;
                textarea.selectionEnd = startPos + txtToInsert.length;
            } else {
                textarea.value += txtToInsert;
                textarea.focus();
            }
        }

        function applyCurrentEdit(silent = false) {
            if (!currentEditId) return;
            const idx = cardsData.findIndex(c => c.id === currentEditId);
            if (idx === -1) return;

            const domType = document.getElementById('edit-type').value;
            const domTitle = document.getElementById('edit-title').value;
            const domTitleScale = document.getElementById('edit-title-scale').value;
            
            const domTag = document.getElementById('edit-tag').value;
            const domColor = document.getElementById('edit-color').value;
            const rawContent = document.getElementById('edit-content').value;

            let finalContent;
            const singleTextTypes = ['cover', 'intro', 'chapter', 'quote', 'stat', 'contact', 'focus', 'total_toc'];
            
            if (singleTextTypes.includes(domType)) {
                finalContent = rawContent;
            } else {
                finalContent = rawContent.split('\n').filter(l => l.trim() !== '');
            }

            const updatedCard = { 
                ...cardsData[idx], 
                type: domType, 
                title: domTitle, 
                titleScale: domTitleScale, 
                tag: domTag, 
                color: domColor 
            };
            
            if (typeof finalContent === 'string') { updatedCard.content = finalContent; delete updatedCard.list; } 
            else { updatedCard.list = finalContent; delete updatedCard.content; }

            cardsData[idx] = updatedCard;
            updateMemoryState();
            if (!silent) alert('ä¿®æ”¹å·²æš«å­˜ï¼\nè¨˜å¾—é»æ“Šä¸Šæ–¹ã€Œå„²å­˜ä¸¦ä¸‹è¼‰ã€ä»¥æ°¸ä¹…ä¿å­˜ã€‚');
        }

        // --- Navigation Logic ---
        
        let toastTimeout;
        function showToast(msg) {
            const t = document.getElementById('toast-notification');
            if(!t) return;
            t.innerText = msg;
            t.classList.add('show');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                t.classList.remove('show');
            }, 2000);
        }

        window.changePage = function(dir) {
            const newIndex = viewingStartIndex + dir;
            if (newIndex < 0) {
                showToast("å·²ç¶“æ˜¯ç¬¬ä¸€é å›‰ï¼");
                return;
            }
            if (newIndex >= cardsData.length) {
                showToast("å·²ç¶“æ˜¯æœ€å¾Œä¸€é å›‰ï¼");
                return;
            }
            
            viewingStartIndex = newIndex;
            renderCards();
        };

        window.jumpToCard = function(id) {
            const idx = cardsData.findIndex(c => c.id === id);
            if (idx === -1) return; 
            viewingStartIndex = idx;
            renderCards();
        };

        window.jumpToTOC = function() {
            const tocCard = cardsData.find(c => c.type === 'total_toc');
            if(tocCard) {
                jumpToCard(tocCard.id);
            } else {
                alert("ç›®å‰æ²’æœ‰è¨­å®šã€Œè‡ªå‹•ç¸½ç›®éŒ„ã€é é¢ã€‚");
            }
        };

        // --- Render Logic ---
        function renderCards() {
            const container = document.getElementById('card-stack');
            container.innerHTML = '';
            
            cardsData.forEach((data, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                // â˜… é—œéµä¿®æ­£ï¼šè‹¥ç‚ºç¸½ç›®éŒ„ï¼ŒåŠ ä¸Šç‰¹å®š class ä»¥ä¾› CSS è¾¨è­˜
                if (data.type === 'total_toc') {
                    card.classList.add('print-full-page');
                }

                card.style.setProperty('--text-color', data.color || '#594a42');
                card.style.color = 'var(--text-color)';
                
                let inner = `<div class="card-sheen"></div><div class="card-content w-full h-full relative">`;
                
                // æ’å…¥é ç¢¼
                inner += `<div class="card-page-num">${i + 1}</div>`;

                if (data.type !== 'total_toc') {
                    inner += `<button onclick="jumpToTOC()" class="back-btn" title="å›ç¸½ç›®éŒ„">back</button>`;
                }

                if (!['cover','chapter','total_toc'].includes(data.type)) { 
                    inner += `<div class="absolute top-6 right-6 writing-vertical text-xs tracking-widest opacity-50 border-l border-current pl-2" style="writing-mode: vertical-rl; border-color: var(--text-color);">${data.tag || ''}</div>`; 
                }

                const parseRichText = (str) => {
                    if (!str) return '';
                    let temp = str.replace(/\[link:(.*?)\](.*?)\[\/link\]/g, '<a href="$1" target="_blank" style="text-decoration:underline; cursor:pointer;">$2</a>');
                    temp = temp.replace(/\[color:(#[0-9a-fA-F]{6})\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
                    return temp;
                };

                const parseLink = (str) => { 
                    if(!str) return { text: '', url: '#' }; 
                    const parts = str.split('##'); 
                    const processedText = parseRichText(parts[0].trim());
                    return { text: processedText, url: parts[1] ? parts[1].trim() : null }; 
                };
                
                const makeLink = (text, url, cls='') => { if(url && url !== '#') return `<a href="${url}" target="_blank" class="${cls}" onclick="event.stopPropagation()">${text}</a>`; return text; };

                const getTitleHtml = (text) => {
                    const scale = data.titleScale || '100';
                    return `<span style="font-size: ${scale}%">${text}</span>`;
                };

                switch(data.type) {
                    case 'total_toc': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-8 overflow-hidden"><h2 class="text-2xl font-bold mb-6 tracking-widest text-center font-title border-b border-current pb-4">${getTitleHtml(data.title)}</h2><div class="overflow-y-auto pr-2 space-y-3 h-full custom-scrollbar">`;
                        cardsData.forEach((c, idx) => {
                            if(c.id === data.id) return; 
                            inner += `<div onclick="jumpToCard('${c.id}')" class="cursor-pointer border-b border-dotted border-current/30 pb-1 hover:bg-black/5 transition flex justify-between items-end"><span class="text-sm font-bold opacity-80 truncate mr-2">${c.title || 'ç„¡æ¨™é¡Œ'}</span><span class="text-xs opacity-50 font-mono">P.${idx+1}</span></div>`;
                        });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'cover': { 
                        const {text, url} = parseLink(data.content); 
                        inner += `<div class="flex flex-col items-center justify-center h-full text-center px-4"><div class="mb-4 text-xs tracking-[0.4em] opacity-60 border-b border-current pb-2" style="border-color: var(--text-color);">${data.tag || 'COVER'}</div><h1 class="text-5xl font-bold mb-6 tracking-widest leading-snug font-title">${getTitleHtml(data.title)}</h1><div class="w-12 h-1 bg-current opacity-20 mb-8"></div><p class="text-xl font-serif italic tracking-widest opacity-80 whitespace-pre-wrap font-body">${makeLink(text, url, 'text-link')}</p></div>`; 
                        break; 
                    }
                    case 'intro': {
                        const processedContent = parseRichText(data.content);
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-8"><h2 class="text-3xl font-bold mb-8 tracking-widest font-title">${getTitleHtml(data.title)}</h2><div class="text-base leading-loose text-left opacity-90 whitespace-pre-wrap font-body">${processedContent}</div></div>`;
                        break;
                    }
                    case 'toc': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-8"><h2 class="text-2xl font-bold mb-10 tracking-widest border-b border-current pb-4 text-center font-title">${getTitleHtml(data.title)}</h2><div class="space-y-4 font-body">`;
                        (data.list||[]).forEach(l => { const {text, url} = parseLink(l); inner += `<div class="flex items-end"><span class="font-bold opacity-80">${text}</span><div class="flex-grow border-b-2 border-dotted border-current opacity-30 mx-2 mb-1"></div><span class="font-serif opacity-60">${url || ''}</span></div>`; });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'chapter': {
                        const processedContent = parseRichText(data.content);
                        inner += `<div class="w-full h-full flex flex-col items-center justify-center relative overflow-hidden"><div class="absolute text-[200px] font-serif opacity-5 select-none" style="top:50%; left:50%; transform:translate(-50%, -50%);">${data.tag}</div><h2 class="text-sm tracking-[0.5em] mb-4 opacity-60 uppercase">CHAPTER ${data.tag}</h2><h1 class="text-4xl font-bold tracking-widest font-title border-y-2 border-current py-6 px-4">${getTitleHtml(data.title)}</h1><p class="mt-6 tracking-widest opacity-60">${processedContent || ''}</p></div>`;
                        break;
                    }
                    case 'quote': { 
                        const {text} = parseLink(data.content); 
                        inner += `<div class="flex flex-col items-center justify-center h-full text-center px-8"><i class="fas fa-quote-left text-3xl opacity-20 mb-6"></i><h2 class="text-2xl font-serif leading-loose tracking-widest opacity-90 whitespace-pre-wrap font-title">${text}</h2><div class="mt-8 w-full text-right font-bold opacity-60 text-sm"><span>â€” ${getTitleHtml(data.title)}</span></div></div>`; 
                        break; 
                    }
                    case 'standard': { 
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-8"><h2 class="text-3xl font-bold mb-10 tracking-widest font-title decoration-wavy underline decoration-current/30 underline-offset-8">${getTitleHtml(data.title)}</h2><ul class="space-y-5 font-body">`; 
                        (data.list||[]).forEach(l => { const {text} = parseLink(l); inner += `<li class="flex items-start"><span class="mr-3 mt-2 w-1.5 h-1.5 rounded-full bg-current opacity-60 flex-shrink-0"></span><span class="text-lg opacity-90 leading-relaxed">${text}</span></li>`; }); 
                        inner += `</ul></div>`; 
                        break; 
                    }
                    case 'numbered': {
                        inner += `<div class="w-full h-full flex flex-col pt-14 px-6"><h2 class="text-2xl font-bold mb-8 tracking-widest font-title border-b border-current pb-2">${getTitleHtml(data.title)}</h2><div class="space-y-6">`;
                        (data.list||[]).forEach((l, i) => { const {text} = parseLink(l); inner += `<div class="flex items-start gap-4"><div class="w-8 h-8 rounded-full border border-current flex items-center justify-center flex-shrink-0 font-serif font-bold opacity-80">${i+1}</div><div class="pt-1 text-lg opacity-90 font-body">${text}</div></div>`; });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'checklist': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-8"><h2 class="text-2xl font-bold mb-8 tracking-widest font-title text-center bg-black/5 py-2 rounded">${getTitleHtml(data.title)}</h2><div class="space-y-4">`;
                        (data.list||[]).forEach(l => { const {text} = parseLink(l); inner += `<div class="flex items-center gap-3 p-2 border-b border-current/20"><i class="far fa-check-square text-xl opacity-60"></i><span class="text-lg opacity-90">${text}</span></div>`; });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'grid': { 
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-4"><h2 class="text-2xl font-bold mb-8 tracking-widest opacity-90 text-center font-title">${getTitleHtml(data.title)}</h2><div class="grid grid-cols-2 gap-4 w-full">`; 
                        (data.list||[]).forEach(l => { const {text, url} = parseLink(l); inner += `<div class="grid-box h-24 flex items-center justify-center cursor-pointer hover:bg-black/5" onclick="${url?`window.open('${url}')`:''}"><span class="font-bold text-lg opacity-80 font-body">${text}</span></div>`; }); 
                        inner += `</div></div>`; 
                        break; 
                    }
                    case 'grid3': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-4"><h2 class="text-2xl font-bold mb-6 tracking-widest opacity-90 text-center font-title">${getTitleHtml(data.title)}</h2><div class="grid grid-cols-2 gap-3 w-full">`;
                        (data.list||[]).forEach(l => { const {text} = parseLink(l); inner += `<div class="border border-current rounded p-3 text-center flex items-center justify-center aspect-[4/3]"><span class="font-bold opacity-80 leading-tight">${text}</span></div>`; });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'stat': {
                        const parts = data.content.split('##');
                        const mainVal = parts[0]; const subVal = parts[1] || '';
                        inner += `<div class="w-full h-full flex flex-col items-center justify-center px-6"><h3 class="text-xl tracking-widest opacity-60 mb-6 uppercase">${getTitleHtml(data.title)}</h3><div class="text-6xl font-bold font-serif mb-4 tracking-tighter">${mainVal}</div><div class="text-lg opacity-80 font-body bg-current text-white px-4 py-1 rounded-full" style="background-color: var(--text-color);">${subVal}</div></div>`;
                        break;
                    }
                    case 'keyvalue': { 
                        inner += `<div class="w-full h-full flex flex-col justify-center px-6"><h2 class="text-center text-2xl font-bold mb-10 tracking-widest opacity-90 font-title">${getTitleHtml(data.title)}</h2><div class="space-y-4 w-full">`; 
                        (data.list||[]).forEach(l => { const {text, url} = parseLink(l); inner += `<div class="key-value"><span class="text-lg font-medium opacity-80 w-full flex justify-between font-body">${text}<span class="font-bold">${url||''}</span></span></div>`; }); 
                        inner += `</div></div>`; 
                        break; 
                    }
                    case 'chart': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-6"><h2 class="text-2xl font-bold mb-8 tracking-widest text-center font-title">${getTitleHtml(data.title)}</h2><div class="flex-1 flex flex-col justify-center">`;
                        const maxVal = Math.max(...(data.list||[]).map(l => parseFloat(l.split('##')[1]) || 0));
                        (data.list||[]).forEach(l => {
                            const parts = l.split('##'); const label = parts[0]; const val = parseFloat(parts[1]) || 0;
                            const pct = (val / maxVal) * 100;
                            inner += `<div class="bar-container"><div class="bar-label font-bold">${label}</div><div class="bar-track"><div class="bar-fill" style="width: ${pct}%"></div></div><div class="bar-value">${val}</div></div>`;
                        });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'comparison': {
                        inner += `<div class="w-full h-full flex flex-col pt-14 px-4"><h2 class="text-2xl font-bold mb-6 tracking-widest text-center font-title">${getTitleHtml(data.title)}</h2><div class="flex-1 border-t-2 border-b-2 border-current py-4 overflow-hidden"><div class="grid grid-cols-2 h-full divide-x divide-current/30"><div class="px-2 space-y-4 text-center"><div class="font-bold text-sm opacity-50 mb-2">ä¸€èˆ¬æ–¹æ¡ˆ</div>`;
                        const lefts = [], rights = [];
                        (data.list||[]).forEach(l => { const parts=l.split('##'); lefts.push(parts[0]); rights.push(parts[1]||''); });
                        inner += lefts.map(t=>`<div class="text-sm py-2 border-b border-dotted border-current/20 h-16 flex items-center justify-center">${parseRichText(t)}</div>`).join('');
                        inner += `</div><div class="px-2 space-y-4 text-center"><div class="font-bold text-sm opacity-50 mb-2">æœ¬æ–¹æ¡ˆ</div>`;
                        inner += rights.map(t=>`<div class="text-sm font-bold py-2 border-b border-dotted border-current/20 h-16 flex items-center justify-center">${parseRichText(t)}</div>`).join('');
                        inner += `</div></div></div></div>`;
                        break;
                    }
                    case 'table': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-6"><h2 class="text-2xl font-bold mb-6 tracking-widest text-center font-title">${getTitleHtml(data.title)}</h2><table class="w-full text-sm border-collapse"><thead><tr class="border-b-2 border-current"><th class="py-2 text-left w-1/2">é …ç›®</th><th class="py-2 text-right">å…§å®¹</th></tr></thead><tbody>`;
                        (data.list||[]).forEach(l => { const parts = l.split('##'); inner += `<tr class="border-b border-current/10"><td class="py-3 font-bold opacity-80">${parseRichText(parts[0])}</td><td class="py-3 text-right opacity-90">${parseRichText(parts[1]||'')}</td></tr>`; });
                        inner += `</tbody></table></div>`;
                        break;
                    }
                    case 'timeline': { 
                        inner += `<div class="w-full h-full flex flex-col pt-14 px-8"><h2 class="text-2xl font-bold mb-8 tracking-widest opacity-90 border-b border-current pb-2 font-title">${getTitleHtml(data.title)}</h2><div class="pl-2">`; 
                        (data.list||[]).forEach(l => { const {text} = parseLink(l); inner += `<div class="timeline-item"><div class="font-bold text-lg opacity-90 font-body">${text}</div></div>`; }); 
                        inner += `</div></div>`; 
                        break; 
                    }
                    case 'process': {
                        inner += `<div class="w-full h-full flex flex-col pt-16 px-6"><h2 class="text-2xl font-bold mb-10 tracking-widest text-center font-title">${getTitleHtml(data.title)}</h2><div class="flex-1 flex flex-col gap-4">`;
                        (data.list||[]).forEach((l,i) => { const {text} = parseLink(l); inner += `<div class="flex items-center"><div class="w-full border border-current rounded p-3 text-center font-bold relative">${text}${i<(data.list.length-1)?`<div class="absolute -bottom-5 left-1/2 -translate-x-1/2 text-current"><i class="fas fa-arrow-down"></i></div>`:''}</div></div>${i<(data.list.length-1)?`<div class="h-4"></div>`:''}`; });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'qa': {
                        inner += `<div class="w-full h-full flex flex-col pt-14 px-6"><h2 class="text-2xl font-bold mb-6 tracking-widest text-center font-title decoration-4 underline decoration-current/20">${getTitleHtml(data.title)}</h2><div class="space-y-6 overflow-y-auto">`;
                        (data.list||[]).forEach(l => { 
                            const parts = l.split('##'); 
                            const q = parseRichText(parts[0].replace('Q:', '').trim()); 
                            const a = parseRichText((parts[1]||'').replace('A:', '').trim()); 
                            inner += `<div><div class="font-bold text-lg mb-1 flex gap-2"><span class="opacity-50">Q.</span><span>${q}</span></div><div class="text-sm opacity-80 pl-6 border-l-2 border-current/30 ml-1 py-1">${a}</div></div>`; 
                        });
                        inner += `</div></div>`;
                        break;
                    }
                    case 'warning': { 
                        inner += `<div class="w-full h-full flex flex-col justify-center px-6"><div class="border-2 border-current p-6 relative"><span class="absolute -top-3 left-4 bg-[#f9f6ea] px-2 font-bold tracking-widest text-sm opacity-80 font-title" style="background-color: var(--card-bg);">${getTitleHtml(data.title)}</span><ul class="list-disc pl-5 space-y-3 opacity-80 font-medium font-body text-sm leading-relaxed">${(data.list||[]).map(l => `<li>${parseLink(l).text}</li>`).join('')}</ul></div></div>`; 
                        break; 
                    }
                    case 'contact': { 
                        const {text, url} = parseLink(data.content); 
                        inner += `<div class="w-full h-full flex flex-col items-center justify-center px-6 text-center"><div class="w-20 h-20 rounded-full border-2 border-current flex items-center justify-center mb-6 text-3xl opacity-80"><i class="fas fa-user"></i></div><h2 class="text-2xl font-bold mb-6 tracking-widest font-title">${getTitleHtml(data.title)}</h2><p class="text-lg opacity-80 whitespace-pre-wrap leading-loose font-body">${makeLink(text, url, 'text-link')}</p></div>`; 
                        break; 
                    }
                    default: inner += `<div class="flex items-center justify-center h-full">Unknown Type</div>`;
                }

                inner += `</div>`;
                card.innerHTML = inner;
                card.style.touchAction = "none"; 

                // æ¸²æŸ“é †åºé‚è¼¯ï¼šåªé¡¯ç¤º currentï¼Œé è¼‰ current+1
                if (i < viewingStartIndex) {
                    card.style.display = 'none';
                } else if (i === viewingStartIndex) {
                    card.style.zIndex = 100;
                    card.style.display = 'flex';
                    card.style.transform = 'scale(1) translate(0,0)'; 
                    card.style.opacity = 1; 
                    card.style.pointerEvents = 'auto';
                } else {
                    let offset = i - viewingStartIndex;
                    card.style.zIndex = 100 - offset;
                    
                    if (offset === 1) {
                         card.style.display = 'flex';
                         card.style.transform = 'scale(0.98)'; 
                         card.style.opacity = 0.5;
                         card.style.pointerEvents = 'none';
                    } else {
                         card.style.display = 'none';
                    }
                }
                
                container.appendChild(card);
            });
            initStackInteraction();
        }

        function initStackInteraction() {
            const cards = Array.from(document.querySelectorAll('.card'));
            if (cards.length === 0 || viewingStartIndex >= cards.length) return;
            
            const topCard = cards[viewingStartIndex];
            
            if (topCard._pointerDownHandler) {
                topCard.removeEventListener('pointerdown', topCard._pointerDownHandler);
            }

            let isDragging = false;
            let startX = 0;
            let currentX = 0;
            let isDraggingWarned = false; // æ–°å¢ï¼šé˜²æ­¢æ‹–æ›³æ™‚é‡è¤‡è§¸ç™¼æç¤º

            const handlePointerDown = function(e) {
                if (e.target.closest('a') || e.target.closest('button') || e.target.closest('.cursor-pointer')) return;
                if (e.button !== 0 && e.pointerType === 'mouse') return;

                isDragging = true;
                isDraggingWarned = false; // é‡ç½®æç¤ºç‹€æ…‹
                startX = e.clientX;
                currentCard = topCard; 
                topCard.style.transition = 'none'; 
                try { topCard.setPointerCapture(e.pointerId); } catch(e){}

                document.addEventListener('pointermove', handlePointerMove);
                document.addEventListener('pointerup', handlePointerUp);
                document.addEventListener('pointercancel', handlePointerUp);
            };

            const handlePointerMove = function(e) {
                if(!isDragging) return; 
                if (e.cancelable) e.preventDefault();
                const cx = e.clientX;
                
                let tempX = (cx - startX) / currentScaleFactor; 

                // --- é‚Šç•Œæª¢æŸ¥èˆ‡è­¦èª ---
                // ç¬¬ä¸€é å¾€å³æ»‘ (æ•¸å€¼å¤§æ–¼ 50 è¦–ç‚ºæ„åœ–æ˜ç¢º)
                if (viewingStartIndex === 0 && tempX > 50) { 
                    if (!isDraggingWarned) {
                        showToast("å·²ç¶“æ˜¯ç¬¬ä¸€é å›‰ï¼");
                        isDraggingWarned = true;
                    }
                    tempX = 0; // é–å®š
                }
                // æœ€å¾Œä¸€é å¾€å·¦æ»‘ (æ•¸å€¼å°æ–¼ -50)
                if (viewingStartIndex === cardsData.length - 1 && tempX < -50) {
                    if (!isDraggingWarned) {
                        showToast("å·²ç¶“æ˜¯æœ€å¾Œä¸€é å›‰ï¼");
                        isDraggingWarned = true;
                    }
                    tempX = 0; // é–å®š
                }

                currentX = tempX;
                
                if (currentX === 0) return; 

                topCard.style.transform = `translateX(${currentX}px) rotate(${currentX * 0.05}deg)`; 
                const sheen = topCard.querySelector('.card-sheen'); 
                if(sheen) sheen.style.opacity = Math.min(Math.abs(currentX)/300, 0.4); 
            };

            const handlePointerUp = function(e) {
                if(!isDragging) return; 
                isDragging = false; 
                try { topCard.releasePointerCapture(e.pointerId); } catch(e){}
                document.removeEventListener('pointermove', handlePointerMove);
                document.removeEventListener('pointerup', handlePointerUp);
                document.removeEventListener('pointercancel', handlePointerUp);

                topCard.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1)'; 
                
                // æ»‘å‹•éˆæ•åº¦
                if(Math.abs(currentX) > 80) { 
                    const dir = currentX > 0 ? 1 : -1; 
                    topCard.style.transform = `translateX(${dir * 1200}px) rotate(${dir * 20}deg)`; 
                    
                    setTimeout(() => { 
                        // dir=1 (å‘å³æ»‘) -> å›ä¸Šä¸€é  (-1)
                        // dir=-1 (å‘å·¦æ»‘) -> å»ä¸‹ä¸€é  (+1)
                        if (dir === 1) {
                            changePage(-1);
                        } else {
                            changePage(1);
                        }
                    }, 200); 
                } else { 
                    topCard.style.transform = 'translate(0,0)'; 
                    adjustLayout();
                } 
                currentX = 0; 
            };

            topCard._pointerDownHandler = handlePointerDown;
            topCard.addEventListener('pointerdown', handlePointerDown);
        }

        const hints = { 
            total_toc: 'è‡ªå‹•ç”Ÿæˆç›®éŒ„ï¼Œç„¡éœ€ç·¨è¼¯å…§å®¹',
            cover: 'è¼¸å…¥æ¨™é¡Œèˆ‡å‰¯æ¨™ (æ›è¡Œ)', intro: 'è¼¸å…¥é•·ç¯‡æ–‡å­—æ®µè½ (å°‡è‡ªå‹•æ›è¡Œï¼Œä¸è‡ªå‹•ç¸®æ’)', toc: 'æ ¼å¼ï¼šé …ç›®åç¨±## é ç¢¼ (ä¾‹ï¼šæ ¸å¿ƒåƒ¹å€¼## P.01)', chapter: 'è¼¸å…¥ç« ç¯€åç¨±ï¼Œæ¨™ç±¤æ¬„è«‹è¼¸å…¥æ•¸å­—', 
            quote: 'è¼¸å…¥å¼•è¨€å…§å®¹ï¼Œæ¨™é¡Œæ¬„è«‹è¼¸å…¥ä½œè€…', standard: 'æ¯è¡Œä¸€å€‹é …ç›®', numbered: 'æ¯è¡Œä¸€å€‹é …ç›®ï¼Œå°‡è‡ªå‹•ç·¨è™Ÿ', checklist: 'æ¯è¡Œä¸€å€‹æª¢æŸ¥é …ç›®', 
            grid: 'æ¯è¡Œä¸€å€‹é …ç›® (é©åˆçŸ­å­—)', grid3: 'æ¯è¡Œä¸€å€‹é …ç›® (3x2 æ’åˆ—)', stat: 'æ ¼å¼ï¼šä¸»è¦æ•¸å­—## èªªæ˜æ–‡å­— (ä¾‹ï¼š20%## å¹´åŒ–å ±é…¬)', keyvalue: 'æ ¼å¼ï¼šé …ç›®## æ•¸å€¼ (ä¾‹ï¼šå¹´é½¡## 30æ­²)',
            chart: 'æ ¼å¼ï¼šæ¨™ç±¤## æ•¸å€¼ (ä¾‹ï¼šç¬¬äº”å¹´## 100)', comparison: 'æ ¼å¼ï¼šå·¦æ¬„## å³æ¬„ (ä¾‹ï¼šå‚³çµ±éšª## æŠ•è³‡å‹)', table: 'æ ¼å¼ï¼šå·¦æ¬„## å³æ¬„',
            timeline: 'æ¯è¡Œä¸€å€‹æ™‚é–“é»äº‹ä»¶', process: 'æ¯è¡Œä¸€å€‹æµç¨‹æ­¥é©Ÿ', qa: 'æ ¼å¼ï¼šQ:å•é¡Œ## A:ç­”æ¡ˆ', warning: 'æ¯è¡Œä¸€å€‹è­¦å‘Šäº‹é …', contact: 'è¼¸å…¥è¯çµ¡è³‡è¨Š'
        };
        const editType = document.getElementById('edit-type');
        editType.addEventListener('change', () => { document.getElementById('hint-text').innerText = 'æç¤ºï¼š' + (hints[editType.value] || 'è¼¸å…¥å…§å®¹...'); });
        
        document.getElementById('start-btn').onclick = () => { document.getElementById('start-overlay').style.opacity = 0; setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500); };
        
        document.getElementById('admin-btn').onclick = () => { 
            document.getElementById('admin-panel').style.display = 'flex'; 
            renderSidebar(); 
            adjustLayout(); 
            if(!currentEditId) showEditor(null); 
        };
        document.getElementById('close-admin-btn').onclick = () => {
            document.getElementById('admin-panel').style.display = 'none';
            adjustLayout(); 
        };

        document.getElementById('add-page-btn').onclick = () => { 
            const newId = 'c_' + Date.now(); 
            cardsData.push({ id: newId, type: 'standard', title: 'æ–°é é¢', tag: 'NEW', color: '#594a42', list: ['é»æ“Šç·¨è¼¯å…§å®¹...'] }); 
            updateMemoryState(); 
            selectCard(newId); 
        };

        document.getElementById('reset-data-btn').onclick = () => { if(confirm('é‡ç½®å°‡éºå¤±æ‰€æœ‰ä¿®æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ')) { window.bakedData = null; initData(); updateMemoryState(); showEditor(null); } };
        document.getElementById('apply-change-btn').onclick = () => applyCurrentEdit(false);
        
        document.getElementById('delete-page-btn').onclick = () => { 
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { 
                cardsData = cardsData.filter(c => c.id !== currentEditId); 
                if(viewingStartIndex >= cardsData.length) viewingStartIndex = Math.max(0, cardsData.length - 1);
                updateMemoryState(); 
                showEditor(null); 
            } 
        };
        
        function renderSidebar() {
            const list = document.getElementById('page-list-container');
            list.innerHTML = '';
            cardsData.forEach((card, i) => {
                const item = document.createElement('div');
                item.className = `admin-card-item ${card.id === currentEditId ? 'active' : ''}`;
                item.onclick = () => selectCard(card.id);
                item.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><span class="bg-gray-200 text-gray-500 w-6 h-6 flex-shrink-0 flex items-center justify-center rounded-full text-xs font-mono">${i + 1}</span><div class="truncate"><div class="font-bold text-gray-700 text-sm truncate">${card.title || 'ç„¡æ¨™é¡Œ'}</div><div class="text-xs text-gray-400 uppercase">${card.type}</div></div></div><div class="flex items-center gap-1 ml-2"><button class="text-blue-400 hover:text-blue-600 p-2 text-sm" onclick="duplicateCard(event, ${i})"><i class="fas fa-copy"></i></button><div class="flex flex-col"><button class="text-gray-400 hover:text-gray-600 px-1 text-xs" onclick="moveItem(event, ${i}, -1)">â–²</button><button class="text-gray-400 hover:text-gray-600 px-1 text-xs" onclick="moveItem(event, ${i}, 1)">â–¼</button></div></div>`;
                list.appendChild(item);
            });
        }
        
        window.duplicateCard = function(e, index) { 
            e.stopPropagation(); 
            const copy = JSON.parse(JSON.stringify(cardsData[index])); 
            copy.id = 'c_' + Date.now(); 
            copy.title += ' (è¤‡è£½)'; 
            cardsData.splice(index + 1, 0, copy); 
            updateMemoryState(); 
        };

        window.moveItem = function(e, index, dir) { 
            e.stopPropagation(); 
            if (index + dir < 0 || index + dir >= cardsData.length) return; 

            let newViewIndex = viewingStartIndex;
            if (index === viewingStartIndex) {
                newViewIndex = index + dir;
            } else if (index + dir === viewingStartIndex) {
                newViewIndex = index;
            }

            [cardsData[index], cardsData[index + dir]] = [cardsData[index + dir], cardsData[index]]; 
            
            viewingStartIndex = newViewIndex;
            updateMemoryState(); 
        };

        function selectCard(id) {
            currentEditId = id; renderSidebar();
            const card = cardsData.find(c => c.id === id);
            if(card) {
                editType.value = card.type; 
                document.getElementById('edit-title').value = card.title; 
                
                const scaleVal = card.titleScale || '100';
                const select = document.getElementById('edit-title-scale');
                
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === scaleVal) {
                        exists = true;
                        break;
                    }
                }
                
                if (!exists) {
                    const opt = new Option(`${scaleVal}%`, scaleVal);
                    select.add(opt, select.options[select.length-1]);
                }
                
                select.value = scaleVal;

                document.getElementById('edit-tag').value = card.tag || ''; 
                document.getElementById('edit-color').value = card.color || '#594a42';
                if (['cover', 'intro', 'chapter', 'quote', 'stat', 'contact', 'focus', 'total_toc'].includes(card.type)) { document.getElementById('edit-content').value = card.content || ''; } 
                else { document.getElementById('edit-content').value = (card.list || []).join('\n'); }
                document.getElementById('hint-text').innerText = 'æç¤ºï¼š' + (hints[card.type] || 'è¼¸å…¥å…§å®¹...');
                showEditor(true); document.getElementById('editing-id-display').innerText = `ID: ${id}`;
                
                window.jumpToCard(id);
            }
        }
        function showEditor(show) { if(show) { document.getElementById('editor-form').classList.remove('hidden'); document.getElementById('editor-empty').classList.add('hidden'); } else { document.getElementById('editor-form').classList.add('hidden'); document.getElementById('editor-empty').classList.remove('hidden'); currentEditId = null; } }

        document.getElementById('save-file-btn').onclick = () => {
            if(currentEditId) applyCurrentEdit(true);

            const currentData = { cards: cardsData, style: styleConfig, library: textLibrary };
            const dataString = JSON.stringify(currentData);

            const originalScript = document.getElementById('main-script').innerHTML;
            
            const dataBlockRegex = /\/\/ --- DATA START ---[\s\S]*?\/\/ --- DATA END ---/;
            const newDataBlock = `// --- DATA START ---\n        window.bakedData = ${dataString};\n        // --- DATA END ---`;
            
            let newScript = originalScript;
            if (dataBlockRegex.test(originalScript)) {
                newScript = originalScript.replace(dataBlockRegex, newDataBlock);
            } else {
                newScript = originalScript.replace(/window\.bakedData\s*=\s*null;/, newDataBlock);
            }

            const clone = document.body.cloneNode(true);
            
            const adminPanel = clone.querySelector('#admin-panel');
            if(adminPanel) adminPanel.style.display = 'none';

            const startOverlay = clone.querySelector('#start-overlay');
            if(startOverlay) {
                startOverlay.style.display = 'flex';
                startOverlay.style.opacity = '1';
            }

            const stack = clone.querySelector('#card-stack');
            if(stack) stack.innerHTML = '';

            const editorForm = clone.querySelector('#editor-form');
            const editorEmpty = clone.querySelector('#editor-empty');
            if(editorForm) editorForm.classList.add('hidden');
            if(editorEmpty) editorEmpty.classList.remove('hidden');

            const htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    ${document.head.innerHTML}
</head>
<body class="${document.body.className}">
    ${clone.innerHTML.replace(/<script id="main-script">[\s\S]*?<\/script>/, `<script id="main-script">${newScript}<\/script>`)}
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `å‚³å®¶æ¨‚_å›ºå®šé †åºç‰ˆ_${new Date().getTime()}.html`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        };

        const printModal = document.getElementById('print-settings-modal');
        document.getElementById('print-file-btn').onclick = () => { applyCurrentEdit(true); printModal.classList.remove('hidden'); };
        window.closePrintModal = () => printModal.classList.add('hidden');
        
        // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåˆ—å°é‚è¼¯å„ªåŒ–ï¼Œé‡å°ç¸½ç›®éŒ„ (print-full-page) åŠ å…¥ç‰¹è¦ CSS
        window.executePrint = () => {
            const mode = document.querySelector('input[name="print_mode"]:checked').value;
            const layout = document.getElementById('print-layout').value;
            let gridCols = layout === '2' ? 1 : 2; 
            let css = `@media print { 
                @page { margin: 10mm; size: auto; } 
                #card-stack { 
                    display: grid !important;
                    grid-template-columns: repeat(${gridCols}, 1fr) !important; 
                    gap: 20px !important;
                }
                
                /* ç‰¹æ®Šè¦å‰‡ï¼šç¸½ç›®éŒ„å¼·åˆ¶æ»¿ç‰ˆä¸”åˆ†é  */
                .card.print-full-page {
                    grid-column: 1 / -1 !important;
                    width: 100% !important;
                    height: auto !important;
                    min-height: 95vh !important;
                    page-break-after: always !important;
                    page-break-inside: avoid !important;
                    overflow: visible !important;
                    border: none !important;
                    box-shadow: none !important;
                }
                .card.print-full-page .card-content {
                    height: auto !important;
                    overflow: visible !important;
                    display: block !important;
                }
                /* è®“ç¸½ç›®éŒ„å…§éƒ¨çš„æ²è»¸å®¹å™¨åœ¨åˆ—å°æ™‚å±•é–‹ */
                .card.print-full-page .overflow-y-auto {
                    overflow: visible !important;
                    height: auto !important;
                }
            `;
            if (mode === 'compress') css += `* { font-family: sans-serif !important; } .card::before, .card::after { display: none !important; } body { background: white !important; }`;
            css += `}`;
            document.getElementById('print-dynamic-style').innerHTML = css;
            printModal.classList.add('hidden');
            setTimeout(() => window.print(), 300);
        };

        initData();
    </script>
</body>
</html>