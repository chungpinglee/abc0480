<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¤ªç©ºé˜²è¡›æˆ° (è·¨å¹³å°éŸ³æ•ˆä¿®æ­£ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #00001a; position: relative; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; cursor: crosshair; position: absolute; top: 0; left: 0; z-index: 1; }
        .star { position: absolute; width: 2px; height: 2px; background-color: white; border-radius: 50%; animation-name: twinkle; animation-timing-function: ease-in-out; animation-iteration-count: infinite; animation-direction: alternate; z-index: 0; }
        @keyframes twinkle { 0% { opacity: 0.3; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }
        
        #startButton, #toggleSoundButton, #backButton {
            position: absolute;
            z-index: 10;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s ease, background-color 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #startButton { background-color: #FF69B4; }
        #toggleSoundButton { background-color: green; }
        #backButton { background-color: green; }

        #startButton:active, #toggleSoundButton:active, #backButton:active {
            transform: scale(0.95);
        }
        #backButton:hover {
            background-color: red;
            color: white;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <button id="startButton">é–‹å§‹éŠæˆ²</button>
    <button id="toggleSoundButton">é–‹å•ŸéŸ³æ•ˆ</button>
    <a id="backButton" href="ä¸»è¦å…¥å£.html">å›ä¸Šé </a>

    <script>
        // 1. åˆå§‹åŒ–è¨­å®š
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const toggleSoundButton = document.getElementById('toggleSoundButton');
        const backButton = document.getElementById('backButton');
        let width = window.innerWidth;
        let height = window.innerHeight;

        const fireworks = [], particles = [], spacecrafts = [];
        const gravity = 0.05;
        
        let score = 0;
        const GAME_TIME_LIMIT = 30;
        const STARTING_AMMO = 50;
        let gameTimeRemaining = GAME_TIME_LIMIT;
        let ammo = STARTING_AMMO;
        let isGameStarted = false;
        let isGameOver = false;
        let timerInterval = null;
        let gameOverReason = '';

        // éŸ³æ•ˆç›¸é—œåˆå§‹åŒ–
        let audioCtx = null;
        // ã€ä¸»è¦ä¿®æ”¹ã€‘éŸ³æ•ˆé è¨­ç‚ºé—œé–‰ï¼Œç­‰å¾…ä½¿ç”¨è€…æ‰‹å‹•é–‹å•Ÿä»¥ç¬¦åˆ Apple æ”¿ç­–
        let isSoundEnabled = false;

        // ã€ä¸»è¦ä¿®æ”¹ã€‘éŸ³æ•ˆåˆå§‹åŒ–å‡½æ•¸ï¼Œç¾åœ¨åªè² è²¬å‰µå»ºå¯¦ä¾‹
        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // 2. ç›£è½èˆ‡è™•ç†
        window.addEventListener('resize', setupCanvasAndObjects);

        function handleUserInteraction(e) {
            e.preventDefault();
            if (!isGameStarted || isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            const targetX = (e.clientX || e.touches[0].clientX) - rect.left;
            const targetY = (e.clientY || e.touches[0].clientY) - rect.top;
            launchFirework(targetX, targetY);
        }
        canvas.addEventListener('click', handleUserInteraction);
        canvas.addEventListener('touchstart', handleUserInteraction);

        startButton.addEventListener('click', () => {
            if (isGameOver) {
                restartGame();
            }
            startGame();
            startButton.style.display = 'none';
            toggleSoundButton.style.display = 'none';
            backButton.style.display = 'none';
        });

        // ã€ä¸»è¦ä¿®æ”¹ã€‘é‡å¯«éŸ³æ•ˆæŒ‰éˆ•çš„é»æ“Šé‚è¼¯ï¼Œé€™æ˜¯æ•´å€‹ä¿®æ­£çš„æ ¸å¿ƒ
        toggleSoundButton.addEventListener('click', () => {
            isSoundEnabled = !isSoundEnabled;

            if (isSoundEnabled) {
                // å¦‚æœæ˜¯å¾ã€Œé—œé–‰ã€åˆ‡æ›åˆ°ã€Œé–‹å•Ÿã€
                initAudioContext(); // ç¢ºä¿ AudioContext å·²å‰µå»º
                
                // å˜—è©¦å–šé†’ AudioContextï¼Œé€™æ˜¯é—œéµæ­¥é©Ÿ
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                // æ’­æ”¾ä¸€å€‹ç¢ºèªéŸ³æ•ˆï¼Œä»¥ç¢ºèªä¸¦éå›ºéŸ³æ•ˆè§£é–ç‹€æ…‹
                playUnlockSound();
                toggleSoundButton.textContent = 'é—œé–‰éŸ³æ•ˆ';

            } else {
                // å¦‚æœæ˜¯å¾ã€Œé–‹å•Ÿã€åˆ‡æ›åˆ°ã€Œé—œé–‰ã€
                toggleSoundButton.textContent = 'é–‹å•ŸéŸ³æ•ˆ';
            }
        });


        // 3. é¡åˆ¥å®šç¾© (Classes) - æ­¤éƒ¨åˆ†ç„¡è®Šæ›´
        class Spacecraft {
            constructor(config) { this.char = config.char; this.baseSize = config.size; this.baseSpeed = config.speed; this.initialYPercent = config.yPercent; this.isHit = false; this.respawnTimer = 0; this.reset(); }
            reset() { this.isHit = false; this.size = this.baseSize * (Math.random() * 0.4 + 0.8); this.speed = this.baseSpeed * (Math.random() * 0.4 + 0.8); this.x = -this.size; this.y = height * this.initialYPercent; this.vy = -(Math.random() * 0.1 + 0.05); }
            update() { if (isGameOver) return; if (this.isHit) { if (--this.respawnTimer <= 0) this.reset(); return; } this.x += this.speed; this.y += this.vy; if (this.x > width + this.size) this.reset(); }
            draw() { if (this.isHit) return; ctx.save(); ctx.font = `${this.size}px sans-serif`; ctx.fillText(this.char, this.x - this.size / 2, this.y + this.size / 2); ctx.restore(); }
            hit() { if (this.isHit) return; this.isHit = true; this.respawnTimer = 180; createSpacecraftExplosion(this.x, this.y); playExplosionSound(); if (this.char === 'ğŸ›¸') { score += 3; } else if (this.char === 'ğŸ›°ï¸') { score += 2; } else { score += 1; } }
        }
        class Particle { constructor(x, y, color, velocity, decayMultiplier = 1) { this.x = x; this.y = y; this.color = color; this.velocity = velocity; this.size = Math.random() * 2 + 1.5; this.alpha = 1; this.decay = (Math.random() * 0.015 + 0.015) * decayMultiplier; } update() { this.x += this.velocity.x; this.y += this.velocity.y; this.velocity.y += gravity; this.alpha -= this.decay; } draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill(); ctx.restore(); } }
        class Firework { constructor(startX, startY, endX, endY) { this.x = startX; this.y = startY; this.endX = endX; this.endY = endY; this.color = ['#FFD700', '#FF4500', '#ADFF2F', '#40E0D0', '#FF69B4', '#1E90FF'][Math.floor(Math.random() * 6)]; const angle = Math.atan2(endY - startY, endX - startX); const speed = 12; this.velocity = { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed }; this.trail = []; } update() { if(isGameOver) return; this.x += this.velocity.x; this.y += this.velocity.y; this.trail.push({ x: this.x, y: this.y }); if (this.trail.length > 5) this.trail.shift(); } draw() { ctx.beginPath(); ctx.moveTo(this.trail[0]?.x || this.x, this.trail[0]?.y || this.y); ctx.lineTo(this.x, this.y); ctx.strokeStyle = this.color; ctx.lineWidth = 2; ctx.stroke(); } }

        // 4. æ ¸å¿ƒåŠŸèƒ½å‡½å¼
        
        // ã€æ–°å¢ã€‘ä¸€å€‹ç°¡çŸ­çš„ç¢ºèªéŸ³æ•ˆï¼Œç”¨æ–¼åœ¨ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•æ™‚æ’­æ”¾ï¼Œä»¥è§£é– AudioContext
        function playUnlockSound() {
            if (!audioCtx || !isSoundEnabled) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 0.1);
        }

        // ã€ä¸»è¦ä¿®æ”¹ã€‘ç°¡åŒ–çˆ†ç‚¸éŸ³æ•ˆçš„æ’­æ”¾é‚è¼¯ã€‚ä¸å†éœ€è¦åœ¨æ­¤è™•å˜—è©¦ resume()ã€‚
        function playExplosionSound() {
            if (!audioCtx || !isSoundEnabled) return;
            // å› ç‚º AudioContext å·²ç¶“è¢« toggle æŒ‰éˆ•è§£é–ï¼Œæ‰€ä»¥é€™è£¡å¯ä»¥ç›´æ¥æ’­æ”¾
            _playActualExplosionSound();
        }

        function _playActualExplosionSound() {
            const now = audioCtx.currentTime;
            const duration = 0.5;
            const boom = audioCtx.createOscillator();
            const boomGain = audioCtx.createGain();
            boom.connect(boomGain);
            boomGain.connect(audioCtx.destination);
            boom.type = 'triangle'; boom.frequency.value = 100; boomGain.gain.setValueAtTime(0.5, now); boomGain.gain.exponentialRampToValueAtTime(0.01, now + duration * 0.8);
            
            const noise = audioCtx.createBufferSource();
            const noiseGain = audioCtx.createGain();
            const bufferSize = audioCtx.sampleRate * 0.5; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
            noise.buffer = buffer; noise.connect(noiseGain); noiseGain.connect(audioCtx.destination);
            noiseGain.gain.setValueAtTime(0.3, now); noiseGain.gain.exponentialRampToValueAtTime(0.01, now + duration);
            
            boom.start(now); noise.start(now); boom.stop(now + duration); noise.stop(now + duration);
        }


        function launchFirework(targetX, targetY) { if (isGameOver || ammo <= 0) return; ammo--; fireworks.push(new Firework(width / 2, height, targetX, targetY)); }
        function createFireworkExplosion(x,y,color){ const pC=50; const aI=(Math.PI*2)/pC; for(let i=0;i<pC;i++){ const s=Math.random()*2.5+1; const v={x:Math.cos(aI*i)*s,y:Math.sin(aI*i)*s}; particles.push(new Particle(x,y,color,v)) } }
        function createSpacecraftExplosion(x,y){ const pC=200,c=['#ffc300','#ff5733','#c70039','#900c3f','#581845']; for(let i=0;i<pC;i++){ const s=Math.random()*8+2,a=Math.random()*Math.PI*2,v={x:Math.cos(a)*s,y:Math.sin(a)*s},cl=c[Math.floor(Math.random()*c.length)]; particles.push(new Particle(x,y,cl,v,0.7)) } }
        function checkCollisions(explosionX, explosionY) { if(isGameOver) return; for (const craft of spacecrafts) { if (craft.isHit) continue; const distance = Math.hypot(explosionX - craft.x, explosionY - craft.y); if (distance < craft.size) { craft.hit(); } } }
        function setupSpacecrafts() { spacecrafts.length = 0; const configs = [ { char: 'ğŸ›¸', size: 35, speed: 1.2, yPercent: 0.05 }, { char: 'ğŸ›¸', size: 38, speed: 1.5, yPercent: 0.12 }, { char: 'ğŸ›¸', size: 32, speed: 1.0, yPercent: 0.18 }, { char: 'ğŸ›°ï¸', size: 30, speed: 1.4, yPercent: 0.08 }, { char: 'ğŸ›°ï¸', size: 33, speed: 1.1, yPercent: 0.15 }, { char: 'ğŸš€', size: 40, speed: 2.0, yPercent: 0.06 }, { char: 'ğŸš€', size: 42, speed: 1.8, yPercent: 0.13 }, ]; configs.forEach(config => spacecrafts.push(new Spacecraft(config))); }
        function createStars() { const nS=150,eS=document.querySelectorAll('.star');eS.forEach(s=>s.remove());for(let i=0;i<nS;i++){let s=document.createElement('div');s.className='star';s.style.top=Math.random()*100+'vh';s.style.left=Math.random()*100+'vw';s.style.animationDuration=(Math.random()*1.5+0.5)+'s';s.style.animationDelay=Math.random()*2.5+'s';document.body.appendChild(s);}}
        
        // 5. éŠæˆ²æµç¨‹æ§åˆ¶å‡½å¼ - æ­¤éƒ¨åˆ†ç„¡è®Šæ›´
        function startGame() { if (isGameStarted) return; isGameStarted = true; timerInterval = setInterval(() => { gameTimeRemaining--; if (gameTimeRemaining < 0) { gameTimeRemaining = 0; gameOverReason = 'æ™‚é–“åˆ°ï¼'; isGameOver = true; clearInterval(timerInterval); } }, 1000); }
        function restartGame() { score = 0; ammo = STARTING_AMMO; gameTimeRemaining = GAME_TIME_LIMIT; isGameStarted = false; isGameOver = false; gameOverReason = ''; if (timerInterval) clearInterval(timerInterval); fireworks.length = 0; particles.length = 0; setupSpacecrafts(); }
        function positionUIAndButton() {
            const padding = 15;
            const lineHeight = 35;
            const uiBlockHeight = lineHeight * 3;
            const startY = (height / 2) - (uiBlockHeight / 2);
            const buttonGap = 10;
            const bottomOfUI = startY + uiBlockHeight;
            const firstButtonTop = bottomOfUI + 15;
            const buttonHeight = 14 + (8 * 2); 
            const buttonHeightWithGap = buttonHeight + buttonGap;
            startButton.style.top = `${firstButtonTop}px`;
            startButton.style.left = `${padding}px`;
            toggleSoundButton.style.top = `${firstButtonTop + buttonHeightWithGap}px`;
            toggleSoundButton.style.left = `${padding}px`;
            backButton.style.top = `${firstButtonTop + buttonHeightWithGap * 2}px`;
            backButton.style.left = `${padding}px`;
        }
        function drawUI() { const padding = 15; const lineHeight = 35; const fontSize = 26; const uiBlockHeight = lineHeight * 3; const startY = (height / 2) - (uiBlockHeight / 2); ctx.save(); ctx.font = `bold ${fontSize}px Arial`; ctx.fillStyle = 'white'; ctx.textAlign = 'left'; ctx.textBaseline = 'top'; ctx.fillText(`åˆ†æ•¸: ${score}`, padding, startY); ctx.fillText(`æ™‚é–“: ${gameTimeRemaining}s`, padding, startY + lineHeight); ctx.fillText(`å½ˆè—¥: ${ammo}`, padding, startY + lineHeight * 2); ctx.restore(); }
        function drawGameOverScreen() { ctx.save(); ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.fillRect(0, 0, width, height); ctx.font = 'bold 60px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(gameOverReason, width / 2, height / 2 - 80); ctx.font = '40px Arial'; ctx.fillText(`æœ€çµ‚å¾—åˆ†: ${score}`, width / 2, height / 2); ctx.restore(); }
        function setupCanvasAndObjects() { const dpr = window.devicePixelRatio || 1; width = window.innerWidth; height = window.innerHeight; canvas.width = width * dpr; canvas.height = height * dpr; canvas.style.width = `${width}px`; canvas.style.height = `${height}px`; ctx.scale(dpr, dpr); ctx.imageSmoothingEnabled = false; createStars(); setupSpacecrafts(); positionUIAndButton(); }

        // 6. å‹•ç•«ä¸»è¿´åœˆ - æ­¤éƒ¨åˆ†ç„¡è®Šæ›´
        function animate() {
            requestAnimationFrame(animate);
            ctx.fillStyle = 'rgba(0, 0, 26, 0.2)'; ctx.fillRect(0, 0, width, height);
            if (!isGameOver) { for (const craft of spacecrafts) { craft.update(); } }
            for (const craft of spacecrafts) { craft.draw(); }
            if (isGameStarted && !isGameOver) {
                for (let i = fireworks.length - 1; i >= 0; i--) {
                    fireworks[i].update(); fireworks[i].draw();
                    if (Math.hypot(fireworks[i].endX - fireworks[i].x, fireworks[i].endY - fireworks[i].y) < 20) {
                        const ex = fireworks[i].x, ey = fireworks[i].y;
                        createFireworkExplosion(ex, ey, fireworks[i].color);
                        checkCollisions(ex, ey);
                        fireworks.splice(i, 1);
                    }
                }
            }
            for (let i = particles.length - 1; i >= 0; i--) { if (particles[i].alpha <= 0) { particles.splice(i, 1); } else { particles[i].update(); particles[i].draw(); } }
            drawUI();
            if (!isGameOver && isGameStarted && ammo <= 0 && fireworks.length === 0 && particles.length === 0) { gameOverReason = 'å½ˆè—¥è€—ç›¡ï¼'; isGameOver = true; if (timerInterval) clearInterval(timerInterval); }
            
            if (isGameOver) {
                drawGameOverScreen();
                startButton.textContent = 'é‡æ–°é–‹å§‹';
                startButton.style.display = 'flex';
                toggleSoundButton.style.display = 'flex';
                backButton.style.display = 'flex';
            }
        }

        // å•Ÿå‹•ç¨‹å¼
        setupCanvasAndObjects();
        animate();
    </script>
</body>
</html>