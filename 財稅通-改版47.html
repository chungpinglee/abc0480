<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不動產智稅通 - 智能顧問平台 (手機終極優化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        
        /* 基礎樣式 */
        .input-field:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        .input-field:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }

        /* --- Tooltip 樣式 --- */
        .tax-tooltip-wrapper { position: relative; display: inline-flex; align-items: center; vertical-align: middle; }
        .tax-tooltip-trigger { cursor: pointer; transition: color 0.2s; position: relative; z-index: 20; margin-left: 6px; font-size: 0.9em; opacity: 0.7; }
        .tax-tooltip-trigger:hover { opacity: 1; color: #2563eb; }
        
        /* 電腦版 Tooltip */
        .tax-tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 9999;
            top: 140%; 
            left: 50%; 
            transform: translateX(-50%);
            width: 450px;
            background-color: white;
            border: 1px solid #94a3b8;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.85rem;
            color: #334155;
            line-height: 1.8;
            text-align: left;
            white-space: normal;
            font-weight: normal; 
        }

        /* --- 手機版 Tooltip 強制置中 --- */
        @media (max-width: 768px) {
            .tax-tooltip-content {
                position: fixed !important; 
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important; 
                width: 95vw !important; 
                max-width: 95vw !important;
                max-height: 80vh; 
                overflow-y: auto;
                margin: 0 !important;
                border: 2px solid #2563eb;
                box-shadow: 0 0 0 100vh rgba(0,0,0,0.5); 
            }
            .tax-tooltip-content::after, .tax-tooltip-content::before { display: none; }
        }

        /* 狀態控制 Classes */
        .tax-tooltip-wrapper.hover-show .tax-tooltip-content { visibility: visible; opacity: 1; }
        .tax-tooltip-wrapper.fixed-show .tax-tooltip-content {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }
        .tax-tooltip-wrapper.fixed-show .tax-tooltip-trigger { color: #2563eb; opacity: 1; }

        .tax-table th, .tax-table td { border: 1px solid #e2e8f0; padding: 4px 8px; text-align: left; }
        .tax-table th { background-color: #f1f5f9; font-weight: bold; }
        
        /* 算式樣式 */
        .calc-formula-val { color: #059669; font-weight: bold; }
        .calc-formula-op { color: #64748b; margin: 0 4px; font-weight: bold; }
        .calc-formula-res { color: #dc2626; font-weight: bold; font-size: 1.1em; }
        .calc-unit { color: #475569; font-size: 0.9em; margin-left: 2px; } 
        .calc-label { 
            color: #1e40af; 
            font-size: 0.85em; 
            margin-left: 4px; 
            background-color: #eff6ff; 
            padding: 1px 4px; 
            border-radius: 4px; 
            border: 1px solid #dbeafe;
            display: inline-block; 
        }
        
        .law-link {
            display: inline-flex;
            align-items: center;
            margin-top: 4px;
            color: #2563eb;
            font-size: 0.75rem;
            font-weight: bold;
            text-decoration: none;
            border: 1px solid #bfdbfe;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #eff6ff;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .law-link:hover { background-color: #dbeafe; }
        
        /* 警示區塊 */
        .date-alert { background-color: #dc2626 !important; color: white !important; border-color: #b91c1c !important; }
        .old-scheme-warning {
            background-color: #dc2626; color: white; padding: 10px; border-radius: 0.5rem;
            margin-top: 10px; font-weight: bold; text-align: center; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.85; } 100% { opacity: 1; } }

        /* --- 列印專用樣式 --- */
        @media print {
            @page { margin: 0.8cm; size: A4 portrait; }
            html, body { height: auto !important; overflow: visible !important; background-color: white !important; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            #sidebar, .tax-tooltip-trigger, .tax-tooltip-content, .md\:hidden { display: none !important; }
            main { margin-left: 0 !important; width: 100% !important; display: block !important; height: auto !important; overflow: visible !important; position: static !important; }
            #main-content { padding: 0 !important; background-color: white !important; overflow: visible !important; height: auto !important; }
            #view-calc, #view-law { padding-top: 0 !important; }
            .bg-white { page-break-inside: auto; }
            .law-card, tr, th, td { page-break-inside: avoid; }
            .guide-buttons, .absolute.top-14 { display: none !important; }
            input, select { border: 1px solid #ddd !important; background: transparent !important; box-shadow: none !important; }
            .shadow, .shadow-lg, .shadow-sm { box-shadow: none !important; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="sidebar" class="bg-blue-900 text-white w-64 flex-shrink-0 hidden md:flex flex-col transition-all duration-300 print:hidden">
        <div class="p-4 text-center font-bold text-xl border-b border-blue-800"><i class="fas fa-building mr-2"></i>不動產智稅通</div>
        <nav class="flex-1 p-2 space-y-2 overflow-y-auto">
            <button onclick="setView('calc')" class="w-full text-left px-4 py-3 rounded bg-blue-800 text-white hover:bg-blue-700 transition-colors"><i class="fas fa-calculator w-6"></i>全能稅務試算</button>
            <button onclick="setView('law')" class="w-full text-left px-4 py-3 rounded hover:bg-blue-800 text-blue-200 transition-colors"><i class="fas fa-book-open w-6"></i>房地合一稅相關法源</button>
            <button onclick="setView('ai')" class="w-full text-left px-4 py-3 rounded hover:bg-blue-800 text-blue-200 transition-colors"><i class="fas fa-robot w-6"></i>AI 語音專家</button>
        </nav>
        <div class="p-4 border-t border-blue-800 text-xs space-y-2">
            <a href="https://www.etax.nat.gov.tw/etwmain/tax-info/understanding/tax-q-and-a/national/individual-income-tax/house-tax-and-land-tax-consolidation-question" target="_blank" class="block w-full bg-sky-600 py-2 rounded hover:bg-sky-500 text-center text-white no-underline transition-colors">
                <i class="fas fa-question-circle mr-1"></i>房地合一課徵個人所得稅相關問題
            </a>
            
            <button onclick="exportJSON()" class="w-full bg-emerald-600 py-2 rounded hover:bg-emerald-500">下載存檔</button>
            <button onclick="document.getElementById('importFile').click()" class="w-full bg-orange-600 py-2 rounded hover:bg-orange-500">匯入檔案</button>
            <button onclick="printPage()" class="w-full bg-indigo-600 py-2 rounded hover:bg-indigo-500"><i class="fas fa-print mr-1"></i>列印試算</button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importJSON(this)">
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div class="md:hidden bg-blue-900 text-white p-3 flex justify-between items-center relative z-20 print:hidden">
            <span class="font-bold">不動產智稅通</span>
            <button id="sidebarToggleBtn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        </div>

        <div class="absolute top-14 md:top-4 right-4 z-30 flex flex-row gap-2 print:hidden">
            <a href="https://www.google.com/search?q=" target="_blank" class="bg-purple-600 text-white px-3 py-2 rounded-lg shadow-lg hover:bg-purple-700 text-sm font-bold flex items-center transition-colors border border-purple-500 whitespace-nowrap">
                <i class="fas fa-robot mr-2"></i>AI詢問
            </a>
            <a href="https://www.etax.nat.gov.tw/etwmain/etw158w/2501" target="_blank" class="bg-teal-600 text-white px-3 py-2 rounded-lg shadow-lg hover:bg-teal-700 text-sm font-bold flex items-center transition-colors border border-teal-500 whitespace-nowrap">
                <i class="fas fa-calculator mr-2"></i>財政部
            </a>
            <a href="https://law.moj.gov.tw/" target="_blank" class="bg-gray-700 text-white px-3 py-2 rounded-lg shadow-lg hover:bg-gray-800 text-sm font-bold flex items-center transition-colors border border-gray-600 whitespace-nowrap">
                <i class="fas fa-balance-scale mr-2"></i>法規資料庫
            </a>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-100" id="main-content">
            
            <div id="view-calc" class="max-w-6xl mx-auto space-y-3 pt-12 md:pt-4">
                <div class="flex items-center mb-1">
                    <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-blue-600 pl-4">房地合一稅 2.0試算</h2>
                    <div class="tax-tooltip-wrapper">
                        <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400 hover:text-blue-600 text-lg"></i>
                        <div class="tax-tooltip-content">
                            <div class="flex justify-between items-center mb-2 md:hidden">
                                <span class="font-bold text-blue-700">說明</span>
                                <button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button>
                            </div>
                            <h4 class="font-bold text-blue-700 mb-1">房地合一稅 2.0</h4>
                            <p class="mb-2">係指105年1月1日以後取得之房屋、土地，於110年7月1日以後交易者，適用新制課稅規定。</p>
                            <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法14條-4</a>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow p-2 border-t-4 border-blue-500">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-sm text-yellow-800 font-bold">
                        <i class="fas fa-info-circle mr-2"></i>適用對象判定: 此稅制適用於 <span class="text-red-600">民國 105年 1月 1 日以後取得，並且於民國 110年 7月 1 日以後交易</span> 的房地產。
                    </div>
                    <div id="oldSchemeAlert" class="hidden old-scheme-warning mt-2">
                        <i class="fas fa-exclamation-triangle mr-1"></i> 屬舊制計算財產交易所得，並非房地合一稅適用範圍！
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border-2 border-indigo-300">
                    <div class="bg-indigo-100 px-5 py-3 border-b border-indigo-300 flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center">
                            <h3 class="text-xl font-bold text-indigo-900"><i class="fas fa-calculator mr-2"></i>計算參數引導輸入</h3>
                            <div class="tax-tooltip-wrapper">
                                <i class="fas fa-question-circle tax-tooltip-trigger text-indigo-400 hover:text-indigo-700"></i>
                                <div class="tax-tooltip-content">
                                    <h4 class="font-bold text-indigo-700 mb-1">計算依據</h4>
                                    <p>計算稅額需依據政府公告之土地現值、房屋評定現值及消費者物價指數(CPI)進行成本調整。</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2 md:mt-0 text-xs guide-buttons">
                            <a href="https://www.land.moi.gov.tw/chhtml/landvalue/42" target="_blank" class="bg-white border border-indigo-300 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-50"><i class="fas fa-search mr-1"></i>公告土地現值</a>
                            <a href="https://www.etax.nat.gov.tw/etwmain/exchange-corner/related-links/local-tax-agency" target="_blank" class="bg-white border border-indigo-300 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-50"><i class="fas fa-building mr-1"></i>房屋評定</a>
                            <a href="https://www.stat.gov.tw/cp.aspx?n=2665" target="_blank" class="bg-white border border-indigo-300 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-50"><i class="fas fa-chart-line mr-1"></i>物價指數</a>
                        </div>
                    </div>
                    
                    <div class="p-5 bg-indigo-50/30 space-y-4">
                        
                        <div class="flex flex-wrap md:flex-nowrap items-start md:items-center bg-white p-3 rounded border border-gray-200 shadow-sm gap-4">
                            <div class="flex items-center w-full md:w-auto">
                                <label class="font-bold text-indigo-900 mr-3 text-lg whitespace-nowrap"><i class="fas fa-user mr-2"></i>所有權人:</label>
                                <input type="text" id="ownerName" class="input-field flex-1 md:w-32 px-3 py-2 border rounded text-lg" placeholder="輸入姓名">
                            </div>
                            
                            <div class="flex flex-col md:flex-row md:items-center relative w-full flex-1">
                                <label class="font-bold text-gray-700 mr-2 text-base whitespace-nowrap mb-1 md:mb-0">
                                    身份類別:
                                </label>
                                <div class="flex items-center w-full">
                                    <select id="ownerType" class="input-field w-full md:w-auto flex-1 px-3 py-2 border rounded text-base font-bold text-blue-900" onchange="handleIdentityChange()">
                                        <option value="" disabled selected>請選擇身份類別</option>
                                        <option value="domestic_ind">境內個人 (2.0)</option>
                                        <option value="domestic_ent">境內營利事業 (2.0)</option>
                                        <option value="foreign">非境內個人/境外營利事業</option>
                                    </select>
                                    
                                    <div id="taxTooltipWrapper" class="tax-tooltip-wrapper ml-2 hidden">
                                        <div class="tax-tooltip-trigger text-blue-600 hover:text-blue-800 p-2">
                                            <i class="fas fa-info-circle text-xl"></i> 
                                        </div>
                                        <div class="tax-tooltip-content" id="taxTooltipContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center mb-2 border-b pb-2">
                                    <div class="flex items-center">
                                        <h4 class="font-bold text-indigo-700 text-lg">1. 建物權狀輸入</h4>
                                        <div class="tax-tooltip-wrapper">
                                            <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                            <div class="tax-tooltip-content">
                                                <h4 class="font-bold text-indigo-700 mb-1">建物資料來源</h4>
                                                <p>請參考建物所有權狀或建物登記謄本。面積以平方公尺為單位。</p>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500">預留2筆</span>
                                </div>
                                <div class="mb-4 bg-indigo-50 p-3 rounded text-sm space-y-2 border border-indigo-100">
                                    <div class="grid grid-cols-1 gap-1">
                                        <label class="font-bold text-indigo-600 text-xs">建物登記日期</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="bDate1" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="日期 1">
                                            <input type="text" id="bDate2" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="日期 2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-1">
                                        <label class="font-bold text-indigo-600 text-xs">坐落</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="bLoc1" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="坐落 1">
                                            <input type="text" id="bLoc2" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="坐落 2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-1">
                                        <label class="font-bold text-indigo-600 text-xs">建號</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="bNo1" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="建號 1">
                                            <input type="text" id="bNo2" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="建號 2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-1 pt-1 border-t border-indigo-200 mt-1">
                                        <label class="font-bold text-indigo-600 text-xs">建物面積 (m²) / 持分</label>
                                        <div class="flex space-x-2">
                                            <div class="w-1/2 flex space-x-1">
                                                <input type="number" id="bArea1" class="input-field w-3/5 px-2 py-1 text-sm border rounded build-area" placeholder="面積 1" oninput="calcDeedTotal('build')">
                                                <input type="text" id="bScope1" class="input-field w-2/5 px-2 py-1 text-sm border rounded build-scope text-center" placeholder="1/1" value="1/1" oninput="calcDeedTotal('build')">
                                            </div>
                                            <div class="w-1/2 flex space-x-1">
                                                <input type="number" id="bArea2" class="input-field w-3/5 px-2 py-1 text-sm border rounded build-area" placeholder="面積 2" oninput="calcDeedTotal('build')">
                                                <input type="text" id="bScope2" class="input-field w-2/5 px-2 py-1 text-sm border rounded build-scope text-center" placeholder="1/1" value="1/1" oninput="calcDeedTotal('build')">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center pt-2 border-t flex-wrap">
                                    <span class="font-bold text-sm">建物總面積 (m²)</span>
                                    <div class="flex items-center tax-tooltip-wrapper">
                                        <input type="number" id="buildAreaTotal" class="input-field w-24 px-2 py-1 text-right font-bold text-indigo-700 bg-gray-50 border-none" readonly value="0">
                                        <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer ml-1 tax-tooltip-trigger no-print"></i>
                                        <span class="text-xs text-gray-500 ml-1" id="buildPingSpan">(約 0.00 坪)</span>
                                        <div class="tax-tooltip-content">
                                            <div class="font-bold mb-1 border-b pb-1 text-indigo-700">計算過程 (總和)</div>
                                            <div id="explain_buildArea" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center mb-2 border-b pb-2">
                                    <div class="flex items-center">
                                        <h4 class="font-bold text-green-700 text-lg">2. 土地權狀輸入</h4>
                                        <div class="tax-tooltip-wrapper">
                                            <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400 ml-2"></i>
                                            <div class="tax-tooltip-content">
                                                <h4 class="font-bold text-green-700 mb-1">土地資料來源</h4>
                                                <p>請參考土地所有權狀或土地登記謄本。面積以平方公尺為單位。</p>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500">預留2筆</span>
                                </div>

                                <div class="mb-4 bg-green-50 p-3 rounded text-sm space-y-2 border border-green-100">
                                    <div class="grid grid-cols-1 gap-1">
                                        <label class="font-bold text-green-600 text-xs">土地登記日期</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="lDate1" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="日期 1">
                                            <input type="text" id="lDate2" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="日期 2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-1">
                                        <label class="font-bold text-green-600 text-xs">坐落</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="lLoc1" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="坐落 1">
                                            <input type="text" id="lLoc2" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="坐落 2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-1">
                                        <label class="font-bold text-green-600 text-xs">地號</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="lNo1" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="地號 1">
                                            <input type="text" id="lNo2" class="input-field w-1/2 px-2 py-1 border rounded bg-white" placeholder="地號 2">
                                        </div>
                                    </div>
                                     <div class="grid grid-cols-1 gap-1 pt-1 border-t border-green-200 mt-1">
                                        <label class="font-bold text-green-600 text-xs">土地面積 (m²) / 持分</label>
                                        <div class="flex space-x-2">
                                            <div class="w-1/2 flex space-x-1">
                                                <input type="number" id="lArea1" class="input-field w-3/5 px-2 py-1 text-sm border rounded land-area" placeholder="面積 1" oninput="calcDeedTotal('land')">
                                                <input type="text" id="lScope1" class="input-field w-2/5 px-2 py-1 text-sm border rounded land-scope text-center" placeholder="1/1" value="1/1" oninput="calcDeedTotal('land')">
                                            </div>
                                            <div class="w-1/2 flex space-x-1">
                                                <input type="number" id="lArea2" class="input-field w-3/5 px-2 py-1 text-sm border rounded land-area" placeholder="面積 2" oninput="calcDeedTotal('land')">
                                                <input type="text" id="lScope2" class="input-field w-2/5 px-2 py-1 text-sm border rounded land-scope text-center" placeholder="1/1" value="1/1" oninput="calcDeedTotal('land')">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center pt-2 border-t flex-wrap">
                                    <span class="font-bold text-sm">土地總面積 (m²)</span>
                                    <div class="flex items-center tax-tooltip-wrapper">
                                        <input type="number" id="landAreaTotal" class="input-field w-24 px-2 py-1 text-right font-bold text-green-700 bg-gray-50 border-none" readonly value="0">
                                        <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer ml-1 tax-tooltip-trigger no-print"></i>
                                        <span class="text-xs text-gray-500 ml-1" id="landPingSpan">(約 0.00 坪)</span>
                                        <div class="tax-tooltip-content">
                                            <div class="font-bold mb-1 border-b pb-1 text-green-700">計算過程 (總和)</div>
                                            <div id="explain_landArea" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4 p-4 bg-white rounded border-l-4 border-indigo-400 shadow-sm">
                                <div class="flex items-center border-b pb-1 mb-2">
                                    <h4 class="font-bold text-indigo-700 text-lg">3. 取得時現值</h4>
                                    <div class="tax-tooltip-wrapper">
                                        <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                        <div class="tax-tooltip-content">
                                            <h4 class="font-bold text-indigo-700 mb-1">取得時現值計算</h4>
                                            <p>繼承或受贈取得者，以繼承/受贈時之房屋評定現值及公告土地現值為成本基礎，並依消費者物價指數(CPI)調整。</p>
                                            <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第14條之4</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">房屋評定現值 (總額)</label>
                                        <input type="text" inputmode="numeric" id="refHouseVal" class="input-field w-full px-3 py-2 border rounded" placeholder="輸入金額" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">公告土地現值 (元/m²)</label>
                                        <input type="text" inputmode="numeric" id="refLandValUnit" class="input-field w-full px-3 py-2 border rounded" placeholder="單價" onblur="fmt(this);calc();calcLandInc();" onfocus="unfmt(this)">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">公告地價 (元/m²)</label>
                                        <input type="text" inputmode="numeric" id="refLandPriceUnit" class="input-field w-full px-3 py-2 border rounded" placeholder="單價" onblur="fmt(this)" onfocus="unfmt(this)">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">消費者物價指數 (CPI%)</label>
                                        <input type="number" id="refCPI" class="input-field w-full px-3 py-2 border rounded bg-indigo-50" placeholder="100" value="100" oninput="calc();calcLandInc();">
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-dashed">
                                    <label class="text-sm font-bold text-blue-800 mb-1 flex items-center">
                                        原始取得日 (民國年/月/日)
                                        <div class="tax-tooltip-wrapper ml-1">
                                            <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400 text-xs"></i>
                                            <div class="tax-tooltip-content">
                                                <h4 class="font-bold text-gray-700 mb-1">原始取得日認定</h4>
                                                <p>原則上以完成所有權移轉登記日為準。如為繼承，則為繼承開始日。</p>
                                                <a href="https://law-out.mof.gov.tw/LawContent.aspx?id=GL009961" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：房地合一課徵所得稅申報作業要點第四點</a>
                                            </div>
                                        </div>
                                    </label>
                                    <div class="flex items-center space-x-1">
                                        <input type="number" id="acqY" class="input-field w-20 px-1 py-1 border rounded text-center text-sm" value="105" min="1" oninput="validatePositive(this);checkOldScheme();calc();"> <span class="text-xs">年</span>
                                        <input type="number" id="acqM" class="input-field w-16 px-1 py-1 border rounded text-center text-sm" value="1" min="1" max="12" oninput="validateDate(this,12);calc();"> <span class="text-xs">月</span>
                                        <input type="number" id="acqD" class="input-field w-16 px-1 py-1 border rounded text-center text-sm" value="1" min="1" max="31" oninput="validateDate(this,31);calc();"> <span class="text-xs">日</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4 p-4 bg-white rounded border-l-4 border-green-400 shadow-sm">
                                <div class="flex items-center border-b pb-1 mb-2">
                                    <h4 class="font-bold text-green-700 text-lg">4. 交易時現值 (預估)</h4>
                                    <div class="tax-tooltip-wrapper">
                                        <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                        <div class="tax-tooltip-content">
                                            <h4 class="font-bold text-green-700 mb-1">交易時現值</h4>
                                            <p>用於計算土地漲價總數額，以扣除土地增值稅之稅基，避免重複課稅。</p>
                                            <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第14條之4</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">房屋評定現值 (總額)</label>
                                        <input type="text" inputmode="numeric" id="txHouseVal" class="input-field w-full px-3 py-2 border rounded" placeholder="輸入金額" onblur="fmt(this)" onfocus="unfmt(this)">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">公告土地現值 (元/m²)</label>
                                        <input type="text" inputmode="numeric" id="txLandVal" class="input-field w-full px-3 py-2 border rounded" placeholder="單價" onblur="fmt(this);calcLandInc();" onfocus="unfmt(this)">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">公告地價 (元/m²)</label>
                                        <input type="text" inputmode="numeric" id="txLandPriceUnit" class="input-field w-full px-3 py-2 border rounded" placeholder="單價" onblur="fmt(this)" onfocus="unfmt(this)">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-600 mb-1">消費者物價指數 (CPI%)</label>
                                        <input type="number" id="txCPI" class="input-field w-full px-3 py-2 border rounded" placeholder="100" oninput="">
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-dashed">
                                    <label class="text-sm font-bold text-blue-800 mb-1 flex items-center">
                                        交易日 (民國年/月/日)
                                        <div class="tax-tooltip-wrapper ml-1">
                                            <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400 text-xs"></i>
                                            <div class="tax-tooltip-content">
                                                <h4 class="font-bold text-gray-700 mb-1">交易日認定</h4>
                                                <p>原則上以完成所有權移轉登記日為準。</p>
                                                <a href="https://law-out.mof.gov.tw/LawContent.aspx?id=GL009961" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：房地合一課徵所得稅申報作業要點第四點</a>
                                            </div>
                                        </div>
                                    </label>
                                    <div class="flex items-center space-x-1">
                                        <input type="number" id="txY" class="input-field w-20 px-1 py-1 border rounded text-center text-sm" min="100" oninput="validatePositive(this);checkFutureDate();calc();"> <span class="text-xs">年</span>
                                        <input type="number" id="txM" class="input-field w-16 px-1 py-1 border rounded text-center text-sm" min="1" max="12" oninput="validateDate(this,12);checkFutureDate();calc();"> <span class="text-xs">月</span>
                                        <input type="number" id="txD" class="input-field w-16 px-1 py-1 border rounded text-center text-sm" min="1" max="31" oninput="validateDate(this,31);checkFutureDate();calc();"> <span class="text-xs">日</span>
                                    </div>
                                    <p id="futureDateMsg" class="text-xs text-red-500 mt-1 font-bold hidden">注意：交易日期超過今日</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 mb-6">
                            <label class="block text-lg font-bold text-blue-800 mb-1 flex items-center">
                                5. 房地成交價額 (元)
                                <div class="tax-tooltip-wrapper ml-1">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400 hover:text-blue-600"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-blue-700 mb-1">成交價額</h4>
                                        <p>指實際買賣交易之成交價格，應以契約書所載金額為準。</p>
                                        <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第14條之4</a>
                                    </div>
                                </div>
                            </label>
                            <input type="text" inputmode="numeric" id="salePrice" class="input-field w-full px-3 py-2 border rounded text-lg font-bold text-gray-700" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 border-t-4 border-green-500 mb-3">
                    <h3 class="text-2xl font-bold text-green-900 mb-6 border-b pb-2">可減除項目 (成本與費用)</h3>
                    
                    <div class="mb-8 p-6 bg-green-50 rounded-xl border-2 border-green-200 shadow-inner">
                        <div class="mb-4 font-bold text-xl text-gray-800 flex items-center">
                            原始取得成本 (擇一適用)
                            <div class="tax-tooltip-wrapper ml-2">
                                <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                <div class="tax-tooltip-content">
                                    <h4 class="font-bold text-green-700 mb-1">取得成本認定</h4>
                                    <p>買賣取得者為成交價額；繼承或受贈者為繼承/受贈時之時價(公告現值)。</p>
                                    <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第14條之4</a>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex flex-col md:flex-row md:items-center gap-2">
                                <div class="flex items-center">
                                    <input type="radio" name="costType" value="buy" checked onchange="toggleCost()" class="w-5 h-5 text-green-600 cursor-pointer flex-shrink-0">
                                    <label class="ml-3 text-lg font-bold text-gray-700 cursor-pointer flex-shrink-0" onclick="document.querySelector('input[value=buy]').click()">出價取得</label>
                                </div>
                                <input type="text" id="costBuy" class="input-field w-full md:w-48 px-3 py-2 text-lg border-2 border-gray-300 rounded-lg focus:border-green-500" placeholder="實際成交金額" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                            </div>
                            
                            <div class="flex flex-col md:flex-row md:items-center gap-2">
                                <div class="flex items-center">
                                    <input type="radio" name="costType" value="gift" onchange="toggleCost()" class="w-5 h-5 text-green-600 cursor-pointer flex-shrink-0">
                                    <label class="ml-3 text-lg font-bold text-gray-700 cursor-pointer flex-shrink-0" onclick="document.querySelector('input[value=gift]').click()">受贈取得</label>
                                </div>
                            </div>

                            <div class="flex flex-col gap-2">
                                <div class="flex items-center">
                                    <input type="radio" name="costType" value="inherit" onchange="toggleCost()" class="w-5 h-5 text-green-600 cursor-pointer flex-shrink-0">
                                    <label class="ml-3 text-lg font-bold text-gray-700 cursor-pointer flex-shrink-0" onclick="document.querySelector('input[value=inherit]').click()">繼承取得</label>
                                    <span class="ml-2 text-xs text-green-700 bg-green-100 px-2 py-1 rounded">含房貸扣除</span>
                                </div>
                                <div id="inheritDebtDiv" class="hidden pl-0 md:pl-8 mt-1 w-full">
                                    <label class="text-sm font-bold text-gray-600 mb-1 flex items-center">
                                        繼承時抵押貸款餘額
                                        <div class="tax-tooltip-wrapper ml-1">
                                            <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400 text-xs"></i>
                                            <div class="tax-tooltip-content">
                                                <h4 class="font-bold text-orange-600 mb-1">繼承負債扣除</h4>
                                                <p>繼承取得之房地，若繼承時有尚未償還之金融機構抵押貸款，其餘額超過公告現值部分可列為成本。</p>
                                                <a href="https://www.mof.gov.tw/singlehtml/384fb3077bb349ea973e7fc6f13b6974?cntId=bb436c60c5844dc096417218cbdce16c" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>依據：財政部說明</a>
                                            </div>
                                        </div>
                                    </label>
                                    <input type="text" id="inheritDebt" class="input-field w-full md:w-64 px-3 py-2 border rounded text-lg border-orange-300 bg-orange-50" placeholder="若有繼承房貸請輸入" onblur="fmt(this);calc()" onfocus="unfmt(this)">
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 flex flex-col md:flex-row md:items-center tax-tooltip-wrapper w-full relative gap-2">
                            <span class="text-sm font-bold text-gray-500 whitespace-nowrap">繼承/受贈成本試算:</span>
                            <div class="flex items-center w-full">
                                <input type="text" id="calcInheritCostDisplay" class="input-field w-full md:w-48 px-3 py-2 text-lg font-bold text-blue-600 border-2 border-gray-300 rounded-lg bg-gray-50" readonly placeholder="自動計算">
                                <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer ml-3 text-xl tax-tooltip-trigger no-print"></i>
                                <div class="tax-tooltip-content">
                                    <div id="header_inheritCost" class="font-bold mb-1 border-b pb-1 text-blue-700">計算過程 (繼承/受贈)</div>
                                    <div id="explain_inheritCost" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-xl font-bold text-gray-700 mb-2 flex items-center">
                                必要費用 (改良/修繕)
                                <div class="tax-tooltip-wrapper ml-1">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-gray-700 mb-1">必要費用</h4>
                                        <p>包含取得房屋後，於使用期間支付能增加房屋價值或效能之增置、改良或修繕費（需附證明文件）。</p>
                                        <a href="https://law-out.mof.gov.tw/LawContent.aspx?id=GL009961" target="_blank" class="law-link">(房地合一申報作業要點第13點)</a>
                                    </div>
                                </div>
                            </label>
                            <input type="text" id="expNecess" class="input-field w-full px-3 py-2 text-lg border-2 rounded-lg" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                        </div>
                        <div class="tax-tooltip-wrapper w-full block">
                            <label class="block text-xl font-bold text-gray-700 mb-2 flex items-center">
                                移轉費用 (仲介費等)
                                <div class="tax-tooltip-wrapper ml-1">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-gray-700 mb-1">移轉費用</h4>
                                        <p>如仲介費、代書費、規費等。若無法提供證明，得按成交價額3%計算，以30萬元為限。</p>
                                        <a href="https://law-out.mof.gov.tw/LawContent.aspx?id=GL009961" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>房地合一申報作業要點第26點</a>
                                    </div>
                                </div>
                            </label>
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="expAuto" class="w-5 h-5 mr-2 rounded" onchange="toggleExp()">
                                <span class="text-base text-gray-600">無單據 (自動計算 3% 上限 30 萬)</span>
                            </div>
                            <div class="flex items-center">
                                <input type="text" id="expTransfer" class="input-field w-full px-3 py-2 text-lg border-2 rounded-lg" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                                <div class="tax-tooltip-wrapper ml-2">
                                    <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer tax-tooltip-trigger no-print"></i>
                                    <div class="tax-tooltip-content">
                                        <div class="font-bold mb-1 border-b pb-1 text-gray-700">計算過程 (自動計算)</div>
                                        <div id="explain_expTransfer" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tax-tooltip-wrapper w-full block">
                            <label class="block text-xl font-bold text-gray-700 mb-2 flex items-center">
                                土地漲價總數額
                                <div class="tax-tooltip-wrapper ml-1">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-yellow-700 mb-1">土地漲價總數額</h4>
                                        <p>依土地稅法規定計算之土地漲價總數額，可自房地交易所得中減除，避免土增稅與所得稅重複課稅。</p>
                                        <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第14條之4</a>
                                    </div>
                                </div>
                            </label>
                            <div class="flex items-center">
                                <input type="text" id="landInc" class="input-field w-full px-3 py-2 text-lg border-2 rounded-lg bg-yellow-50" placeholder="系統自動計算" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                                <div class="tax-tooltip-wrapper ml-2 center-align">
                                    <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer tax-tooltip-trigger no-print"></i>
                                    <div class="tax-tooltip-content">
                                        <div class="font-bold mb-1 border-b pb-1 text-yellow-700">計算過程 (漲價總數額)</div>
                                        <div id="explain_landInc" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                    </div>
                                </div>
                            </div>
                            <p id="landIncHint" class="text-xs text-red-500 mt-1">提示: 請輸入前後期公告土地現值與土地面積以自動計算</p>
                        </div>
                        <div>
                            <label class="block text-xl font-bold text-gray-700 mb-2 flex items-center">
                                前 3 年交易損失
                                <div class="tax-tooltip-wrapper ml-1 center-align">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-red-600 mb-1">交易損失扣除</h4>
                                        <p>個人房屋、土地交易損失，得自交易日以後3年內之房屋、土地交易所得減除。</p>
                                        <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>所得稅法14條4第2項</a>
                                    </div>
                                </div>
                            </label>
                            <input type="text" id="loss3yr" class="input-field w-full px-3 py-2 text-lg border-2 rounded-lg" onblur="fmt(this);calc();" onfocus="unfmt(this)">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 border-t-4 border-red-500 mb-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div id="selfUseDiv">
                            <label class="block font-bold text-gray-700 text-lg flex items-center">
                                自住房地免稅優惠 (400萬)
                                <div class="tax-tooltip-wrapper ml-1">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-red-600 mb-1">自住優惠 (400萬免稅)</h4>
                                        <p>個人交易自住房屋土地，符合設籍、持有並居住連續滿6年，且無出租營業使用者，課稅所得400萬元以下免稅，超過部分稅率10%。</p>
                                        <a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=4-5" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第4條之5</a>
                                    </div>
                                </div>
                            </label>
                            <input type="checkbox" id="selfUse" class="w-6 h-6 mt-2" onchange="calc()">
                        </div>
                        <div>
                             <label class="block font-bold text-gray-700 text-lg flex items-center">
                                 重購退稅 (扣抵)
                                 <div class="tax-tooltip-wrapper ml-1">
                                    <i class="fas fa-question-circle tax-tooltip-trigger text-gray-400"></i>
                                    <div class="tax-tooltip-content">
                                        <h4 class="font-bold text-blue-600 mb-1">重購退稅</h4>
                                        <p>個人重購自住房地，無論先買後賣或先賣後買(間隔2年內)，均得按重購價額占出售價額之比例，申請扣抵或退還稅額。</p>
                                        <a href="https://www.etax.nat.gov.tw/etwmain/tax-info/understanding/tax-saving-secret/PqK81rD" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：財政部說明</a>
                                    </div>
                                </div>
                             </label>
                             <div class="flex items-center mt-2">
                                 <input type="checkbox" id="repurchase" class="w-6 h-6 mr-3" onchange="document.getElementById('repPriceDiv').classList.toggle('hidden');calc();">
                                 <div id="repPriceDiv" class="hidden flex items-center w-full">
                                     <span class="text-base mr-2 whitespace-nowrap">重購價:</span>
                                     <input type="text" id="repPrice" class="input-field w-full px-3 py-2 border rounded text-lg" onblur="fmt(this);calc()" onfocus="unfmt(this)">
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-end p-6 bg-red-50 rounded-xl border border-red-100">
                        <div class="mb-4 md:mb-0 space-y-2">
                            <div class="text-lg text-gray-600 flex items-center tax-tooltip-wrapper">
                                獲利金額 (稅基): <span id="resBase" class="font-bold text-gray-800 text-xl mx-2">$0</span>
                                <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer ml-1 tax-tooltip-trigger no-print"></i>
                                <div class="tax-tooltip-content">
                                    <div class="font-bold mb-1 border-b pb-1 text-gray-800">計算過程 (稅基)</div>
                                    <div id="explain_resBase" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                </div>
                            </div>
                            <div class="text-lg text-gray-600">適用稅率: <span id="resRate" class="font-bold text-blue-600 text-xl">--%</span></div>
                        </div>
                        <div class="text-right">
                            <div class="text-base text-gray-600 font-bold mb-1">預估應納稅額</div>
                            <div class="flex items-center justify-end tax-tooltip-wrapper">
                                <div class="text-5xl font-extrabold text-red-600" id="resTax">$0</div>
                                <i class="fas fa-calculator text-gray-400 hover:text-blue-500 cursor-pointer ml-2 tax-tooltip-trigger no-print"></i>
                                <div class="tax-tooltip-content">
                                    <div class="font-bold mb-1 border-b pb-1 text-red-600">計算過程 (稅額)</div>
                                    <div id="explain_resTax" class="text-xs font-mono bg-gray-50 p-1 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-law" class="hidden max-w-6xl mx-auto space-y-6 pt-12 md:pt-4 pb-12">
                <div class="flex items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-blue-600 pl-4">房地合一稅制核心法規</h2>
                </div>
                <div class="law-card bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3 text-blue-600">
                            <i class="fas fa-balance-scale text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-blue-900">核心法源與課稅客體</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm law-table">
                            <thead>
                                <tr><th>法規</th><th>摘要</th></tr>
                            </thead>
                            <tbody>
                                <tr><td><a href="#" class="law-link">所得稅法 4-4條</a></td><td>定義房屋、土地、預售屋及特定股權為課稅客體。</td></tr>
                                <tr><td><a href="#" class="law-link">所得稅法 14-4條</a></td><td>規定稅基計算公式及適用稅率。</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="view-ai" class="hidden">AI Consultant View</div>
        </div>
    </main>

    <script>
        const $ = id => document.getElementById(id);
        const fmtNum = n => new Intl.NumberFormat('zh-TW').format(n);
        const getVal = id => parseFloat($(id).value.replace(/,/g, '')) || 0;
        const setTxt = (id, txt) => $(id).innerText = txt;
        const setHtml = (id, html) => $(id).innerHTML = html;

        function setView(v) { 
            $('view-calc').classList.add('hidden'); 
            $('view-ai').classList.add('hidden'); 
            $('view-law').classList.add('hidden');
            $('view-' + v).classList.remove('hidden'); 
            // 切換視圖後自動關閉側邊欄（手機版）
            if(window.innerWidth < 768) {
                const sidebar = $('sidebar');
                if(!sidebar.classList.contains('hidden')){
                    toggleSidebar();
                }
            }
        }
        
        function closeAllTooltips() {
             document.querySelectorAll('.tax-tooltip-wrapper.fixed-show').forEach(w => w.classList.remove('fixed-show'));
        }

        // --- 側邊欄控制與點擊空白關閉 (新增功能) ---
        function toggleSidebar() {
            const sidebar = $('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-50');
            sidebar.classList.toggle('h-full');
        }

        // 監聽全局點擊，處理側邊欄自動關閉
        document.addEventListener('click', function(e) {
            const sidebar = $('sidebar');
            const toggleBtn = $('sidebarToggleBtn');
            const isMobile = window.innerWidth < 768;

            // 如果是手機版，且側邊欄是開啟狀態
            if (isMobile && !sidebar.classList.contains('hidden')) {
                // 如果點擊的目標不是側邊欄本身，也不是切換按鈕
                if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                    toggleSidebar(); // 關閉側邊欄
                }
            }
        });

        function fmt(el) { if(el.value) el.value = Number(el.value.replace(/,/g, '')).toLocaleString('zh-TW'); }
        function unfmt(el) { el.value = el.value.replace(/,/g, ''); }
        function validatePositive(el) { if (el.value && parseInt(el.value) < 0) el.value = 1; }
        function validateDate(el, max) { let v = parseInt(el.value); if (isNaN(v) || v < 1) el.value = 1; else if (v > max) el.value = max; }

        function initTooltips() {
            document.querySelectorAll('.tax-tooltip-wrapper').forEach(wrapper => {
                const trigger = wrapper.querySelector('.tax-tooltip-trigger');
                if(!trigger) return;
                trigger.addEventListener('mouseenter', () => { if (!wrapper.classList.contains('fixed-show')) wrapper.classList.add('hover-show'); });
                trigger.addEventListener('mouseleave', () => { wrapper.classList.remove('hover-show'); });
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close others first
                    document.querySelectorAll('.tax-tooltip-wrapper.fixed-show').forEach(w => {
                        if(w !== wrapper) w.classList.remove('fixed-show');
                    });
                    
                    if (wrapper.classList.contains('fixed-show')) {
                        wrapper.classList.remove('fixed-show'); wrapper.classList.remove('hover-show');
                    } else {
                        wrapper.classList.add('fixed-show'); wrapper.classList.remove('hover-show');
                    }
                });
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.tax-tooltip-content') && !e.target.closest('.tax-tooltip-trigger')) {
                    closeAllTooltips();
                }
            });
        }

        window.onload = function() {
            const today = new Date();
            $('txY').value = today.getFullYear() - 1911;
            $('txM').value = today.getMonth() + 1;
            $('txD').value = today.getDate();
            checkFutureDate(); 
            toggleSelfUseOption();
            calcDeedTotal('build');
            calcDeedTotal('land');
            calcLandInc();
            initTooltips(); 
            calc();
        }

        function printPage() {
            const originalTitle = document.title;
            const owner = $('ownerName').value.trim() || '未命名';
            const date = new Date();
            const rocYear = date.getFullYear() - 1911;
            document.title = `房地合一稅${owner}${rocYear}`; // 簡化檔名避免亂碼
            
            // 提示 iPhone 用戶
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                alert("【iPhone 列印提示】\n頁面將開啟列印模式。\n請在預覽畫面用兩指「撥開(放大)」預覽圖即可轉為 PDF 儲存，或直接選擇印表機列印。");
            }
            
            window.print();
            setTimeout(() => { document.title = originalTitle; }, 500);
        }

        function handleIdentityChange() {
            const type = $('ownerType').value;
            const tooltipWrapper = $('taxTooltipWrapper');
            const tooltipContent = $('taxTooltipContent');
            
            // 重要修正：切換身份時先關閉 Tooltip，避免舊狀態卡住
            closeAllTooltips();

            if(type) {
                tooltipWrapper.classList.remove('hidden');
                let html = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-blue-700">稅率說明</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
                html += '<h5 class="font-bold mb-2 text-blue-700 hidden md:block">適用稅率說明</h5>';
                html += '<table class="w-full text-xs tax-table mb-2"><tr><th>持有期間</th><th>稅率</th></tr>';
                if (type === 'domestic_ind') {
                    html += '<tr><td>2 年以內</td><td>45%</td></tr><tr><td>2 - 5 年</td><td>35%</td></tr><tr><td>5 - 10 年</td><td>20%</td></tr><tr><td>超過 10 年</td><td>15%</td></tr><tr><td>自住滿 6 年</td><td>10% (免稅額400萬)</td></tr>';
                } else if (type === 'domestic_ent') {
                    html += '<tr><td>2 年以內</td><td>45%</td></tr><tr><td>2 - 5 年</td><td>35%</td></tr><tr><td>超過 5 年</td><td>20%</td></tr>';
                } else {
                    html += '<tr><td>2 年以內</td><td>45%</td></tr><tr><td>超過 2 年</td><td>35%</td></tr>';
                }
                html += '</table><div class="mt-2"><a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=G0340003&flno=14-4" target="_blank" class="law-link"><i class="fas fa-gavel mr-1"></i>法源：所得稅法第14條之4</a></div>';
                tooltipContent.innerHTML = html;
            } else { tooltipWrapper.classList.add('hidden'); }
            toggleSelfUseOption(); calc();
        }

        function calcLandInc() {
            const txVal = getVal('txLandVal'); 
            const refVal = getVal('refLandValUnit');
            const cpi = (getVal('refCPI') || 100) / 100;
            const area = parseFloat($('landAreaTotal').value) || 0;
            const hint = $('landIncHint');
            let explanation = `<span class="text-gray-400">尚未輸入完整數據 (需：前後期公告現值 + 土地面積)</span>`;
            if (txVal && refVal && area) {
                let incUnit = txVal - (refVal * cpi);
                if (incUnit < 0) incUnit = 0;
                const totalInc = Math.floor(incUnit * area);
                $('landInc').value = fmtNum(totalInc);
                hint.innerText = `已自動依據公告現值估算: ${fmtNum(totalInc)} 元`;
                hint.className = "text-xs text-green-600 mt-1 font-bold";
                explanation = `( ${fmtNum(txVal)} <span class="calc-unit">元/m²</span> <span class="calc-label">(交易時公告現值)</span> <span class="calc-formula-op">-</span> ( ${fmtNum(refVal)} <span class="calc-unit">元/m²</span> <span class="calc-label">(前次移轉現值)</span> <span class="calc-formula-op">×</span> ${cpi.toFixed(2)} <span class="calc-unit">倍</span> <span class="calc-label">(CPI消費者物價指數)</span> ) ) <span class="calc-formula-op">×</span> ${area} <span class="calc-unit">m²</span> <span class="calc-label">(移轉土地面積)</span> <span class="calc-formula-op">=</span> <span class="calc-formula-res">${fmtNum(totalInc)}</span> <span class="calc-unit">元</span>`;
            } else {
                hint.innerText = "提示: 請輸入前後期公告土地現值、CPI與土地面積以自動計算";
                hint.className = "text-xs text-red-500 mt-1";
            }
            let mobileHeader = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-yellow-700">計算過程</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
            setHtml('explain_landInc', mobileHeader + explanation);
            calc();
        }

        function checkOldScheme() {
            const y = parseInt($('acqY').value);
            if (!isNaN(y)) {
                const alertDiv = $('oldSchemeAlert');
                const inputs = [$('acqY'), $('acqM'), $('acqD')];
                if (y <= 104) { alertDiv.classList.remove('hidden'); inputs.forEach(el => el.classList.add('date-alert')); } 
                else { alertDiv.classList.add('hidden'); inputs.forEach(el => el.classList.remove('date-alert')); }
            }
        }

        function checkFutureDate() {
            const y = parseInt($('txY').value);
            const m = parseInt($('txM').value);
            const d = parseInt($('txD').value);
            if (y && m && d) {
                const txDate = new Date(y + 1911, m - 1, d);
                const today = new Date(); today.setHours(0,0,0,0);
                const inputs = [$('txY'), $('txM'), $('txD')];
                const msg = $('futureDateMsg');
                if (txDate > today) { inputs.forEach(el => el.classList.add('date-alert')); msg.classList.remove('hidden'); } 
                else { inputs.forEach(el => el.classList.remove('date-alert')); msg.classList.add('hidden'); }
            }
        }

        function calcDeedTotal(type) {
            let total = 0;
            const areas = document.querySelectorAll(`.${type}-area`);
            const scopes = document.querySelectorAll(`.${type}-scope`);
            let explParts = [];
            
            for(let i=0; i<areas.length; i++) {
                const a = parseFloat(areas[i].value) || 0;
                const sStr = scopes[i].value;
                let ratio = 1; let ratioTxt = "1";
                if (sStr && sStr.includes('/')) {
                    const p = sStr.split('/');
                    if (p.length === 2 && parseFloat(p[1]) !== 0) { 
                        ratio = parseFloat(p[0]) / parseFloat(p[1]); 
                        ratioTxt = `${p[0]}/${p[1]}`; 
                    }
                } else if (parseFloat(sStr)) { 
                    ratio = parseFloat(sStr); 
                    ratioTxt = sStr; 
                }
                if(a > 0) { 
                    total += a * ratio; 
                    explParts.push(`${a} <span class="calc-unit">m²</span> <span class="calc-formula-op">×</span> ${ratioTxt}`); 
                }
            }

            const finalTotal = total > 0 ? Math.round(total * 100) / 100 : 0;
            const targetId = type === 'build' ? 'buildAreaTotal' : 'landAreaTotal';
            const targetEl = document.getElementById(targetId);
            if(targetEl) targetEl.value = finalTotal;
            
            const pingId = type === 'build' ? 'buildPingSpan' : 'landPingSpan';
            const pingEl = document.getElementById(pingId);
            const ping = finalTotal * 0.3025;
            
            if (pingEl) {
                pingEl.innerText = `(約 ${ping.toFixed(2)} 坪)`;
            }
            
            const explId = type === 'build' ? 'explain_buildArea' : 'explain_landArea';
            let explHtml = explParts.length > 0 ? explParts.join(' <span class="calc-formula-op">+</span> ') + ` <span class="calc-formula-op">=</span> <span class="calc-formula-res">${finalTotal}</span> <span class="calc-unit">m²</span>` : '<span class="text-gray-400">尚無數據</span>';
            
            if (total > 0) {
                explHtml += `<br><span class="font-bold text-gray-700">坪數換算:</span> ${finalTotal} <span class="calc-unit">m²</span> <span class="calc-formula-op">×</span> 0.3025 <span class="calc-formula-op">=</span> <span class="calc-formula-res">${ping.toFixed(2)}</span> <span class="calc-unit">坪</span>`;
            }
            
            let mobileHeader = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-indigo-700">計算過程</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
            
            const explEl = document.getElementById(explId);
            if(explEl) explEl.innerHTML = mobileHeader + explHtml;
            
            if(type === 'land') calcLandInc(); 
            calc();
        }

        function toggleCost() {
            const costType = document.querySelector('input[name="costType"]:checked').value;
            const costBuy = $('costBuy');
            const inheritDebtDiv = $('inheritDebtDiv');
            if(costType === 'buy') { costBuy.disabled = false; costBuy.classList.remove('bg-gray-100'); costBuy.focus(); } 
            else { costBuy.disabled = true; costBuy.classList.add('bg-gray-100'); }
            if(costType === 'inherit') { inheritDebtDiv.classList.remove('hidden'); } 
            else { inheritDebtDiv.classList.add('hidden'); $('inheritDebt').value = ''; }
            calc();
        }

        function toggleExp() {
            const isAuto = $('expAuto').checked;
            $('expTransfer').disabled = isAuto;
            if(isAuto) { $('expTransfer').classList.add('bg-gray-100'); $('expTransfer').value = ""; } 
            else { $('expTransfer').classList.remove('bg-gray-100'); $('expTransfer').focus(); }
            calc();
        }

        function toggleSelfUseOption() {
            const type = $('ownerType').value;
            const selfUseDiv = $('selfUseDiv');
            const selfUseCheck = $('selfUse');
            if (type === 'domestic_ind') { selfUseDiv.style.opacity = '1'; selfUseCheck.disabled = false; } 
            else { selfUseDiv.style.opacity = '0.5'; selfUseCheck.checked = false; selfUseCheck.disabled = true; }
            calc();
        }

        function calc() {
            const ay = getVal('acqY'), am = getVal('acqM'), ad = getVal('acqD');
            const ty = getVal('txY'), tm = getVal('txM'), td = getVal('txD');
            let years = 0;
            if (ay && ty) {
                const d1 = new Date(ay + 1911, am - 1, ad);
                const d2 = new Date(ty + 1911, tm - 1, td);
                if (d2 > d1) years = (d2 - d1) / (1000 * 60 * 60 * 24 * 365);
            }

            const sale = getVal('salePrice');
            let cost = 0; let costExpl = "";
            const costType = document.querySelector('input[name="costType"]:checked').value;
            
            if (costType === 'buy') {
                cost = getVal('costBuy'); costExpl = `<span class="text-gray-400">採出價取得 (直接輸入)</span>`;
            } else {
                const houseVal = getVal('refHouseVal');
                const landValUnit = getVal('refLandValUnit');
                const landArea = parseFloat($('landAreaTotal').value) || 0;
                const landTotal = landArea > 0 ? landValUnit * landArea : landValUnit;
                const cpi = (getVal('refCPI') || 100) / 100;
                const baseCost = (houseVal + landTotal) * cpi;
                let extraDebtCost = 0; let debtExpl = "";
                if (costType === 'inherit') {
                    const inheritDebt = getVal('inheritDebt');
                    const inheritValue = houseVal + landTotal;
                    if (inheritDebt > inheritValue) {
                        extraDebtCost = inheritDebt - inheritValue;
                        debtExpl = `<br><span class="text-green-600 font-bold">[繼承負債扣除]</span> 貸款 ${fmtNum(inheritDebt)} - 現值 ${fmtNum(inheritValue)} = <span class="text-green-600">+${fmtNum(extraDebtCost)}</span>`;
                    }
                }
                cost = Math.floor(baseCost + extraDebtCost);
                $('calcInheritCostDisplay').value = fmtNum(cost);
                
                const costHeader = $('header_inheritCost');
                if(costHeader) costHeader.innerText = costType === 'inherit' ? '計算過程 (繼承取得成本)' : '計算過程 (受贈取得成本)';
                
                let landDetail = landArea > 0 ? `${fmtNum(landValUnit)} <span class="calc-unit">元</span> <span class="calc-formula-op">×</span> ${landArea} <span class="calc-unit">m²</span>` : `${fmtNum(landValUnit)}`;
                
                costExpl = `( ${fmtNum(houseVal)} <span class="calc-unit">元</span> <span class="calc-label">(房屋評定現值)</span> <span class="calc-formula-op">+</span> ${fmtNum(landValUnit * landArea)} <span class="calc-unit">元</span> <span class="calc-label">(${landDetail} 公告土地現值)</span> ) <span class="calc-formula-op">×</span> ${cpi.toFixed(2)} <span class="calc-unit">倍</span> <span class="calc-label">(CPI消費者物價指數)</span> <span class="calc-formula-op">=</span> ${fmtNum(Math.floor(baseCost))} <span class="calc-unit">元</span>`;
                
                if (extraDebtCost > 0) { costExpl += debtExpl; costExpl += `<br><span class="font-bold text-blue-700">總成本 = ${fmtNum(cost)} 元</span>`; }
            }
            let mobileHeaderCost = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-blue-700">計算過程</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
            setHtml('explain_inheritCost', mobileHeaderCost + costExpl);

            let exp = 0; let expExpl = "";
            if ($('expAuto').checked) {
                let rawExp = sale * 0.03; exp = Math.min(rawExp, 300000);
                $('expTransfer').value = fmtNum(exp);
                expExpl = `${fmtNum(sale)} <span class="calc-unit">元</span> <span class="calc-label">(成交價額)</span> <span class="calc-formula-op">×</span> 3% <span class="calc-formula-op">=</span> ${fmtNum(Math.floor(rawExp))} <span class="calc-unit">元</span><br><span class="text-gray-500 text-xs">依規定以 30萬元為上限</span> <span class="calc-formula-op">→</span> <span class="calc-formula-res">${fmtNum(exp)}</span> <span class="calc-unit">元</span>`;
            } else {
                exp = getVal('expTransfer'); expExpl = `<span class="text-gray-400">手動輸入 / 無單據未勾選</span>`;
            }
            let mobileHeaderExp = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-gray-700">計算過程</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
            setHtml('explain_expTransfer', mobileHeaderExp + expExpl);

            const necess = getVal('expNecess');
            const landInc = getVal('landInc');
            const loss = getVal('loss3yr');
            let base = Math.max(0, sale - cost - exp - necess - landInc - loss);
            setTxt('resBase', fmtNum(Math.floor(base)));
            
            let baseExpl = `${fmtNum(sale)} <span class="calc-unit">元</span><span class="calc-label">(成交價額)</span> <span class="calc-formula-op">-</span> ${fmtNum(Math.floor(cost))} <span class="calc-unit">元</span><span class="calc-label">(取得成本)</span> <span class="calc-formula-op">-</span> ${fmtNum(exp)} <span class="calc-unit">元</span><span class="calc-label">(移轉費用)</span> <span class="calc-formula-op">-</span> ${fmtNum(necess)} <span class="calc-unit">元</span><span class="calc-label">(改良費用)</span> <span class="calc-formula-op">-</span> ${fmtNum(landInc)} <span class="calc-unit">元</span><span class="calc-label">(土地漲價總數額)</span> <span class="calc-formula-op">-</span> ${fmtNum(loss)} <span class="calc-unit">元</span><span class="calc-label">(前三年損失)</span> <span class="calc-formula-op">=</span> <span class="calc-formula-res">${fmtNum(Math.floor(base))}</span> <span class="calc-unit">元</span>`;
            let mobileHeaderBase = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-gray-800">計算過程</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
            setHtml('explain_resBase', mobileHeaderBase + baseExpl);

            const ownerType = $('ownerType').value;
            if(!ownerType) { setTxt('resRate', '--%'); setTxt('resTax', '$0'); setHtml('explain_resTax', '<span class="text-gray-400">請先選擇身份類別</span>'); return; }

            let rate = 0.45; 
            if (ownerType === 'domestic_ind') {
                if (years < 2) rate = 0.45; else if (years < 5) rate = 0.35; else if (years < 10) rate = 0.20; else rate = 0.15;
                if ($('selfUse').checked && years >= 6) rate = 0.10;
            } else if (ownerType === 'domestic_ent') {
                if (years < 2) rate = 0.45; else if (years < 5) rate = 0.35; else rate = 0.20;
            } else { if (years < 2) rate = 0.45; else rate = 0.35; }

            let deduction = ($('selfUse').checked && ownerType === 'domestic_ind') ? 4000000 : 0;
            let taxable = Math.max(0, base - deduction);
            setTxt('resRate', (rate * 100).toFixed(0) + '%');
            let tax = taxable * rate;
            let taxExpl = "";

            if ($('repurchase').checked) {
                const rep = getVal('repPrice');
                if (sale > 0) {
                    let ratio = Math.min(1, rep / sale);
                    tax -= tax * ratio;
                    taxExpl = `(${fmtNum(Math.floor(taxable))} <span class="calc-unit">元</span> <span class="calc-formula-op">×</span> ${(rate*100).toFixed(0)}%) <span class="calc-formula-op">×</span> (1 - ${rep}/${sale}) <span class="calc-formula-op">=</span> <span class="calc-formula-res">${fmtNum(Math.floor(tax))}</span> <span class="calc-unit">元</span>`;
                }
            } else {
                taxExpl = `( ${fmtNum(Math.floor(base))} <span class="calc-unit">元</span> <span class="calc-label">(稅基)</span> <span class="calc-formula-op">-</span> ${fmtNum(deduction)} <span class="calc-unit">元</span><span class="calc-label">(免稅額優惠)</span> ) <span class="calc-formula-op">×</span> <span class="font-bold text-blue-600">${(rate*100).toFixed(0)}%</span> <span class="calc-label">(適用稅率)</span> <span class="calc-formula-op">=</span> <span class="calc-formula-res">${fmtNum(Math.floor(tax))}</span> <span class="calc-unit">元</span>`;
            }
            let mobileHeaderTax = '<div class="flex justify-between items-center mb-2 md:hidden"><span class="font-bold text-red-600">計算過程</span><button onclick="closeAllTooltips()" class="text-gray-500 text-xl px-2"><i class="fas fa-times"></i></button></div>';
            setTxt('resTax', fmtNum(Math.floor(tax)));
            setHtml('explain_resTax', mobileHeaderTax + taxExpl);
        }

        // --- 優化後的下載功能 (適配 iPhone Safari) ---
        function exportJSON() {
            const data = {};
            document.querySelectorAll('input, select').forEach(el => {
                if (el.id) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                         if(el.type === 'radio') { if(el.checked) data[el.name] = el.value; } 
                         else data[el.id] = el.checked;
                    } else data[el.id] = el.value;
                }
            });
            const owner = $('ownerName').value.trim() || '未命名';
            const date = new Date();
            const rocYear = date.getFullYear() - 1911;
            const filename = `房地合一稅_${owner}_${rocYear}.json`;
            const jsonStr = JSON.stringify(data);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            
            // 重要：修正 iOS Safari 下載行為
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importJSON(input) {
            if (input.files.length === 0) return;
            const r = new FileReader();
            r.onload = e => {
                const data = JSON.parse(e.target.result);
                for (let k in data) {
                    const el = document.getElementById(k);
                    if (k === 'costType') {
                         const radios = document.getElementsByName('costType');
                         radios.forEach(r => { if(r.value === data[k]) r.checked = true; });
                    } else if (el) {
                        if(el.type === 'checkbox') el.checked = data[k]; else el.value = data[k];
                    }
                }
                
                calcDeedTotal('build');
                calcDeedTotal('land');
                
                toggleCost(); handleIdentityChange(); calcLandInc(); calc(); checkOldScheme(); checkFutureDate();
                $('ownerName').focus(); 
                
                // 匯入完成後提示並清空 input 以便下次能重複匯入同檔名
                alert('檔案匯入成功！');
                input.value = '';
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>