<html lang="zh-Hant"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115年月曆筆記本問卷</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&amp;display=swap" rel="stylesheet">
    
    <style>
        /* 自訂樣式與動畫 */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .game-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 0.3);
            transition: max-width 0.4s ease-in-out;
        }
        
        /* 擴大資料庫頁面的寬度 */
        .game-container.db-mode {
            max-width: 900px; 
        }

        /* 畫面切換動畫 */
        .game-screen { display: none; animation: fadeIn 0.6s ease-out; }
        .game-screen.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* (新) 題庫編輯頁面樣式 */
        .qdb-container { max-height: 70vh; overflow-y: auto; padding: 0.5rem; }
        .qdb-card { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; padding: 1.5rem; }
        .qdb-card h3 { font-size: 1.25rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem; }
        .qdb-label { display: block; font-weight: 500; color: #475569; margin-bottom: 0.25rem; font-size: 0.875rem; }
        .qdb-input, .qdb-textarea, .qdb-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .qdb-input:focus, .qdb-textarea:focus, .qdb-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .qdb-textarea { min-height: 80px; }
        .qdb-options-grid { display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;}
        .qdb-options-grid .qdb-input { text-align: right; }


        /* 按鈕、進度條等其他樣式... */
        #question-text { color: #2563eb; }
        #question-desc { color: #15803d; }
        .option-btn { background-color: #ffffff; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1rem; font-size: 1rem; font-weight: 500; color: #333; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .option-btn:hover { background-color: #ef4444; border-color: #ef4444; color: #ffffff; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .option-btn.selected { background-color: #fbcfe8; color: #ef4444; border-color: #fbcfe8; font-weight: 700; transform: scale(1.05); }
        
        /* (★★★★★ 新增：客戶版專用 - 覆蓋選項按鈕的 Hover 效果) */
        body.client-version .option-btn:hover {
            background-color: #ffffff; /* 恢復預設背景 */
            border-color: #e0e0e0;   /* 恢復預設邊框 */
            color: #333;          /* 恢復預設文字顏色 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* 恢復預設陰影 */
            transform: none;      /* 移除 Y 軸位移 */
        }
        
        /* (★★★ Gemini 新增：客戶版專用 - 覆蓋 'selected' 樣式 ★★★) */
        body.client-version .option-btn.selected {
            background-color: #ffffff;  /* 恢復預設背景 (無粉色) */
            border-color: #e0e0e0;      /* 恢復預設邊框 */
            color: #ef4444;            /* 字體改為紅色 */
            font-size: 1.25rem;         /* 字體放大 25% (1rem -> 1.25rem) */
            font-weight: 700;           /* 保持粗體 */
            transform: none;            /* 移除縮放效果 */
        }

        .progress-bar-container { background-color: #e0e0e0; border-radius: 99px; height: 12px; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; border-radius: 99px; transition: width 0.5s ease-out; }
        #animation-container svg { width: 3rem; height: 3rem; margin: 0 auto; }
        .income-btn { background-color: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1rem; font-size: 1.125rem; font-weight: 500; color: #333; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .income-btn:hover { background-color: #ef4444; border-color: #ef4444; color: #ffffff; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); animation: fadeInModal 0.3s ease-out; }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); position: relative; animation: slideInModal 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .modal-close-btn { color: #aaa; position: absolute; top: 1rem; right: 1rem; font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: #333; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .primary-btn { background-color: #6366f1; color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .primary-btn:hover { background-color: #4f46e5; }
        .secondary-btn { background-color: #6b7280; color: white; font-weight: 500; padding: 0.75rem 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .secondary-btn:hover { background-color: #4b5563; }
        .success-btn { background-color: #10b981; color: white; font-weight: 700; }
        .success-btn:hover { background-color: #059669; }
        .danger-btn { background-color: #ef4444; color: white; font-weight: 500; }
        .danger-btn:hover { background-color: #dc2626; }
        .db-table-wrapper { max-height: 60vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; }
        .db-table { width: 100%; min-width: 700px; border-collapse: collapse; }
        .db-table th, .db-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; white-space: nowrap; }
        .db-table th { background-color: #f8f9fa; color: #4b5563; font-size: 0.875rem; text-transform: uppercase; position: sticky; top: 0; }
        .db-table .action-btn { padding: 4px 10px; border-radius: 6px; font-size: 0.875rem; margin-right: 6px; }
        /* 列印樣式 */
        @media print {
            body { background: #ffffff !important; padding: 0; margin: 0; }
            .game-container { box-shadow: none; border: none; width: 100%; max-width: 100%; border-radius: 0; }
            .game-screen:not(#result-screen) { display: none !important; }
            #result-screen { display: block !important; padding: 0 !important; }
            .max-h-60.overflow-y-auto { max-height: none !important; overflow: visible !important; }
            #result-screen .button-container, #open-explanation-btn { display: none !important; } /* Print button already removed in JS for client */
            .modal { display: none !important; }
            .bg-gradient-to-r.from-purple-50.to-blue-50 { background: #ffffff !important; box-shadow: none !important; border: none !important; text-align: right !important; padding: 0 !important; margin-bottom: 0.5rem !important; }
            #notes-section { display: block !important; page-break-before: auto; }
            
            #result-screen h2 { margin-bottom: 1rem !important; }
            div.mt-8 { margin-top: 1rem !important; }
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0px}.col-span-1{grid-column:span 1 / span 1}.col-span-2{grid-column:span 2 / span 2}.mb-1{margin-bottom:0.25rem}.mb-10{margin-bottom:2.5rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.grid{display:grid}.h-24{height:6rem}.h-32{height:8rem}.h-4{height:1rem}.h-40{height:10rem}.max-h-48{max-height:12rem}.max-h-60{max-height:15rem}.min-h-\[50px\]{min-height:50px}.min-h-\[80px\]{min-height:80px}.w-full{width:100%}.min-w-full{min-width:100%}.max-w-3xl{max-width:48rem}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.overflow-y-auto{overflow-y:auto}.whitespace-pre-wrap{white-space:pre-wrap}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-2{border-width:2px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-blue-700{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-purple-600{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-purple-600{--tw-gradient-from:#9333ea var(--tw-gradient-from-position);--tw-gradient-to:rgb(147 51 234 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-blue-600{--tw-gradient-to:#2563eb var(--tw-gradient-to-position)}.bg-clip-text{-webkit-background-clip:text;background-clip:text}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.text-left{text-align:left}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-amber-900{--tw-text-opacity:1;color:rgb(120 53 15 / var(--tw-text-opacity, 1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-transparent{color:transparent}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-800:hover{--tw-bg-opacity:1;background-color:rgb(30 64 175 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.hover\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.hover\:bg-purple-700:hover{--tw-bg-opacity:1;background-color:rgb(126 34 206 / var(--tw-bg-opacity, 1))}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.focus\:border-indigo-500:focus{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241 / var(--tw-ring-opacity, 1))}@media (min-width: 768px){.md\:col-span-2{grid-column:span 2 / span 2}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:p-10{padding:2.5rem}.md\:p-12{padding:3rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}</style></head>
<body class="client-version">

    

    <div id="game-container" class="game-container">

        <div id="start-screen" class="game-screen p-8 md:p-12 text-center active">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600 mb-6">
                115年月曆筆記本問卷
            </h1>
            <p class="text-lg text-gray-700 mb-10">
                請選擇您需要的項目，感謝您的支持！
            </p>
            <button id="start-btn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                我們開始吧
            </button>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                
                
                
                
                
                
            </div>
        </div>

        

        <div id="name-screen" class="game-screen p-8 md:p-12 text-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">請輸入你的稱呼</h2>
            <p class="text-lg text-gray-700 mb-10">這個稱呼將會顯示在最後的結果頁面上。</p>
            <div class="mb-6">
                <input type="text" id="name-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:border-blue-500" placeholder="例如：王大明">
                <p id="name-error" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
            <button id="name-next-btn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">下一步</button>
        </div>

        <div id="game-screen" class="game-screen p-6 md:p-10">
            <div class="mb-6">
                <p id="progress-text" class="text-sm font-medium text-gray-600 mb-2 text-center">關卡 1 / 10</p>
                <div class="progress-bar-container"><div id="progress-bar" class="progress-bar-fill" style="width: 0%;"></div></div>
            </div>
            <div id="animation-container" class="w-full h-24 mb-4 flex items-center justify-center"></div>
            <div class="mb-8 min-h-[80px]">
                <h2 id="question-text" class="text-2xl font-bold text-gray-900 mb-3 text-center"></h2>
                <p id="question-desc" class="text-base text-gray-600 text-center"></p>
            </div>
            <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <div id="notes-screen" class="game-screen p-8 md:p-12">
            <h2 class="text-3xl font-bold text-blue-600 mb-4 text-center">我的想法</h2>
            <p class="text-lg text-gray-700 mb-6 text-center">對於以上的規劃，您是否有其他想補充說明的地方？（可選填）</p>
            <textarea id="user-notes-area" class="w-full h-40 p-3 border-2 border-gray-300 rounded-lg text-base focus:outline-none focus:border-blue-500" placeholder="請在此輸入您的想法..."></textarea>
            <button id="notes-finish-btn" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">完成問卷，查看結果</button>
        </div>

        <div id="result-screen" class="game-screen p-6 md:p-10"> 
            
            <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">115年月曆筆記本禮券需求統計如下:</h2>
            
            <div class="flex justify-between items-center mb-4 mt-8">
                <h3 class="text-xl font-bold text-green-800">統計結果</h3>
                <p class="text-sm text-gray-600">填寫時間： <b id="result-date" class="text-gray-800">--</b></p>
            </div>
            
            <div class="max-h-60 overflow-y-auto rounded-lg border border-gray-200">
                <table id="result-table" class="w-full text-left">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="text-sm font-semibold text-amber-900">項目</th>
                            <th class="text-sm font-semibold text-amber-900">你的選擇</th>
                            <th class="text-sm font-semibold text-amber-900 text-center">数量</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body"></tbody>
                </table>
            </div>
            <div id="notes-section" class="mt-8">
                <h3 class="text-xl font-bold text-green-800 mb-3">客戶備註</h3>
                <p id="result-notes" class="text-base text-gray-700 bg-gray-50 border border-gray-200 rounded-lg p-4 min-h-[50px] whitespace-pre-wrap"></p>
            </div>
            <div class="button-container grid grid-cols-2 gap-4 mt-8">
                
                <button id="restart-btn" class="w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-xl text-base shadow-lg hover:bg-gray-800 transform hover:scale-105 transition-all duration-300">返回首頁</button>
                <button id="open-export-btn" class="col-span-2 w-full success-btn font-bold py-3 px-6 rounded-xl text-base shadow-lg hover:bg-green-600 transform hover:scale-105 transition-all duration-300">產生代碼(請貼到LINE給我，將製作PDF檔回傳給您)</button>
            </div>
        </div>
        
        

    </div>

    <div id="quantity-modal" class="modal">
        <div class="modal-content">
            <span id="close-quantity-btn" class="modal-close-btn">×</span>
            <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">請輸入數量</h3>
            <p class="text-gray-600 text-center mb-4">請輸入您需要的數量：</p>
            <input type="number" id="quantity-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:border-blue-500" placeholder="例如：1" min="1" value="1">
            <p id="quantity-error" class="text-red-500 text-sm mt-2 h-4 text-center"></p>
            <button id="quantity-submit-btn" class="w-full mt-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transition-all duration-300">確認</button>
        </div>
    </div>

    
    
    <div id="export-modal" class="modal"><div class="modal-content"><span id="close-export-btn" class="modal-close-btn">×</span><h3 class="text-2xl font-bold text-green-600 mb-4 text-center">產生分享代碼</h3><p class="text-gray-600 text-center mb-4">請複製以下代碼，並傳送給您的顧問：</p><textarea id="export-code-area" class="w-full h-32 p-3 border border-gray-300 rounded-lg bg-gray-50" readonly=""></textarea><p id="copy-success" class="text-green-600 text-sm mt-2 h-4 text-center"></p><button id="copy-code-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg hover:bg-green-600 transition-all duration-300">複製代碼</button></div></div>

    


    <script>
        // --- (★★★ 115年筆記本月曆-通用題庫 ★★★) ---
        let QUESTIONS_DATABASE = [
            {
                id: 'q1',
                disabled: false, // 預設啟用 (A類)
                question: "115年月曆筆記本有需要嗎? (A類 筆記本)", // 使用者指定的標題
                description: "請選擇您需要的「筆記本」(4選1)，或選擇不需要此項。",
                animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7"></path><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2"></path><path d="M7 7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2"></path></svg>`,
                type: 'static',
                options: [
                    { text: "A1. 大筆記本", score: 10 },
                    { text: "A2. 小筆記本", score: 10 },
                    { text: "我不需要 A類 筆記本", score: 0 },
                    { text: "我不需要 A類 筆記本", score: 0 }
                ],
                dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ]
            },
            {
                id: 'q2',
                disabled: false, // 預設啟用 (B類 - 1/2)
                question: "115年月曆需求 (B類 月曆 - 1/2)",
                description: "請選擇您需要的「月曆」(4選1)，或選擇不需要此項。",
                animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
                type: 'static',
                options: [
                    { text: "B1. 桌曆", score: 10 },
                    { text: "B2. 雙月掛曆", score: 10 },
                    { text: "B3. 兒童月曆", score: 10 },
                    { text: "我不需要 B類 月曆 (或請見下頁)", score: 0 }
                ],
                dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ]
            },
            {
                id: 'q3',
                disabled: false, // 預設啟用 (B類 - 2/2)
                question: "115年月曆需求 (B類 月曆 - 2/2)",
                description: "請選擇您需要的「月曆」(4選1)，或選擇不需要此項。",
                animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
                type: 'static',
                options: [
                    { text: "B4. 福字月曆", score: 10 },
                    { text: "B5. 農民曆", score: 10 },
                    { text: "我不需要 B類 月曆", score: 0 },
                    { text: "我不需要 B類 月曆", score: 0 }
                ],
                dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ]
            },
            {
                id: 'q4',
                disabled: true, // ★★★ 關鍵：C類 預設停用 ★★★
                question: "115年電子禮券需求 (C類 禮券)",
                description: "請選擇您需要的「電子禮券」(4選1)，或選擇不需要此項。",
                animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
                type: 'static',
                options: [
                    { text: "C1. 85度C 100元禮券", score: 10 },
                    { text: "C2. 100元7-11電子禮券", score: 10 },
                    { text: "我不需要 C類 禮券", score: 0 },
                    { text: "我不需要 C類 禮券", score: 0 }
                ],
                dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ]
            },
            // --- (以下為填充題庫，保持停用即可) ---
            { id: 'q5', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q6', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q7', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q8', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q9', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q10', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q11', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q12', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q13', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q14', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q15', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q16', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q17', disabled: true, question: "情境 (尚未啟用)", description: "請在此編輯問題描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q18', disabled: true, question: "情境 (尚未啟用)", description: "请在此编辑问题描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q19', disabled: true, question: "情境 (尚未啟用)", description: "请在此编辑问题描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
            { id: 'q20', disabled: true, question: "情境 (尚未啟用)", description: "请在此编辑问题描述", animationSvg: `<svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V4m0 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v0Z"/></svg>`, type: 'static', options: [ { text: "選項A", score: 10 }, { text: "選項B", score: 20 }, { text: "選項C", score: 30 }, { text: "選項D", score: 40 } ], dynamicOptions: [ [0,0], [0,0], [0,0], [0,0] ] },
        ];
        
        // --- 全域變數與常數 ---
        const CLIENT_DB_KEY = 'clientQuestionnaireDB_v2';
        const QUESTION_BANK_DB_KEY = 'questionBankDB_v2';
        
        let clientDatabase = [];
        let activeQuestions = [];
        let userAnswers = [], totalScore = 0, userAnnualIncome = 0, userMonthlyIncome = 0;
        let userName = "", completionDate = "", userNotes = "";
        let currentQuestionIndex = 0;
        
        let pendingAnswer = null;
        let fullClientBreakdown = []; // (★★★ 新增：儲存完整明細供列印)

        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM 元素 ---
            const allElements = {
                gameContainer: document.getElementById('game-container'),
                startScreen: document.getElementById('start-screen'),
                nameScreen: document.getElementById('name-screen'),
                gameScreen: document.getElementById('game-screen'),
                notesScreen: document.getElementById('notes-screen'),
                resultScreen: document.getElementById('result-screen'),
                databaseScreen: document.getElementById('database-screen'),
                questionDbScreen: document.getElementById('question-db-screen'), // 新
                startBtn: document.getElementById('start-btn'),
                nameInput: document.getElementById('name-input'),
                nameNextBtn: document.getElementById('name-next-btn'),
                nameError: document.getElementById('name-error'),
                notesTextArea: document.getElementById('user-notes-area'),
                notesFinishBtn: document.getElementById('notes-finish-btn'),
                restartBtn: document.getElementById('restart-btn'),
                printBtn: document.getElementById('print-btn'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                animationContainer: document.getElementById('animation-container'),
                questionText: document.getElementById('question-text'),
                questionDesc: document.getElementById('question-desc'),
                optionsGrid: document.getElementById('options-grid'),
                resultDateEl: document.getElementById('result-date'),
                resultTableBody: document.getElementById('result-table-body'),
                notesSection: document.getElementById('notes-section'),
                resultNotesEl: document.getElementById('result-notes'),
                // 匯入 Modal
                importModal: document.getElementById('import-modal'),
                openImportBtn: document.getElementById('open-import-btn'),
                closeImportBtn: document.getElementById('close-import-btn'),
                importCodeArea: document.getElementById('import-code-area'),
                importLoadBtn: document.getElementById('import-load-btn'),
                importError: document.getElementById('import-error'),
                // 匯出 Modal
                exportModal: document.getElementById('export-modal'),
                openExportBtn: document.getElementById('open-export-btn'),
                closeExportBtn: document.getElementById('close-export-btn'),
                exportCodeArea: document.getElementById('export-code-area'),
                copyCodeBtn: document.getElementById('copy-code-btn'),
                copySuccess: document.getElementById('copy-success'),
                // 數量 Modal 元素
                quantityModal: document.getElementById('quantity-modal'),
                closeQuantityBtn: document.getElementById('close-quantity-btn'),
                quantityInput: document.getElementById('quantity-input'),
                quantityError: document.getElementById('quantity-error'),
                quantitySubmitBtn: document.getElementById('quantity-submit-btn'),
                // Client DB elements
                openDbBtn: document.getElementById('open-db-btn'),
                dbBackBtn: document.getElementById('db-back-btn'),
                dbTableBody: document.getElementById('db-table-body'),
                exportCsvBtn: document.getElementById('export-csv-btn'),
                clearDbBtn: document.getElementById('clear-db-btn'),
                csvImportInput: document.getElementById('csv-import-input'),
                importCsvBtn: document.getElementById('import-csv-btn'),
                // Question DB elements (新)
                openQdbBtn: document.getElementById('open-qdb-btn'),
                qdbBackBtn: document.getElementById('qdb-back-btn'),
                qdbSaveBtn: document.getElementById('qdb-save-btn'),
                qdbResetBtn: document.getElementById('qdb-reset-btn'),
                qdbContainer: document.getElementById('qdb-questions-container'),
                
                saveClientHtmlBtn: document.getElementById('save-client-html-btn'),

                // (★★★ 統計總表 Modal 元素 - 已修改 ★★★)
                calculateSummaryBtn: document.getElementById('calculate-summary-btn'),
                summaryModal: document.getElementById('summary-modal'),
                closeSummaryBtn: document.getElementById('close-summary-btn'),
                summaryClientSelect: document.getElementById('summary-client-select'), // (★★★ 修改)
                summaryTotalsTableBody: document.getElementById('summary-totals-table-body'),
                summaryDetailTableBody: document.getElementById('summary-detail-table-body'),
                printTotalsBtn: document.getElementById('print-totals-btn'), // (★★★ 新增)
                printDetailsBtn: document.getElementById('print-details-btn'), // (★★★ 新增)
                summaryTotalsWrapper: document.getElementById('summary-totals-wrapper'), // (★★★ 新增)
                summaryDetailsWrapper: document.getElementById('summary-details-wrapper')  // (★★★ 新增)
            };

            const originalDocumentTitle = document.title; 

            // --- 題庫管理功能 (無變更) ---
            function loadQuestionDatabase() {
                const storedQuestions = localStorage.getItem(QUESTION_BANK_DB_KEY);
                if (storedQuestions) {
                    try {
                        QUESTIONS_DATABASE = JSON.parse(storedQuestions);
                    } catch (e) {
                        console.error("無法解析儲存的題庫，將使用預設題庫。", e);
                    }
                }
            }

            function saveQuestionDatabase() {
                const newDb = [];
                const questionCards = allElements.qdbContainer.querySelectorAll('.qdb-card');
                
                questionCards.forEach((card, index) => {
                    const qData = { id: `q${index + 1}` };
                    qData.disabled = !card.querySelector(`[data-q-index="${index}"][data-prop="disabled"]`).checked;
                    qData.question = card.querySelector(`[data-q-index="${index}"][data-prop="question"]`).value;
                    qData.description = card.querySelector(`[data-q-index="${index}"][data-prop="description"]`).value;
                    qData.animationSvg = card.querySelector(`[data-q-index="${index}"][data-prop="animationSvg"]`).value;
                    qData.type = card.querySelector(`[data-q-index="${index}"][data-prop="type"]`).value;
                    
                    qData.options = [];
                    for (let i = 0; i < 4; i++) {
                        qData.options.push({
                            text: card.querySelector(`[data-q-index="${index}"][data-opt-index="${i}"][data-prop="text"]`).value,
                            score: parseInt(card.querySelector(`[data-q-index="${index}"][data-opt-index="${i}"][data-prop="score"]`).value, 10) || 0,
                        });
                    }

                    qData.dynamicOptions = [];
                    for (let i = 0; i < 4; i++) {
                        qData.dynamicOptions.push([
                            parseInt(card.querySelector(`[data-q-index="${index}"][data-d-opt-index="${i}"][data-prop="months"]`).value, 10) || 0,
                            parseInt(card.querySelector(`[data-q-index="${index}"][data-d-opt-index="${i}"][data-prop="d-score"]`).value, 10) || 0,
                        ]);
                    }
                    newDb.push(qData);
                });

                QUESTIONS_DATABASE = newDb;
                localStorage.setItem(QUESTION_BANK_DB_KEY, JSON.stringify(QUESTIONS_DATABASE));
                alert("題庫已成功儲存！");
            }

            function populateQuestionEditor() {
                allElements.qdbContainer.innerHTML = '';
                QUESTIONS_DATABASE.forEach((q, index) => {
                    const card = document.createElement('div');
                    card.className = 'qdb-card';
                    let optionsHtml = '';
                    let dynamicOptionsHtml = '';

                    for (let i=0; i<4; i++) {
                        optionsHtml += `
                            <div class="qdb-options-grid">
                                <input type="text" class="qdb-input" value="${q.options[i]?.text || ''}" data-q-index="${index}" data-opt-index="${i}" data-prop="text" placeholder="選項 ${i+1} 文字">
                                <input type="number" class="qdb-input" value="${q.options[i]?.score || 0}" data-q-index="${index}" data-opt-index="${i}" data-prop="score">
                            </div>`;
                        dynamicOptionsHtml += `
                             <div class="qdb-options-grid">
                                <input type="number" class="qdb-input" value="${q.dynamicOptions[i]?.[0] || 0}" data-q-index="${index}" data-d-opt-index="${i}" data-prop="months" placeholder="月數">
                                <input type="number" class="qdb-input" value="${q.dynamicOptions[i]?.[1] || 0}" data-q-index="${index}" data-d-opt-index="${i}" data-prop="d-score" placeholder="分數">
                            </div>`;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3>情境 ${index + 1}</h3>
                            <div class="flex items-center">
                                <label for="q-enabled-${index}" class="qdb-label mr-2">啟用此問題</label>
                                <input type="checkbox" id="q-enabled-${index}" ${!q.disabled ? 'checked' : ''} data-q-index="${index}" data-prop="disabled">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="qdb-label">問題標題</label>
                                <input type="text" class="qdb-input" value="${q.question}" data-q-index="${index}" data-prop="question">
                            </div>
                            <div>
                                <label class="qdb-label">問題類型</label>
                                <select class="qdb-select" data-q-index="${index}" data-prop="type">
                                    <option value="static" ${q.type === 'static' ? 'selected' : ''}>靜態選項</option>
                                    <option value="dynamicIncome" ${q.type === 'dynamicIncome' ? 'selected' : ''}>動態收入選項</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="qdb-label">問題描述</label>
                                <textarea class="qdb-textarea" data-q-index="${index}" data-prop="description">${q.description}</textarea>
                            </div>
                             <div class="md:col-span-2">
                                <label class="qdb-label">SVG 圖示程式碼</label>
                                <textarea class="qdb-textarea" data-q-index="${index}" data-prop="animationSvg">${q.animationSvg}</textarea>
                            </div>
                            <div>
                                <label class="qdb-label">靜態選項 (文字 / 分數)</label>
                                ${optionsHtml}
                            </div>
                             <div>
                                <label class="qdb-label">動態選項 (月數 / 分數)</label>
                                ${dynamicOptionsHtml}
                            </div>
                        </div>
                    `;
                    allElements.qdbContainer.appendChild(card);
                });
            }
            
            function resetQuestionDatabase() {
                if (confirm("您確定要重置為系統預設的題庫嗎？所有已儲存的修改將會遺失。")) {
                    localStorage.removeItem(QUESTION_BANK_DB_KEY);
                    alert("題庫已重置。頁面將會重新整理。");
                    location.reload();
                }
            }


            // --- 遊戲邏輯 ---
            function showScreen(screenElement) {
                document.querySelectorAll('.game-screen').forEach(screen => screen.classList.remove('active'));
                screenElement.classList.add('active');
            }

            function goBackToStart() {
                if (!confirm("所有問卷資料將清除，要繼續嗎?")) {
                    return; 
                }
                
                userName = "";
                allElements.nameInput.value = "";
                completionDate = "";
                userNotes = "";
                allElements.notesTextArea.value = "";
                allElements.gameContainer.classList.remove('db-mode');
                showScreen(allElements.startScreen);
                allElements.progressBar.style.width = `0%`;
            }
            
            function showQuestion(index) {
                const question = activeQuestions[index];
                allElements.progressText.textContent = `關卡 ${index + 1} / ${activeQuestions.length}`;
                allElements.progressBar.style.width = `${((index + 1) / activeQuestions.length) * 100}%`;
                allElements.animationContainer.innerHTML = question.animationSvg;
                allElements.questionText.textContent = question.question;
                allElements.questionDesc.textContent = question.description;
                allElements.optionsGrid.innerHTML = '';
                
                const optionsToShow = (question.type === 'dynamicIncome' ? question.dynamicOptions : question.options);
                optionsToShow.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    let text, score;
                    if(question.type === 'dynamicIncome') {
                        const [months, s] = option;
                        const amountInMonths = months; 
                        text = `${amountInMonths} 個月生活費`; 
                        score = s;
                    } else {
                        text = option.text;
                        score = option.score;
                    }
                    button.textContent = text;
                    button.onclick = (e) => selectAnswer(score, text, e.currentTarget);
                    allElements.optionsGrid.appendChild(button);
                });
            }

            function selectAnswer(score, text, selectedButton) {
                // 先禁用所有按鈕並標記選中
                allElements.optionsGrid.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                selectedButton.classList.add('selected');
                
                totalScore += score; // 總分仍在後台計算，以便儲存

                // 判斷是否為「不需要」的選項
                if (text.includes("不需要")) {
                    // 如果是不需要，直接儲存答案(數量為0)，並進入下一題
                    userAnswers.push({ 
                        question: activeQuestions[currentQuestionIndex].question, 
                        text, 
                        score, 
                        quantity: 0 // 數量設為 0
                    });
                    
                    setTimeout(() => {
                        currentQuestionIndex++;
                        if (currentQuestionIndex < activeQuestions.length) {
                            showQuestion(currentQuestionIndex);
                        } else {
                            showScreen(allElements.notesScreen);
                        }
                    }, 700); // 保留延遲以提供視覺反饋
                } else {
                    // 如果是選擇商品，暫存答案並彈出數量輸入框
                    pendingAnswer = { 
                        question: activeQuestions[currentQuestionIndex].question, 
                        text, 
                        score 
                    };
                    
                    allElements.quantityInput.value = '1'; // 預設數量為 1
                    allElements.quantityError.textContent = '';
                    allElements.quantityModal.style.display = 'block';
                    allElements.quantityInput.focus();
                    allElements.quantityInput.select();
                }
            }
            
            function submitQuantity() {
                const quantityStr = allElements.quantityInput.value;
                const quantity = parseInt(quantityStr, 10);

                // 驗證輸入 (必須是數字, > 0, 且沒有小數點)
                if (isNaN(quantity) || quantity < 1 || quantity.toString() !== quantityStr.trim()) {
                    allElements.quantityError.textContent = "請輸入一個大於 0 的有效整數。";
                    return;
                }
                
                // 儲存答案
                if (pendingAnswer) {
                    pendingAnswer.quantity = quantity; // 加入數量
                    userAnswers.push(pendingAnswer); // 存入最終答案列表
                    pendingAnswer = null; // 清空暫存
                }

                allElements.quantityModal.style.display = 'none';
                allElements.quantityError.textContent = '';

                // 推進到下一題 (無延遲)
                currentQuestionIndex++;
                if (currentQuestionIndex < activeQuestions.length) {
                    showQuestion(currentQuestionIndex);
                } else {
                    showScreen(allElements.notesScreen);
                }
            }
            
            // (★★★ 這裡是您要求的修改 ★★★)
            function showResults() {
                allElements.gameContainer.classList.remove('db-mode');
                showScreen(allElements.resultScreen);
                
                // 1. 檢查 userName 是否為空，以決定標題 (修復客戶版BUG)
                let titleText = "115年月曆筆記本禮券需求統計如下:";
                // 確保 userName 不是 null 且去除空白後不是空字串
                if (userName && userName.trim() !== "") {
                    titleText = `${userName.trim()}的 ${titleText}`;
                }
                // 標題的 class (text-2xl) 已在 HTML 中設定
                allElements.resultScreen.querySelector('h2').textContent = titleText; 

                // 2. 檢查 completionDate 是否已存在 (例如從匯入代碼載入)
                // (修復客戶版BUG：確保在 completionDate 為空時才產生新日期)
                if (!completionDate || completionDate.trim() === "") {
                    const today = new Date();
                    completionDate = `民國 ${today.getFullYear() - 1911} 年 ${today.getMonth() + 1} 月 ${today.getDate()} 日`;
                }
                // 3. 設定日期 (HTML 版面已修改)
                allElements.resultDateEl.textContent = completionDate;
                
                // 4. 產生結果表格
                allElements.resultTableBody.innerHTML = userAnswers.map(ans => 
                    `<tr>
                        <td class="p-3 text-sm text-gray-700">${ans.question}</td>
                        <td class="p-3 text-sm text-gray-600">${ans.text}</td>
                        <td class="p-3 text-sm text-gray-800 font-medium text-center">${ans.quantity || 0}</td>
                    </tr>`
                ).join('');
                
                allElements.resultNotesEl.textContent = userNotes && userNotes.length > 0 ? userNotes : '無';
                allElements.notesSection.style.display = 'block';
            }
            
            // --- 客戶資料庫與匯出入功能 ---
            function loadClientDatabase() {
                const dbJson = localStorage.getItem(CLIENT_DB_KEY);
                clientDatabase = dbJson ? JSON.parse(dbJson) : [];
            }
            function saveClientDatabase() {
                localStorage.setItem(CLIENT_DB_KEY, JSON.stringify(clientDatabase));
            }

            // (★★★ 新增：列印輔助函式 ★★★)
            function printElementHTML(elementHTML, title) {
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>' + title + '</title>');
                // 載入 Tailwind CSS
                printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
                // 基本列印樣式
                printWindow.document.write('<style> body { padding: 2rem; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f2f2f2; } h3 { text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 700; } </style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h3>' + title + '</h3>');
                printWindow.document.write(elementHTML); // 寫入表格 HTML
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                
                // 延遲執行列印，確保 Tailwind 樣式載入
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            }

            // (★★★ 新增：列印總計表 ★★★)
            function printItemTotals() {
                const htmlToPrint = allElements.summaryTotalsWrapper.innerHTML;
                printElementHTML(htmlToPrint, '項目總計表');
            }
            
            // (★★★ 新增：列印明細表 ★★★)
            function printClientDetails() {
                // 從全域變數重建 *完整* 的表格 HTML，忽略目前的篩選
                let tableHTML = '<table class="db-table min-w-full"><thead><tr><th>客戶姓名</th><th>項目名稱</th><th class="text-center">數量</th></tr></thead><tbody>';
                
                if (fullClientBreakdown.length === 0) {
                    tableHTML += '<tr><td colspan="3" class="text-center">沒有客戶選擇任何項目。</td></tr>';
                } else {
                    fullClientBreakdown.forEach(entry => {
                        tableHTML += `
                            <tr class="bg-white">
                                <td class="p-3 text-sm font-medium text-gray-900">${entry.name}</td>
                                <td class="p-3 text-sm text-gray-700">${entry.item}</td>
                                <td class="p-3 text-sm text-gray-700 text-center">${entry.qty}</td>
                            </tr>`;
                    });
                }
                tableHTML += '</tbody></table>';
                printElementHTML(tableHTML, '客戶明細表');
            }


            // (★★★ 修改：過濾總表中的客戶明細 ★★★)
            function filterSummaryDetail() {
                const selectedClient = allElements.summaryClientSelect.value.toLowerCase();
                const rows = allElements.summaryDetailTableBody.querySelectorAll('tr.data-row'); // 只選 data-row
                const noDataRow = allElements.summaryDetailTableBody.querySelector('tr.no-data-row');
                
                let visibleCount = 0;
                rows.forEach(row => {
                    const clientName = row.cells[0].textContent.toLowerCase();
                    if (selectedClient === '' || clientName === selectedClient) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                if (visibleCount === 0) {
                    if (selectedClient === '') {
                        // 如果搜尋為空，表示原始資料為空
                        noDataRow.cells[0].textContent = "沒有客戶選擇任何項目。";
                    } else {
                        // 搜尋了，但沒結果
                        noDataRow.cells[0].textContent = "查無此客戶的訂購資料。";
                    }
                    noDataRow.style.display = '';
                } else {
                    noDataRow.style.display = 'none';
                }
            }

            // (★★★ 計算並顯示總表 - 已修改 ★★★)
            function calculateAndShowSummary() {
                if (clientDatabase.length === 0) {
                    alert("資料庫中沒有資料可供統計。");
                    return;
                }

                const itemTotals = {};
                fullClientBreakdown = []; // (★★★ 修改：重置全域變數)

                clientDatabase.forEach(client => {
                    client.userAnswers.forEach(answer => {
                        // 只統計有數量且不是"不需要"的選項
                        if (answer.quantity > 0 && !answer.text.includes("不需要")) {
                            const itemName = answer.text;
                            const quantity = answer.quantity;
                            
                            // 1. 累加總計
                            itemTotals[itemName] = (itemTotals[itemName] || 0) + quantity;
                            
                            // 2. 加入客戶明細 (★★★ 修改：儲存到全域變數)
                            fullClientBreakdown.push({ 
                                name: client.userName, 
                                item: itemName, 
                                qty: quantity 
                            });
                        }
                    });
                });

                // 排序資料
                const sortedItemTotals = Object.entries(itemTotals).sort((a, b) => a[0].localeCompare(b[0]));
                fullClientBreakdown.sort((a, b) => a.name.localeCompare(b.name) || a.item.localeCompare(b.item));

                // 填充總計表
                allElements.summaryTotalsTableBody.innerHTML = sortedItemTotals.map(([item, qty]) => `
                    <tr class="bg-white">
                        <td class="p-3 text-sm font-medium text-gray-900">${item}</td>
                        <td class="p-3 text-sm text-gray-700 font-bold text-center">${qty}</td>
                    </tr>
                `).join('');

                // 填充明細表 (★★★ 修改：使用全域變數)
                allElements.summaryDetailTableBody.innerHTML = fullClientBreakdown.map(entry => `
                    <tr class="bg-white data-row"> <td class="p-3 text-sm font-medium text-gray-900">${entry.name}</td>
                        <td class="p-3 text-sm text-gray-700">${entry.item}</td>
                        <td class="p-3 text-sm text-gray-700 text-center">${entry.qty}</td>
                    </tr>
                `).join('');
                
                // 新增 "查無資料" 提示行 (一開始隱藏)
                allElements.summaryDetailTableBody.insertAdjacentHTML(
                    'beforeend', 
                    '<tr class="no-data-row" style="display: none;"><td colspan="3" class="text-center text-gray-500 py-4"></td></tr>'
                );
                
                // 處理沒有資料的狀況
                if (sortedItemTotals.length === 0) {
                    allElements.summaryTotalsTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-4">沒有需要統計的項目。</td></tr>';
                }

                if (fullClientBreakdown.length === 0) {
                    const noDataRow = allElements.summaryDetailTableBody.querySelector('.no-data-row');
                    noDataRow.cells[0].textContent = "沒有客戶選擇任何項目。";
                    noDataRow.style.display = '';
                }

                // (★★★ 新增：填入客戶選單 ★★★)
                const clientNames = [...new Set(fullClientBreakdown.map(c => c.name))].sort();
                allElements.summaryClientSelect.innerHTML = ''; // 清空
                allElements.summaryClientSelect.add(new Option('--- 顯示所有客戶 ---', '')); // 加入"全部"
                clientNames.forEach(name => {
                    allElements.summaryClientSelect.add(new Option(name, name));
                });

                // 顯示 Modal
                allElements.summaryClientSelect.value = ''; // 重置選單
                allElements.summaryModal.style.display = 'block';
            }

            function handleCsvImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let csvText = e.target.result;
                        if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.substring(1);
                        parseCSVToDatabase(csvText);
                    } catch (err) { alert("讀取檔案時發生錯誤: " + err.message); }
                };
                reader.readAsText(file, 'UTF-8');
            }
            
            function parseCSVToDatabase(csvText) {
                const lines = csvText.split(/\r\n|\n/).slice(1);
                let importedCount = 0, skippedCount = 0;
                lines.forEach((line, i) => {
                    if (line.trim() === "") return;
                    const fields = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(f => f.startsWith('"') && f.endsWith('"') ? f.substring(1, f.length-1).replace(/""/g, '"') : f);
                    
                    if (fields.length < 3 || fields[0] === "") return; 
                    
                    const [clientName, completionDate] = fields;
                    if (clientDatabase.some(c => c.userName === clientName && c.completionDate === completionDate)) {
                        skippedCount++; return;
                    }
                    const newClient = {
                        id: Date.now().toString() + i, 
                        userName: clientName, 
                        completionDate: completionDate,
                        userAnnualIncome: 0, 
                        totalScore: 0, 
                        analysisType: "", 
                        userNotes: fields[2] || "", 
                        userAnswers: []
                    };
                    
                    // 從第3個欄位開始，每3個一組 (Q, A, Qty)
                    for (let j = 0; j < 20; j++) {
                        const [q, a, qty] = [fields[3 + j*3], fields[4 + j*3], fields[5 + j*3]];
                        if (!q || q === "") break;
                        newClient.userAnswers.push({ 
                            question: q, 
                            text: a || "", 
                            score: 0, // 分數設為0
                            quantity: parseInt(qty, 10) || 0 // 讀取数量
                        }); 
                    }
                    
                    if (newClient.userAnswers.length > 0) { 
                        clientDatabase.push(newClient); 
                        importedCount++; 
                    }
                });
                saveClientDatabase();
                populateClientDatabaseTable();
                alert(`CSV 匯入完成。\n成功匯入 ${importedCount} 筆新資料。\n${skippedCount} 筆重複資料已略過。`);
            }
            
            function populateClientDatabaseTable() {
                allElements.dbTableBody.innerHTML = '';
                if (clientDatabase.length === 0) {
                    allElements.dbTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">目前沒有任何客戶資料。</td></tr>'; return;
                }
                [...clientDatabase].reverse().forEach(client => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="font-medium">${client.userName}</td>
                        <td>${client.completionDate}</td>
                        <td>${(client.userNotes && client.userNotes.length > 0) ? '有' : '無'}</td>
                        <td>
                            <button class="action-btn primary-btn view-report-btn" data-id="${client.id}">查看</button>
                            <button class="action-btn danger-btn delete-entry-btn" data-id="${client.id}">刪除</button>
                        </td>`;
                    allElements.dbTableBody.appendChild(tr);
                });
                
                allElements.dbTableBody.querySelectorAll('.view-report-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const clientData = clientDatabase.find(c => c.id === e.target.dataset.id);
                    if(clientData) { 
                        userName = clientData.userName; 
                        userAnnualIncome = clientData.userAnnualIncome || 0; 
                        userAnswers = clientData.userAnswers; 
                        completionDate = clientData.completionDate; 
                        totalScore = clientData.totalScore || 0; 
                        userNotes = clientData.userNotes || ""; 
                        userMonthlyIncome = Math.round(userAnnualIncome / 12); 
                        showResults(); 
                    }
                }));
                allElements.dbTableBody.querySelectorAll('.delete-entry-btn').forEach(btn => btn.addEventListener('click', (e) => {
                     if (confirm("您確定要刪除這筆客戶資料嗎？")) { clientDatabase = clientDatabase.filter(c => c.id !== e.target.dataset.id); saveClientDatabase(); populateClientDatabaseTable(); }
                }));
            }
            
            function generateExportCode() {
                try {
                    return btoa(encodeURIComponent(JSON.stringify({ userName, userAnnualIncome, userAnswers, completionDate, userNotes })));
                } catch (e) { return "產生代碼時發生錯誤。"; }
            }

            function handleImportCode() {
                const code = allElements.importCodeArea.value.trim();
                if (code === "") {
                    allElements.importError.textContent = "請貼上代碼。";
                    return;
                }
                try {
                    allElements.importError.textContent = ""; 
                    const decodedJson = decodeURIComponent(atob(code));
                    const data = JSON.parse(decodedJson);
                    
                    if (!data.userName || !data.userAnswers || !data.completionDate) {
                        throw new Error("代碼格式不正確。");
                    }

                    userName = data.userName;
                    userAnnualIncome = data.userAnnualIncome || 0; 
                    userAnswers = data.userAnswers;
                    completionDate = data.completionDate; // (★★★ 變更：日期會從代碼載入 ★★★)
                    userNotes = data.userNotes || "";
                    userMonthlyIncome = Math.round(userAnnualIncome / 12);
                    totalScore = userAnswers.reduce((acc, ans) => acc + (ans.score || 0), 0);
                    
                    activeQuestions = data.userAnswers.map((ans, i) => ({
                        id: `q${i+1}`, 
                        question: ans.question,
                    }));

                    showResults(); 
                    allElements.importModal.style.display = 'none';
                    
                    if (confirm("匯入成功！您是否要將這筆資料儲存到本機的客戶資料庫中？")) {
                        const analysis = ""; 
                        const newClientEntry = {
                            id: Date.now().toString(),
                            userName: userName,
                            completionDate: completionDate,
                            userAnnualIncome: userAnnualIncome,
                            totalScore: totalScore,
                            analysisType: analysis,
                            userNotes: userNotes,
                            userAnswers: userAnswers
                        };
                        if (!clientDatabase.some(c => c.userName === userName && c.completionDate === completionDate)) {
                            clientDatabase.push(newClientEntry);
                            saveClientDatabase();
                            alert("已儲存至資料庫。");
                        } else {
                            alert("這筆資料已存在資料庫中，無需重複儲存。");
                        }
                    }
                } catch (e) {
                    console.error("Import error:", e);
                    allElements.importError.textContent = "代碼無效或已損毀。";
                }
            }
            
            function exportDatabaseToCSV() {
                if (clientDatabase.length === 0) {
                    alert("資料庫中沒有資料可匯出。");
                    return;
                }

                const escapeCSV = (str) => {
                    if (str === null || str === undefined) str = "";
                    str = String(str);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                let headers = ["客戶姓名", "填寫日期", "客戶備註"];
                const maxQuestions = 20; 
                for (let i = 1; i <= maxQuestions; i++) {
                    headers.push(`Q${i}-問題`, `Q${i}-答案`, `Q${i}-數量`);
                }
                
                let csvContent = headers.join(',') + '\r\n';

                clientDatabase.forEach(client => {
                    let row = [
                        escapeCSV(client.userName),
                        escapeCSV(client.completionDate),
                        escapeCSV(client.userNotes || "")
                    ];
                    
                    for (let i = 0; i < maxQuestions; i++) {
                        if (client.userAnswers[i]) {
                            row.push(escapeCSV(client.userAnswers[i].question));
                            row.push(escapeCSV(client.userAnswers[i].text));
                            row.push(client.userAnswers[i].quantity || 0);
                        } else {
                            row.push("", "", "");
                        }
                    }
                    csvContent += row.join(',') + '\r\n';
                });

                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); 
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                const today = new Date();
                const dateStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `客戶資料庫_${dateStr}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function saveClientVersion() {
                const clonedDoc = document.cloneNode(true);
                
                const idsToRemove = [
                    'open-import-btn',    
                    'open-db-btn',        
                    'open-qdb-btn',       
                    'save-client-html-btn', 
                    'question-db-screen', 
                    'database-screen',    
                    'import-modal',       
                    'csv-import-input',   
                    'print-btn',
                    'calculate-summary-btn', 
                    'summary-modal'          
                ];

                idsToRemove.forEach(id => {
                    const el = clonedDoc.getElementById(id);
                    el?.remove();
                });

                clonedDoc.body.classList.add('client-version');

                let clientHtml = clonedDoc.documentElement.outerHTML;
                const blob = new Blob([clientHtml], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", "115年月曆筆記本禮券問卷.html");
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }


            // --- 初始設定與事件綁定 ---
            loadQuestionDatabase();
            loadClientDatabase();

            // 畫面切換 (增加存在性檢查)
            if (allElements.startBtn) allElements.startBtn.addEventListener('click', () => showScreen(allElements.nameScreen));
            
            if (allElements.nameNextBtn) allElements.nameNextBtn.addEventListener('click', () => {
                const name = allElements.nameInput.value.trim();
                if (name === "") { 
                    allElements.nameError.textContent = "請輸入一個稱呼！"; 
                } 
                else { 
                    userName = name; 
                    allElements.nameError.textContent = ""; 
                    
                    userAnnualIncome = 0; 
                    userMonthlyIncome = 0;
                    activeQuestions = QUESTIONS_DATABASE.filter(q => !q.disabled);
                    currentQuestionIndex = 0; 
                    userAnswers = []; 
                    totalScore = 0; 
                    completionDate = ""; // 重置日期
                    userNotes = "";
                    pendingAnswer = null;
                    
                    if (activeQuestions.length === 0) {
                        alert("錯誤：沒有可用的問題。請在題庫編輯中至少啟用一個問題。");
                        return;
                    }
                    showScreen(allElements.gameScreen);
                    showQuestion(currentQuestionIndex);
                }
            });

            if (allElements.notesFinishBtn) allElements.notesFinishBtn.addEventListener('click', () => { userNotes = allElements.notesTextArea.value.trim(); showResults(); });
            if (allElements.restartBtn) allElements.restartBtn.addEventListener('click', goBackToStart);
            if (allElements.dbBackBtn) allElements.dbBackBtn.addEventListener('click', goBackToStart);
            if (allElements.qdbBackBtn) allElements.qdbBackBtn.addEventListener('click', goBackToStart); 
            if (allElements.openDbBtn) allElements.openDbBtn.addEventListener('click', () => { allElements.gameContainer.classList.add('db-mode'); populateClientDatabaseTable(); showScreen(allElements.databaseScreen); });
            if (allElements.openQdbBtn) allElements.openQdbBtn.addEventListener('click', () => { allElements.gameContainer.classList.add('db-mode'); populateQuestionEditor(); showScreen(allElements.questionDbScreen); }); 
            
            // 功能按鈕 (增加存在性檢查)
            if (allElements.printBtn) allElements.printBtn.addEventListener('click', () => {
                const today = new Date();
                const rocYear = today.getFullYear() - 1911;
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                const newFilename = `${rocYear}${month}${day}-月曆筆記本問卷-${userName || '客戶'}`;
                document.title = newFilename;
                window.print();
            });
            if (allElements.qdbSaveBtn) allElements.qdbSaveBtn.addEventListener('click', saveQuestionDatabase); 
            if (allElements.qdbResetBtn) allElements.qdbResetBtn.addEventListener('click', resetQuestionDatabase); 
            if (allElements.clearDbBtn) allElements.clearDbBtn.addEventListener('click', () => { if(confirm("確定要清空所有客戶資料嗎？")){ clientDatabase = []; saveClientDatabase(); populateClientDatabaseTable(); } });
            if (allElements.importCsvBtn) allElements.importCsvBtn.addEventListener('click', () => allElements.csvImportInput.click());
            if (allElements.csvImportInput) allElements.csvImportInput.addEventListener('change', handleCsvImport);
            if (allElements.exportCsvBtn) allElements.exportCsvBtn.addEventListener('click', exportDatabaseToCSV);
            if (allElements.openImportBtn) allElements.openImportBtn.addEventListener('click', () => { allElements.importCodeArea.value = ''; allElements.importError.textContent = ''; allElements.importModal.style.display = 'block'; });
            if (allElements.importLoadBtn) allElements.importLoadBtn.addEventListener('click', handleImportCode);
            if (allElements.openExportBtn) allElements.openExportBtn.addEventListener('click', () => { allElements.exportCodeArea.value = generateExportCode(); allElements.copySuccess.textContent = ''; allElements.exportModal.style.display = 'block'; });
            if (allElements.copyCodeBtn) allElements.copyCodeBtn.addEventListener('click', () => { allElements.exportCodeArea.select(); try { document.execCommand('copy'); allElements.copySuccess.textContent = "已成功複製！"; } catch (err) { allElements.copySuccess.textContent = "複製失敗。"; } });
            
            if (allElements.saveClientHtmlBtn) allElements.saveClientHtmlBtn.addEventListener('click', saveClientVersion);

            if (allElements.quantitySubmitBtn) allElements.quantitySubmitBtn.addEventListener('click', submitQuantity);
            
            if (allElements.quantityInput) allElements.quantityInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitQuantity();
                }
            });

            // (★★★ 總表按鈕事件 ★★★)
            if (allElements.calculateSummaryBtn) allElements.calculateSummaryBtn.addEventListener('click', calculateAndShowSummary);

            // (★★★ 修改：綁定總表選單事件 ★★★)
            if (allElements.summaryClientSelect) {
                allElements.summaryClientSelect.addEventListener('change', filterSummaryDetail);
            }

            // (★★★ 新增：綁定總表列印事件 ★★★)
            if (allElements.printTotalsBtn) allElements.printTotalsBtn.addEventListener('click', printItemTotals);
            if (allElements.printDetailsBtn) allElements.printDetailsBtn.addEventListener('click', printClientDetails);


            const cancelQuantitySelection = () => {
                allElements.quantityModal.style.display = 'none';
                allElements.quantityError.textContent = '';
                
                allElements.optionsGrid.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('selected');
                });
                
                if (pendingAnswer) {
                    totalScore -= pendingAnswer.score; 
                    pendingAnswer = null;
                }
            };
            
            if (allElements.closeQuantityBtn) allElements.closeQuantityBtn.addEventListener('click', cancelQuantitySelection);


            // 彈窗關閉 (增加存在性檢查)
            if (allElements.closeImportBtn) allElements.closeImportBtn.addEventListener('click', () => allElements.importModal.style.display = 'none');
            if (allElements.closeExportBtn) allElements.closeExportBtn.addEventListener('click', () => allElements.exportModal.style.display = 'none');
            
            // (★★★ 總表 Modal 關閉事件 ★★★)
            if (allElements.closeSummaryBtn) allElements.closeSummaryBtn.addEventListener('click', () => allElements.summaryModal.style.display = 'none');

            window.addEventListener('click', (e) => { 
                if(allElements.importModal && e.target == allElements.importModal) allElements.importModal.style.display = 'none'; 
                if(allElements.exportModal && e.target == allElements.exportModal) allElements.exportModal.style.display = 'none'; 
                if(allElements.quantityModal && e.target == allElements.quantityModal) cancelQuantitySelection();
                if(allElements.summaryModal && e.target == allElements.summaryModal) allElements.summaryModal.style.display = 'none'; 
            });

            window.addEventListener('afterprint', () => {
                document.title = originalDocumentTitle;
            });
        });
    </script>


</body></html>